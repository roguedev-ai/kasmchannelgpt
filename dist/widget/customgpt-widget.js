!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("CustomGPTWidget",[],t):"object"==typeof exports?exports.CustomGPTWidget=t():e.CustomGPTWidget=t()}("undefined"!=typeof self?self:this,()=>(()=>{var e,t,s,a,n,r={7648:(e,t,s)=>{"use strict";s.d(t,{w:()=>c});var a=s(71446),n=s(35189),r=s(90040),i=s(17047),o=s(25772);const c=(0,a.vt)()((0,n.Zr)((e,t)=>({conversations:[],currentConversation:null,loading:!1,error:null,currentPage:1,totalPages:1,totalConversations:0,perPage:20,sortOrder:"desc",sortBy:"id",userFilter:"all",allConversations:[],searchQuery:"",searchMode:"name",dateFilter:"all",applyFilters:()=>{const s=t();let a=[...s.allConversations];if(s.searchQuery.trim()){const e=s.searchQuery.toLowerCase().trim();a=a.filter(t=>{switch(s.searchMode){case"name":default:return t.name.toLowerCase().includes(e);case"id":return t.id.toString().includes(e);case"session":return t.session_id.toLowerCase().includes(e)}})}if("all"!==s.dateFilter){const e=new Date,t=new Date;switch(s.dateFilter){case"today":t.setHours(0,0,0,0);break;case"week":t.setDate(e.getDate()-7);break;case"month":t.setDate(e.getDate()-30)}a=a.filter(e=>new Date(e.updated_at)>=t)}e({conversations:a})},setSearchQuery:s=>{e({searchQuery:s}),t().applyFilters()},setSearchMode:s=>{e({searchMode:s}),t().applyFilters()},setDateFilter:s=>{e({dateFilter:s}),t().applyFilters()},fetchConversations:async(s,a)=>{o.v.info("CONVERSATIONS","Fetching conversations",{projectId:s,params:a}),e({loading:!0,error:null}),void 0!==a?.searchQuery&&e({searchQuery:a.searchQuery}),void 0!==a?.searchMode&&e({searchMode:a.searchMode}),void 0!==a?.dateFilter&&e({dateFilter:a.dateFilter});try{const n=(0,r.getClient)(),i={page:a?.page??t().currentPage,per_page:a?.per_page??t().perPage,order:a?.order??t().sortOrder,orderBy:a?.orderBy??t().sortBy,userFilter:a?.userFilter??t().userFilter},c=await n.getConversations(s,i);o.v.info("CONVERSATIONS","API response received",{projectId:s,responseType:typeof c,hasData:!!c?.data,dataLength:Array.isArray(c?.data)?c.data.length:0});let l=[],d=null;c&&"object"==typeof c&&(c.data&&c.data.data?(l=c.data.data,d=c.data):Array.isArray(c.data)?l=c.data:Array.isArray(c)&&(l=c)),o.v.info("CONVERSATIONS","Processed conversations",{count:l.length,paginationData:d,conversations:l.map(e=>({id:e.id,name:e.name,messagesCount:e.messages?.length||0}))}),e({allConversations:l,loading:!1,currentPage:d?.current_page??1,totalPages:d?.last_page??1,totalConversations:d?.total??l.length,...a?.order&&{sortOrder:a.order},...a?.orderBy&&{sortBy:a.orderBy},...a?.userFilter&&{userFilter:a.userFilter}}),t().applyFilters()}catch(t){o.v.error("CONVERSATIONS","Failed to fetch conversations",t,{projectId:s,errorType:t instanceof Error?t.constructor.name:typeof t,status:t?.status,message:t?.message}),e({error:t instanceof Error?t.message:"Failed to fetch conversations",loading:!1})}},createConversation:async(s,a)=>{e({loading:!0,error:null});try{const n=(0,r.getClient)(),i=(await n.createConversation(s,a?{name:a}:void 0)).data;e(e=>({allConversations:[i,...e.allConversations],currentConversation:i,loading:!1})),t().applyFilters()}catch(t){throw e({error:t instanceof Error?t.message:"Failed to create conversation",loading:!1}),t}},selectConversation:t=>{e({currentConversation:t})},deleteConversation:async s=>{const{conversations:a,currentConversation:n}=t(),i=a.find(e=>e.id.toString()===s.toString());if(i){e({loading:!0,error:null});try{const a=(0,r.getClient)();await a.deleteConversation(i.project_id,i.session_id);const o=t().allConversations.filter(e=>e.id.toString()!==s.toString());e({allConversations:o,currentConversation:n?.id.toString()===s.toString()?o.length>0?o[0]:null:n,loading:!1}),t().applyFilters()}catch(t){throw e({error:t instanceof Error?t.message:"Failed to delete conversation",loading:!1}),t}}},updateConversation:async(s,a,n)=>{e({loading:!0,error:null});try{const i=(0,r.getClient)(),o=(await i.updateConversation(s,a,n)).data;e(e=>({allConversations:e.allConversations.map(e=>e.id===s?o:e),currentConversation:e.currentConversation?.id===s?o:e.currentConversation,loading:!1})),t().applyFilters()}catch(t){throw e({error:t instanceof Error?t.message:"Failed to update conversation",loading:!1}),t}},ensureConversation:async(e,s)=>{const{currentConversation:a}=t();if(a&&a.project_id===e)return a;const n=s?(0,i.OX)(s):`Chat ${(new Date).toLocaleDateString()}`;return await t().createConversation(e,n),t().currentConversation}}),{name:`customgpt-conversations-${(()=>{if("undefined"==typeof window)return"server-session";if(window.__customgpt_current_session)return window.__customgpt_current_session;if(window.__customgpt_session)return window.__customgpt_session.sessionId;if(window.__customgpt_sessions){const e=window.__customgpt_sessions,t=Object.keys(e);if(t.length>0)return t[t.length-1]}try{let e=sessionStorage.getItem("customgpt_session_id");return e||(e=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,sessionStorage.setItem("customgpt_session_id",e)),e}catch(e){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}})()}`,partialize:e=>({conversations:e.conversations,allConversations:e.allConversations,searchQuery:e.searchQuery,searchMode:e.searchMode,dateFilter:e.dateFilter}),onRehydrateStorage:()=>e=>{e&&(Array.isArray(e.conversations)||(e.conversations=[]),Array.isArray(e.allConversations)||(e.allConversations=[]),e.searchQuery||(e.searchQuery=""),e.searchMode||(e.searchMode="name"),e.dateFilter||(e.dateFilter="all"),e.currentConversation=null)}}))},17047:(e,t,s)=>{"use strict";s.d(t,{$C:()=>i,B6:()=>l,Ey:()=>d,I3:()=>c,OX:()=>m,RW:()=>g,aH:()=>h,cn:()=>r,lW:()=>u,v7:()=>o});var a=s(13526),n=s(14799);s(28404);function r(...e){return(0,n.QP)((0,a.$)(e))}function i(){return Math.random().toString(36).substring(2)+Date.now().toString(36)}function o(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function c(e){const t=e.toLowerCase();return t.includes("pdf")||t.includes("word")||t.includes("doc")?"ðŸ“„":t.includes("text")||t.includes("txt")?"ðŸ“":t.includes("image")?"ðŸ–¼ï¸":t.includes("video")?"ðŸŽ¥":t.includes("audio")?"ðŸŽµ":t.includes("excel")||t.includes("sheet")?"ðŸ“Š":t.includes("powerpoint")||t.includes("presentation")?"ðŸ“ˆ":t.includes("json")?"ðŸ“‹":t.includes("csv")?"ðŸ“Š":t.includes("zip")||t.includes("rar")?"ðŸ—œï¸":"ðŸ“Ž"}function l(e,t){return t.some(t=>e.toLowerCase().includes(t.toLowerCase()))}function d(e){const t=new Date(e),s=(new Date).getTime()-t.getTime(),a=Math.floor(s/6e4),n=Math.floor(s/36e5),r=Math.floor(s/864e5);return a<1?"Just now":a<60?`${a}m ago`:n<24?`${n}h ago`:r<7?`${r}d ago`:t.toLocaleDateString()}async function u(e){try{return await navigator.clipboard.writeText(e),!0}catch(e){return!1}}function g(e){try{if(e.startsWith("event: ")){return"finish"===e.slice(7).trim()?{type:"done"}:null}if(e.startsWith("data: ")){const t=e.slice(6).trim();if("[DONE]"===t||"DONE"===t)return{type:"done"};try{const e=JSON.parse(t);if("object"==typeof e){if(e.type)return e;if(void 0!==e.content)return{type:"content",content:e.content,citations:e.citations};if(e.citations&&!e.content)return{type:"citation",citations:e.citations};if(void 0!==e.message)return{type:"content",content:e.message,citations:e.citations};if(e.delta&&void 0!==e.delta.content)return{type:"content",content:e.delta.content,citations:e.citations};if(e.choices&&e.choices[0]&&e.choices[0].delta){const t=e.choices[0].delta;if(void 0!==t.content)return{type:"content",content:t.content,citations:e.citations}}}return e}catch(e){return{type:"content",content:t}}}if(e.trim().startsWith("{"))try{const t=JSON.parse(e.trim());return void 0!==t.content||void 0!==t.citations?{type:t.content?"content":"citation",content:t.content,citations:t.citations}:void 0!==t.message?{type:"content",content:t.message,citations:t.citations}:t}catch(e){}return!e.trim()||e.includes("data:")||e.startsWith("{")?null:{type:"content",content:e.trim()}}catch(e){return null}}function m(e){let t=e.trim();t=t.replace(/^(OpenAI-|System-|API-|Assistant:|User:)\s*/i,"");const s=t.split(/\s+/).slice(0,6).join(" ");return s.length>50?s.substring(0,50).trim()+"...":s}const h={MAX_FILE_SIZE:10485760,ACCEPTED_FILE_TYPES:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","text/csv","application/json","application/xml","image/jpeg","image/png","image/gif","image/webp"],MAX_MESSAGE_LENGTH:4e3,API_TIMEOUT:3e4,STREAM_TIMEOUT:6e4,RETRY_ATTEMPTS:3,RETRY_DELAY:1e3}},23847:(e,t,s)=>{"use strict";s.d(t,{Cc:()=>a,YL:()=>o,qE:()=>n,wv:()=>i,yT:()=>r});const a=(e,t,s)=>e+(t-e)*s,n=(e,t,s)=>Math.max(t,Math.min(s,e)),r=(e,t)=>Math.random()*(t-e)+e,i=(e,t,s,a)=>{const n=s-e,r=a-t;return Math.sqrt(n*n+r*r)},o=(e,t,s)=>{e/=360,s/=100;const a=(e,t,s)=>(s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e);if(0===(t/=100))return[255*s,255*s,255*s];{const n=s<.5?s*(1+t):s+t-s*t,r=2*s-n;return[Math.round(255*a(r,n,e+1/3)),Math.round(255*a(r,n,e)),Math.round(255*a(r,n,e-1/3))]}}},25772:(e,t,s)=>{"use strict";function a(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,{v:()=>r});class n{constructor(){a(this,"isClient",void 0),a(this,"logs",[]),this.isClient="undefined"!=typeof window}static getInstance(){return n.instance||(n.instance=new n),n.instance}formatMessage(e){const{timestamp:t,level:s,category:a,message:n,data:r,error:i,stack:o}=e;let c=`[${t}] [${s.toUpperCase()}] [${a}] ${n}`;return r&&(c+=`\nData: ${JSON.stringify(r,null,2)}`),i&&(c+=`\nError: ${i.message||i}`,o&&(c+=`\nStack: ${o}`)),c}writeToFile(e){}log(e,t,s,a,n){const r={timestamp:(new Date).toISOString(),level:e,category:t,message:s,data:a,error:n?{message:n.message,code:n.code,status:n.status}:void 0,stack:n?.stack};this.logs.push(r),this.logs.length>1e3&&(this.logs=this.logs.slice(-500));r.timestamp.split("T")[1].split(".")[0];if(this.isClient);else{}}info(e,t,s){this.log("info",e,t,s)}warn(e,t,s){this.log("warn",e,t,s)}error(e,t,s,a){this.log("error",e,t,a,s)}getLogs(){return this.logs}clearLogs(){this.logs=[]}apiRequest(e,t,s){this.info("API_REQUEST",`${t} ${e}`,s)}apiResponse(e,t,s){const a=t>=400?"error":"info";this.log(a,"API_RESPONSE",`${e} - Status: ${t}`,s)}apiError(e,t){this.error("API_ERROR",`Failed request to ${e}`,t)}authCheck(e,t){this.info("AUTH",e,t)}authError(e,t){this.error("AUTH_ERROR",e,t)}navigation(e,t){this.info("NAVIGATION",`Navigating to ${e}`,t)}storeAction(e,t,s){this.info("STORE",`${e}.${t}`,s)}}a(n,"instance",void 0);const r=n.getInstance()},26998:(e,t,s)=>{"use strict";s.r(t),s.d(t,{DefaultTheme:()=>c});var a=s(60033),n=s(51110),r=s(23847),i=s(29183);function o(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class c extends a.z{constructor(){super(),o(this,"id","default"),o(this,"name","Classic Sphere"),o(this,"description","The original 3D particle sphere with smooth color transitions"),o(this,"category","particle"),o(this,"performanceProfile","medium"),o(this,"sphereRadius",280),o(this,"radiusScale",1),o(this,"framesPerRotation",5e3),o(this,"focalLength",320),o(this,"zeroAlphaDepth",-750),o(this,"sphereCenterY",0),o(this,"sphereCenterZ",-3-this.sphereRadius),o(this,"particlePool",void 0),o(this,"particleList",{}),o(this,"recycleBin",{}),o(this,"currentParticleCount",0),o(this,"maxParticles",200),o(this,"currentR",52),o(this,"currentG",235),o(this,"currentB",222),o(this,"targetR",52),o(this,"targetG",235),o(this,"targetB",222),o(this,"colorTransitionSpeed",.05),o(this,"currentColorScheme","gemini"),o(this,"turnAngle",1),o(this,"wait",2),o(this,"count",0),o(this,"numToAddEachFrame",3),o(this,"particleAlpha",1),o(this,"particleRad",2.5),o(this,"gravity",0),o(this,"randAccelX",.1),o(this,"randAccelY",.1),o(this,"randAccelZ",.1),o(this,"colorSchemes",{gemini:{idle:{r:66,g:133,b:244,gradient:[66,133,244,52,168,83]},userSpeaking:{r:234,g:67,b:53,gradient:[234,67,53,251,188,5]},processing:{r:155,g:64,b:224,gradient:[155,64,224,66,133,244]},aiSpeaking:{r:52,g:168,b:83,gradient:[52,168,83,66,133,244]},hover:{r:251,g:188,b:5,gradient:[251,188,5,234,67,53]}},instagram:{idle:{r:228,g:64,b:95,gradient:[228,64,95,247,119,55]},userSpeaking:{r:247,g:119,b:55,gradient:[247,119,55,252,175,69]},processing:{r:193,g:53,b:132,gradient:[193,53,132,228,64,95]},aiSpeaking:{r:252,g:175,b:69,gradient:[252,175,69,247,119,55]},hover:{r:131,g:58,b:180,gradient:[131,58,180,193,53,132]}},ocean:{idle:{r:0,g:119,b:190,gradient:[0,119,190,0,168,232]},userSpeaking:{r:0,g:168,b:232,gradient:[0,168,232,0,201,255]},processing:{r:0,g:201,b:255,gradient:[0,201,255,100,255,218]},aiSpeaking:{r:100,g:255,b:218,gradient:[100,255,218,0,168,232]},hover:{r:0,g:150,b:199,gradient:[0,150,199,0,201,255]}},sunset:{idle:{r:255,g:107,b:107,gradient:[255,107,107,255,193,7]},userSpeaking:{r:255,g:193,b:7,gradient:[255,193,7,255,142,83]},processing:{r:255,g:142,b:83,gradient:[255,142,83,255,107,107]},aiSpeaking:{r:255,g:230,b:109,gradient:[255,230,109,255,193,7]},hover:{r:255,g:171,b:64,gradient:[255,171,64,255,107,107]}},aurora:{idle:{r:0,g:201,b:255,gradient:[0,201,255,146,254,157]},userSpeaking:{r:146,g:254,b:157,gradient:[146,254,157,0,255,193]},processing:{r:0,g:255,b:193,gradient:[0,255,193,186,85,255]},aiSpeaking:{r:186,g:85,b:255,gradient:[186,85,255,0,201,255]},hover:{r:120,g:255,b:214,gradient:[120,255,214,186,85,255]}}}),this.particlePool=new i.iy(()=>({x:0,y:0,z:0,velX:0,velY:0,velZ:0,age:0,dead:!1,right:!1,projX:0,projY:0,alpha:0,attack:0,hold:0,decay:0,initValue:0,holdValue:0,lastValue:0,stuckTime:0,accelX:0,accelY:0,accelZ:0}),e=>{e.age=0,e.dead=!1,e.alpha=0,e.next=void 0,e.prev=void 0},50,this.maxParticles),this.setColor(this.getColorPalette().idle)}onInit(){this.maxParticles=this.getMaxParticles()}onDraw(e,t,s,a,n,r){this.updateColors(),this.updateParticles(e,t,s,a,n),this.renderParticles(e,t,s,a,n)}onStateChange(e){const t=this.getColorPalette();switch(e){case n.Y.USER_SPEAKING:this.framesPerRotation=2e3,this.colorTransitionSpeed=.15,this.setColor(t.userSpeaking),this.numToAddEachFrame=5,this.particleAlpha=1.2,this.particleRad=3.5,this.gravity=.1;break;case n.Y.PROCESSING:this.framesPerRotation=500,this.colorTransitionSpeed=.2,this.setColor(t.processing),this.numToAddEachFrame=8,this.particleAlpha=1.5,this.particleRad=4,this.gravity=0;break;case n.Y.AI_SPEAKING:this.framesPerRotation=2500,this.colorTransitionSpeed=.1,this.setColor(t.aiSpeaking),this.numToAddEachFrame=4,this.particleAlpha=1.3,this.particleRad=3,this.gravity=-.05;break;case n.Y.IDLE:default:this.framesPerRotation=5e3,this.colorTransitionSpeed=.05,this.setColor(t.idle),this.numToAddEachFrame=3,this.particleAlpha=1,this.particleRad=2.5,this.gravity=0}}getThemeSpecificMetrics(){return{particleCount:this.currentParticleCount,maxParticles:this.maxParticles,colorScheme:this.currentColorScheme}}setColorScheme(e){if(this.colorSchemes[e]){this.currentColorScheme=e;const t=this.getColorPalette();this.setColor(t.idle)}}getColorPalette(){return this.colorSchemes[this.currentColorScheme]||this.colorSchemes.gemini}setColor(e){this.targetR=e.r,this.targetG=e.g,this.targetB=e.b}updateColors(){this.currentR=(0,r.Cc)(this.currentR,this.targetR,this.colorTransitionSpeed),this.currentG=(0,r.Cc)(this.currentG,this.targetG,this.colorTransitionSpeed),this.currentB=(0,r.Cc)(this.currentB,this.targetB,this.colorTransitionSpeed)}updateParticles(e,t,s,a,n){if(this.count++,this.count>=this.wait&&this.currentParticleCount<this.maxParticles){this.count=0;const e=Math.floor(this.numToAddEachFrame*(1+.5*this.mouseInfluence)),t=Math.min(e,this.maxParticles-this.currentParticleCount);for(let e=0;e<t;e++)this.createParticle()}const r=2*Math.PI/this.framesPerRotation*(1+.3*this.mouseInfluence);this.turnAngle=(this.turnAngle+r)%(2*Math.PI)}createParticle(){const e=2*Math.random()*Math.PI,t=Math.acos(2*Math.random()-1),s=.3*this.mouseInfluence,a=this.normalizedMouseX*s*this.sphereRadius*.5,n=this.normalizedMouseY*s*this.sphereRadius*.5,r=0,i=this.sphereRadius*Math.sin(t)*Math.cos(e)+a,o=this.sphereRadius*Math.sin(t)*Math.sin(e)+n,c=this.sphereRadius*Math.cos(t)+r,l=.002*(1+.5*this.mouseInfluence),d=this.addParticle(i,this.sphereCenterY+o,this.sphereCenterZ+c,l*i,l*o,l*c),u=1+.3*this.mouseInfluence;d.attack=Math.floor(30/(1+.5*this.mouseInfluence)),d.hold=Math.floor(30*(1+.5*this.mouseInfluence)),d.decay=60,d.initValue=0,d.holdValue=this.particleAlpha*u,d.lastValue=0,d.stuckTime=Math.floor((45+15*Math.random())/(1+.3*this.mouseInfluence)),d.accelX=this.normalizedMouseX*this.mouseInfluence*.001,d.accelY=this.gravity+this.normalizedMouseY*this.mouseInfluence*.001,d.accelZ=0}addParticle(e,t,s,a,n,r){const i=this.particlePool.acquire();return this.currentParticleCount++,this.particleList.first&&(i.next=this.particleList.first,this.particleList.first.prev=i),this.particleList.first=i,i.prev=void 0,i.x=e,i.y=t,i.z=s,i.velX=a,i.velY=n,i.velZ=r,i.age=0,i.dead=!1,i.right=Math.random()<.5,i}renderParticles(e,t,s,a,n){const r=Math.sin(this.turnAngle),i=Math.cos(this.turnAngle),o=this.focalLength-2;let c=this.particleList.first;for(;c;){const l=c.next;c.age++,c.age>c.stuckTime&&(c.velX+=c.accelX+this.randAccelX*(2*Math.random()-1),c.velY+=c.accelY+this.randAccelY*(2*Math.random()-1),c.velZ+=c.accelZ+this.randAccelZ*(2*Math.random()-1),c.x+=c.velX,c.y+=c.velY,c.z+=c.velZ);const d=i*c.x+r*(c.z-this.sphereCenterZ),u=-r*c.x+i*(c.z-this.sphereCenterZ)+this.sphereCenterZ,g=this.radiusScale*this.focalLength/(this.focalLength-u);c.projX=d*g+a,c.projY=c.y*g+n,this.updateParticleAlpha(c);c.projX>t||c.projX<0||c.projY<0||c.projY>s||u>o||c.dead?this.recycleParticle(c):this.renderParticle(e,c,u,g),c=l}}updateParticleAlpha(e){e.age<e.attack+e.hold+e.decay?e.age<e.attack?e.alpha=(e.holdValue-e.initValue)/e.attack*e.age+e.initValue:e.age<e.attack+e.hold?e.alpha=e.holdValue:e.alpha=(e.lastValue-e.holdValue)/e.decay*(e.age-e.attack-e.hold)+e.holdValue:e.dead=!0}renderParticle(e,t,s,a){const n=Math.max(0,Math.min(1,1-s/this.zeroAlphaDepth))*t.alpha,r=a*this.particleRad*(1+.2*this.mouseInfluence);e.fillStyle=`rgba(${Math.floor(this.currentR)}, ${Math.floor(this.currentG)}, ${Math.floor(this.currentB)}, ${n})`,e.beginPath(),e.arc(t.projX,t.projY,r,0,2*Math.PI),e.fill(),this.shouldEnableGlow()&&this.mouseInfluence>.5&&n>.3&&(e.fillStyle=`rgba(${Math.floor(this.currentR)}, ${Math.floor(this.currentG)}, ${Math.floor(this.currentB)}, ${.3*n})`,e.beginPath(),e.arc(t.projX,t.projY,1.5*r,0,2*Math.PI),e.fill())}recycleParticle(e){this.currentParticleCount=Math.max(0,this.currentParticleCount-1),this.particleList.first===e?(this.particleList.first=e.next,e.next&&(e.next.prev=void 0)):(e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev)),this.particlePool.release(e)}onDispose(){this.particleList.first=void 0,this.currentParticleCount=0,this.particlePool.clear()}}},27292:(e,t,s)=>{"use strict";s.d(t,{o:()=>c});var a=s(71446),n=s(35189),r=s(90040),i=s(7648),o=s(91582);const c=(0,a.vt)()((0,n.Zr)((e,t)=>({agents:[],currentAgent:null,loading:!1,error:null,paginationMeta:void 0,fetchAgents:async()=>{e({loading:!0,error:null});try{const s=(0,r.getClient)(),a=await s.getAgents({page:1,per_page:100});let n=[],i=0,o=!1;if(a&&"object"==typeof a)if("data"in a&&a.data&&"object"==typeof a.data&&"data"in a.data){const e=a.data;n=Array.isArray(e.data)?e.data:[],i=e.total||n.length;const t=e.current_page||1;e.per_page;o=!!e.last_page&&t<e.last_page}else if("data"in a&&"total"in a){const e=a;n=e.data,i=e.total,o=i>e.per_page}else Array.isArray(a.data)?(n=a.data,i=n.length,o=!1):Array.isArray(a)&&(n=a,i=n.length,o=!1);e({agents:n,loading:!1,paginationMeta:{currentPage:1,totalCount:i,hasMore:o,perPage:100},currentAgent:t().currentAgent||(n.length>0?n[0]:null)});const c=async()=>{const t=(0,r.getClient)(),s=n.filter(e=>!e.settings);if(0===s.length)return;for(let a=0;a<s.length;a+=5){const n=s.slice(a,a+5).map(async e=>{try{const s=await t.getAgentSettings(e.id);if(s&&s.data)return{agent:e,settings:s.data}}catch(e){}return null}),r=(await Promise.all(n)).filter(e=>null!==e);r.length>0&&e(e=>({agents:e.agents.map(e=>{const t=r.find(t=>t.agent.id===e.id);return t?{...e,settings:t.settings}:e}),currentAgent:e.currentAgent?(()=>{const t=r.find(t=>t.agent.id===e.currentAgent.id);return t?{...e.currentAgent,settings:t.settings}:e.currentAgent})():e.currentAgent})),a+5<s.length&&await new Promise(e=>setTimeout(e,100))}};c().catch(e=>{})}catch(t){e({agents:[],error:t instanceof Error?t.message:"Failed to fetch agents",loading:!1})}},loadMoreAgents:async()=>{const s=t(),a=s.paginationMeta;if(a?.hasMore&&!s.loading){e({loading:!0,error:null});try{const t=(0,r.getClient)(),s=a.currentPage+1,n=await t.getAgents({page:s,per_page:a.perPage});if(n&&"data"in n){let t=[],r=0,i=s;if(n.data&&"object"==typeof n.data&&"data"in n.data){const e=n.data;t=Array.isArray(e.data)?e.data:[],r=e.total||0,i=e.current_page||s}else Array.isArray(n.data)&&(t=n.data,r=a.totalCount);e(e=>({agents:[...e.agents,...t],loading:!1,paginationMeta:{...a,currentPage:i,hasMore:i*a.perPage+t.length<r}}))}}catch(t){e({error:t instanceof Error?t.message:"Failed to load more agents",loading:!1})}}},findAgent:async s=>{try{const a=(0,r.getClient)();if("number"==typeof s||/^\d+$/.test(s.toString())){const n="number"==typeof s?s:parseInt(s.toString());try{const s=(await a.getAgent(n)).data;return t().agents.find(e=>e.id===s.id)||e(e=>({agents:[s,...e.agents]})),s}catch{}}const n=t();return n.agents.find(e=>e.project_name.toLowerCase().includes(s.toString().toLowerCase())||e.id.toString()===s.toString())||null}catch(e){return null}},createAgent:async t=>{e({loading:!0,error:null});try{const s=(0,r.getClient)(),a=(await s.createAgent(t)).data;return e(e=>({agents:[a,...e.agents],currentAgent:a,loading:!1})),a}catch(t){throw e({error:t instanceof Error?t.message:"Failed to create agent",loading:!1}),t}},selectAgent:async t=>{const s=i.w.getState(),a=o.o.getState();e({currentAgent:t}),s.selectConversation(null),a.clearMessages();try{const s=(0,r.getClient)(),a=await s.getAgentSettings(t.id);if(a&&a.data){const s={...t,settings:a.data};e({currentAgent:s}),e(e=>({agents:e.agents.map(e=>e.id===t.id?s:e)}))}}catch(e){}try{await s.fetchConversations(t.id)}catch(e){}},setAgents:s=>{e({agents:s,currentAgent:(()=>{const e=t().currentAgent;if(!e)return s.length>0?s[0]:null;return s.find(t=>t.id===e.id)||(s.length>0?s[0]:null)})()})},updateAgent:async(t,s)=>{e({loading:!0,error:null});try{const a=(0,r.getClient)(),n=(await a.updateAgent(t,s)).data;return e(e=>({agents:e.agents.map(e=>e.id===t?n:e),currentAgent:e.currentAgent?.id===t?n:e.currentAgent,loading:!1})),n}catch(t){throw e({error:t instanceof Error?t.message:"Failed to update agent",loading:!1}),t}},updateSettings:async(t,s)=>{e({loading:!0,error:null});try{const a=(0,r.getClient)(),n=new FormData;Object.entries(s).forEach(([e,t])=>{null!=t&&n.append(e,String(t))});const i=(await a.updateAgentSettings(t,n)).data;return e(e=>({agents:e.agents.map(e=>e.id===t?{...e,settings:{...e.settings,...i}}:e),currentAgent:e.currentAgent?.id===t?{...e.currentAgent,settings:{...e.currentAgent.settings,...i}}:e.currentAgent,loading:!1})),i}catch(t){throw e({error:t instanceof Error?t.message:"Failed to update agent settings",loading:!1}),t}},deleteAgent:async t=>{e({loading:!0,error:null});try{const s=(0,r.getClient)();await s.deleteAgent(t),e(e=>{const s=e.agents.filter(e=>e.id!==t);return{agents:s,currentAgent:e.currentAgent?.id===t?s.length>0?s[0]:null:e.currentAgent,loading:!1}})}catch(t){throw e({error:t instanceof Error?t.message:"Failed to delete agent",loading:!1}),t}},replicateAgent:async t=>{e({loading:!0,error:null});try{const s=(0,r.getClient)(),a=(await s.replicateAgent(t)).data;return e(e=>({agents:[a,...e.agents],currentAgent:a,loading:!1})),a}catch(t){throw e({error:t instanceof Error?t.message:"Failed to replicate agent",loading:!1}),t}},getAgentStats:async e=>{try{const t=(0,r.getClient)();return(await t.getAgentStats(e)).data}catch(e){throw e}}}),{name:"customgpt-agents",partialize:e=>({currentAgent:e.currentAgent})}))},29183:(e,t,s)=>{"use strict";function a(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,{L:()=>r,iy:()=>i,r3:()=>n});class n{constructor(e=60){a(this,"frameCount",0),a(this,"lastTime",0),a(this,"currentFPS",60),a(this,"frameTime",16.67),a(this,"fpsHistory",[]),a(this,"frameTimeHistory",[]),a(this,"maxHistorySize",60),a(this,"warningThreshold",.8),a(this,"criticalThreshold",.6),a(this,"callbacks",{}),this.lastTime=performance.now()}update(){const e=performance.now(),t=e-this.lastTime;this.frameTime=t,this.frameCount++;const s=1e3/t;this.fpsHistory.push(s),this.frameTimeHistory.push(t),this.fpsHistory.length>this.maxHistorySize&&(this.fpsHistory.shift(),this.frameTimeHistory.shift());const a=this.fpsHistory.reduce((e,t)=>e+t,0)/this.fpsHistory.length;this.currentFPS=a;const n=a/30;return n<this.criticalThreshold?this.callbacks.onPerformanceCritical?.({fps:a,frameTime:t}):n<this.warningThreshold&&this.callbacks.onPerformanceWarning?.({fps:a,frameTime:t}),this.frameCount%30==0&&this.callbacks.onFPSUpdate?.(a),this.lastTime=e,{fps:a,frameTime:t}}setCallbacks(e){this.callbacks={...this.callbacks,...e}}getCurrentMetrics(){return{fps:this.currentFPS,frameTime:this.frameTime}}reset(){this.frameCount=0,this.fpsHistory=[],this.frameTimeHistory=[],this.lastTime=performance.now()}}class r{constructor(){a(this,"capabilities",null)}static getInstance(){return r.instance||(r.instance=new r),r.instance}async detectCapabilities(){if(this.capabilities)return this.capabilities;const e=this.detectMobile(),t=this.detectWebGL(),s=navigator.hardwareConcurrency||4;let a;"memory"in navigator&&(a=navigator.memory.jsHeapSizeLimit/1024**3);const n=await this.benchmarkPerformance(),r=this.detectLowPowerDevice(s,a,n);return this.capabilities={isMobile:e,isLowPowerDevice:r,supportsWebGL:t,hardwareConcurrency:s,memoryGB:a,performanceLevel:n},this.capabilities}detectMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}detectWebGL(){try{const e=document.createElement("canvas");return!(!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch{return!1}}detectLowPowerDevice(e,t,s){return e<=2||(!!(t&&t<2)||"low"===s)}async benchmarkPerformance(){return new Promise(e=>{const t=performance.now();let s=0;const a=()=>{if(performance.now()-t>=50)e(s<1e5?"low":s<5e5?"medium":"high");else{for(let e=0;e<1e3;e++)Math.sin(Math.random()*Math.PI*2),s++;requestAnimationFrame(a)}};requestAnimationFrame(a)})}getCapabilities(){return this.capabilities}}a(r,"instance",void 0);class i{constructor(e,t,s=10,n=1e3){a(this,"available",[]),a(this,"inUse",new Set),a(this,"createFn",void 0),a(this,"resetFn",void 0),a(this,"maxSize",void 0),this.createFn=e,this.resetFn=t,this.maxSize=n;for(let e=0;e<s;e++)this.available.push(this.createFn())}acquire(){let e;if(this.available.length>0)e=this.available.pop();else if(this.inUse.size<this.maxSize)e=this.createFn();else{const t=this.inUse.values().next().value;t?(this.release(t),e=t):e=this.createFn()}return this.inUse.add(e),e}release(e){this.inUse.has(e)&&(this.inUse.delete(e),this.resetFn&&this.resetFn(e),this.available.push(e))}getStats(){return{available:this.available.length,inUse:this.inUse.size,total:this.available.length+this.inUse.size}}clear(){this.available=[],this.inUse.clear()}}},33345:(e,t,s)=>{"use strict";s.d(t,{Hr:()=>i});var a=s(17047);function n(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class r{constructor(e={}){n(this,"config",void 0),n(this,"abortController",null),n(this,"currentMessage",null),this.config={timeout:e.timeout||6e4,retryAttempts:e.retryAttempts||3,retryDelay:e.retryDelay||1e3}}async processStream(e,t){this.abortController=new AbortController,this.currentMessage={id:this.generateId(),content:"",citations:[],isComplete:!1};const s=e.getReader(),a=new TextDecoder;let n="";const r=setTimeout(()=>{this.cancel(),t.onError?.(new Error("Stream timeout"))},this.config.timeout);try{for(;;){const{done:e,value:r}=await s.read();if(e){this.currentMessage.isComplete=!0,t.onComplete?.();break}n+=a.decode(r,{stream:!0});const i=n.split("\n");n=i.pop()||"";for(const e of i)e.trim()&&await this.processLine(e,t)}}catch(e){e instanceof Error&&"AbortError"===e.name?t.onError?.(new Error("Stream cancelled")):t.onError?.(e instanceof Error?e:new Error("Unknown streaming error"))}finally{clearTimeout(r),s.releaseLock(),this.abortController=null}return this.currentMessage}async processLine(e,t){const s=(0,a.RW)(e);if(s&&this.currentMessage)switch(s.type){case"content":s.content&&(this.currentMessage.content+=s.content,t.onChunk?.(s.content));break;case"citation":s.citations&&(this.currentMessage.citations.push(...s.citations),s.citations.forEach(e=>{t.onCitation?.(e)}));break;case"done":return this.currentMessage.isComplete=!0,void t.onComplete?.();case"error":return void t.onError?.(new Error(s.error||"Stream error"))}}cancel(){this.abortController&&this.abortController.abort()}getCurrentMessage(){return this.currentMessage}isStreaming(){return null!==this.abortController&&null!==this.currentMessage&&!this.currentMessage.isComplete}generateId(){return Math.random().toString(36).substring(2)+Date.now().toString(36)}}const i=new class{constructor(e=3){n(this,"streams",new Map),n(this,"maxConcurrentStreams",void 0),this.maxConcurrentStreams=e}async startStream(e,t,s,a){if(this.streams.size>=this.maxConcurrentStreams)throw new Error(`Maximum concurrent streams (${this.maxConcurrentStreams}) reached`);this.streams.has(e)&&this.cancelStream(e);const n=new r(a);this.streams.set(e,n);try{return await n.processStream(t,{...s,onComplete:()=>{this.streams.delete(e),s.onComplete?.()},onError:t=>{this.streams.delete(e),s.onError?.(t)}})}catch(t){throw this.streams.delete(e),t}}cancelStream(e){const t=this.streams.get(e);t&&(t.cancel(),this.streams.delete(e))}cancelAllStreams(){this.streams.forEach(e=>e.cancel()),this.streams.clear()}getActiveStreams(){return Array.from(this.streams.keys())}getStreamStatus(e){const t=this.streams.get(e);return t?{exists:!0,isStreaming:t.isStreaming(),message:t.getCurrentMessage()}:{exists:!1,isStreaming:!1,message:null}}getActiveStreamCount(){return this.streams.size}}},51110:(e,t,s)=>{"use strict";s.d(t,{Y:()=>a});let a=function(e){return e.IDLE="idle",e.USER_SPEAKING="userSpeaking",e.PROCESSING="processing",e.AI_SPEAKING="aiSpeaking",e}({})},51276:(e,t,s)=>{"use strict";s.r(t),s.d(t,{cleanupStores:()=>_,initializeStores:()=>A,useAgentStore:()=>d.o,useAnalyticsStore:()=>v,useConfigStore:()=>l,useConversationStore:()=>u.w,useLicenseStore:()=>N,useMessageStore:()=>g.o,usePageStore:()=>y,useProfileStore:()=>w,useProjectSettingsStore:()=>j,useSourceStore:()=>b,useUIStore:()=>m});var a=s(71446),n=s(35189);const r="customgpt-theme";function i(){if("undefined"==typeof window)return"light";const e=document.cookie.split(";").find(e=>e.trim().startsWith(`${r}=`));if(e){return"dark"===e.split("=")[1].trim()?"dark":"light"}return"light"}function o(e){"undefined"!=typeof window&&("dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"))}function c(e){!function(e){"undefined"!=typeof window&&(document.cookie=`${r}=${e}; max-age=31536000; path=/; SameSite=Lax`)}(e),o(e)}const l=(0,a.vt)()((0,n.Zr)((e,t)=>({apiKey:null,baseURL:"https://app.customgpt.ai/api/v1",theme:"undefined"!=typeof window?i():"light",setApiKey:e=>{},setBaseURL:e=>{},setTheme:t=>{e({theme:t}),"undefined"!=typeof window&&c(t)}}),{name:"customgpt-config",partialize:e=>({theme:e.theme}),onRehydrateStorage:()=>e=>{if("undefined"!=typeof window){const t=function(){const e=i();return o(e),e}();e&&e.theme!==t&&(e.theme=t)}}}));var d=s(27292),u=s(7648),g=s(91582);const m=(0,a.vt)()((0,n.Zr)(e=>({sidebarOpen:!0,settingsOpen:!1,theme:"light",fontSize:"md",setSidebarOpen:t=>{e({sidebarOpen:t})},setSettingsOpen:t=>{e({settingsOpen:t})},setTheme:t=>{e({theme:t}),"undefined"!=typeof window&&(document.documentElement.className=t)},setFontSize:t=>{if(e({fontSize:t}),"undefined"!=typeof window){const e=document.documentElement;switch(e.classList.remove("text-sm","text-base","text-lg"),t){case"sm":e.classList.add("text-sm");break;case"lg":e.classList.add("text-lg");break;default:e.classList.add("text-base")}}}}),{name:"customgpt-ui",partialize:e=>({sidebarOpen:e.sidebarOpen,theme:e.theme,fontSize:e.fontSize}),onRehydrateStorage:()=>e=>{if("undefined"!=typeof window&&e){document.documentElement.className=e.theme;const t=document.documentElement;switch(t.classList.remove("text-sm","text-base","text-lg"),e.fontSize){case"sm":t.classList.add("text-sm");break;case"lg":t.classList.add("text-lg");break;default:t.classList.add("text-base")}}}}));var h=s(90040),p=s(31681);const f=e=>e.toISOString().split("T")[0],x=()=>{const e=new Date,t=new Date;return t.setDate(t.getDate()-30),{startDate:f(t),endDate:f(e)}},v=(0,a.vt)((e,t)=>({analytics:null,loading:!1,error:null,dateRange:x(),fetchAnalytics:async t=>{e({loading:!0,error:null});try{const s=(0,h.getClient)(),[a,n,r,i]=await Promise.all([s.getTrafficReport(t),s.getQueriesReport(t),s.getConversationsReport(t),s.getAnalysisReport(t,"daily")]),o=Array.isArray(r.data?.total)?0:r.data?.total||0,c=Array.isArray(n.data?.total)?0:n.data?.total||0,l=Array.isArray(r.data?.average_queries_per_conversation)?0:Number(r.data?.average_queries_per_conversation)||0,d={conversations:{total:o,active:Math.floor(.7*o),trend:0,data:Array.isArray(i.data?.conversations)?i.data.conversations.map(e=>({date:e.created_at_interval,count:Number(e.queries_number)||0})):[]},queries:{total:c,successful:Array.isArray(n.data?.query_status)&&n.data.query_status.find(e=>"success"===e.status)?.count||0,failed:Array.isArray(n.data?.query_status)&&n.data.query_status.find(e=>"failed"===e.status)?.count||0,avgResponseTime:0,topQueries:[],data:Array.isArray(i.data?.queries)?i.data.queries.map(e=>({date:e.created_at_interval,count:Number(e.queries_number)||0})):[]},traffic:{uniqueUsers:Array.isArray(a.data?.sources)?a.data.sources.reduce((e,t)=>e+(t.request_source_number||0),0):0,pageViews:Array.isArray(a.data?.sources)?a.data.sources.reduce((e,t)=>e+(t.request_source_number||0),0):0,avgSessionDuration:0,bounceRate:0,data:Array.isArray(a.data?.sources)?a.data.sources.map(e=>({date:(new Date).toISOString().split("T")[0],users:e.request_source_number||0,pageViews:e.request_source_number||0})):[]},statistics:{totalMessages:c,totalConversations:o,avgMessagesPerConversation:l,satisfactionRate:0,responseAccuracy:0}};e({analytics:d,loading:!1})}catch(t){let s="Failed to fetch analytics";if(401===t.status){"demo"===("undefined"!=typeof window?localStorage.getItem("customgpt.deploymentMode"):"production")?(s="API key authentication failed. Please check your API key.",p.toast.error("Authentication failed. Please check your API key in demo settings.")):(s="Authentication required. Please check your API key configuration.",p.toast.error("Authentication failed. Please check your API key configuration."))}else 404===t.status?(s="Analytics data not found for this project.",p.toast.error("No analytics data available yet.")):500===t.status?(s="Server error occurred. Please try again later.",p.toast.error("Server error. Please try again later.")):p.toast.error("Failed to fetch analytics data");e({analytics:null,error:s,loading:!1})}},setDateRange:(t,s)=>{e({dateRange:{startDate:t,endDate:s}})},exportAnalytics:async e=>{const s=t().analytics;if(s)try{switch(e){case"json":const e=JSON.stringify(s,null,2),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download=`analytics-${(new Date).toISOString()}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a),p.toast.success("Analytics exported successfully");break;case"csv":p.toast.info("CSV export not yet implemented");break;case"pdf":p.toast.info("PDF export not yet implemented")}}catch(e){p.toast.error("Failed to export analytics")}else p.toast.error("No analytics data to export")},reset:()=>{e({analytics:null,loading:!1,error:null,dateRange:x()})}})),y=(0,a.vt)((e,t)=>({pages:[],loading:!1,error:null,paginationInfo:{current_page:1,total:0,per_page:20,last_page:1},queryParams:{page:1,limit:20,order:"desc",crawl_status:"all",index_status:"all"},fetchPages:async s=>{if((0,h.isClientInitialized)()){e({loading:!0,error:null});try{const a=(0,h.getClient)(),{queryParams:n}=t(),r=await a.getPages(s,n);e({pages:r.data.pages.data,paginationInfo:{current_page:r.data.pages.current_page,total:r.data.pages.total,per_page:r.data.pages.per_page,last_page:r.data.pages.last_page},loading:!1})}catch(t){let s="Failed to fetch pages";400===t.status?s="Invalid request. Please check the project ID.":401===t.status?s="Authentication failed. Please log in again.":404===t.status?s="Project not found.":500===t.status&&(s="Server error. Please try again later."),e({error:s,loading:!1}),p.toast.error(s)}}else e({error:"API client not initialized"})},deletePage:async(t,s)=>{if((0,h.isClientInitialized)()){e({loading:!0,error:null});try{const a=(0,h.getClient)();await a.deletePage(t,s),e(e=>({pages:e.pages.filter(e=>e.id!==s),loading:!1})),p.toast.success("Page deleted successfully")}catch(t){let s="Failed to delete page";401===t.status?s="Authentication failed. Please log in again.":404===t.status&&(s="Page not found."),e({error:s,loading:!1}),p.toast.error(s)}}else p.toast.error("API client not initialized")},reindexPage:async(t,s)=>{if((0,h.isClientInitialized)()){e({loading:!0,error:null});try{const a=(0,h.getClient)();await a.reindexPage(t,s),e(e=>({pages:e.pages.map(e=>e.id===s?{...e,crawl_status:"queued",index_status:"queued"}:e),loading:!1})),p.toast.success("Page reindexing started")}catch(t){let s="Failed to reindex page";401===t.status?s="Authentication failed. Please log in again.":403===t.status&&(s="The page could not be reindexed."),e({error:s,loading:!1}),p.toast.error(s)}}else p.toast.error("API client not initialized")},setQueryParams:t=>{e(e=>({queryParams:{...e.queryParams,...t}}))},reset:()=>{e({pages:[],loading:!1,error:null,paginationInfo:{current_page:1,total:0,per_page:20,last_page:1},queryParams:{page:1,limit:20,order:"desc",crawl_status:"all",index_status:"all"}})}})),b=(0,a.vt)((e,t)=>({sources:[],currentSource:null,loading:!1,error:null,searchQuery:"",filter:{status:"all",type:"all",sortBy:"updated_at",sortOrder:"desc"},syncStatus:{syncing:!1},fetchSources:async t=>{e({loading:!0,error:null});try{const s=(0,h.getClient)(),a=await s.getSources(t),n=[];if(a.data.sitemaps&&a.data.sitemaps.forEach(e=>{n.push({id:e.id.toString(),project_id:t,name:e.settings.sitemap_path||`Source ${e.id}`,type:"url",status:"active",metadata:{...e.settings,pages:e.pages},created_at:e.created_at,updated_at:e.updated_at})}),a.data.uploads){(Array.isArray(a.data.uploads)?a.data.uploads:[a.data.uploads]).forEach(e=>{n.push({id:e.id.toString(),project_id:t,name:`Upload ${e.id}`,type:"file",status:"active",metadata:{...e.settings,pages:e.pages},created_at:e.created_at,updated_at:e.updated_at})})}e({sources:n,loading:!1})}catch(t){e({error:t instanceof Error?t.message:"Failed to fetch sources",loading:!1}),p.toast.error("Failed to load sources")}},fetchSource:async(t,s)=>{e({loading:!0,error:null});try{throw new Error("getSource API method not available")}catch(t){e({error:t instanceof Error?t.message:"Failed to fetch source",loading:!1}),p.toast.error("Failed to load source details")}},uploadSources:async(s,a)=>{e({loading:!0,error:null});try{(0,h.getClient)();const n=a.map(e=>Promise.reject(new Error("uploadFile API method not available")));await Promise.all(n);await t().fetchSources(s),p.toast.success(`Successfully uploaded ${a.length} file(s)`),e({loading:!1})}catch(t){throw e({error:t instanceof Error?t.message:"Failed to upload sources",loading:!1}),p.toast.error("Failed to upload files"),t}},updateSource:async(t,s,a)=>{e({loading:!0,error:null});try{(0,h.getClient)();throw new Error("updateSource API method not available")}catch(t){throw e({error:t instanceof Error?t.message:"Failed to update source",loading:!1}),p.toast.error("Failed to update source"),t}},deleteSource:async(t,s)=>{e({loading:!0,error:null});try{const a=(0,h.getClient)();await a.deleteSource(t,parseInt(s)),e(e=>({sources:e.sources.filter(e=>e.id!==s),currentSource:e.currentSource?.id===s?null:e.currentSource,loading:!1})),p.toast.success("Source deleted successfully")}catch(t){throw e({error:t instanceof Error?t.message:"Failed to delete source",loading:!1}),p.toast.error("Failed to delete source"),t}},bulkDelete:async(t,s)=>{e({loading:!0,error:null});try{const a=(0,h.getClient)();await Promise.all(s.map(e=>a.deleteSource(t,parseInt(e)))),e(e=>({sources:e.sources.filter(e=>!s.includes(e.id)),currentSource:s.includes(e.currentSource?.id||"")?null:e.currentSource,loading:!1})),p.toast.success(`Successfully deleted ${s.length} source(s)`)}catch(t){throw e({error:t instanceof Error?t.message:"Failed to delete sources",loading:!1}),p.toast.error("Failed to delete sources"),t}},syncSources:async t=>{e(e=>({syncStatus:{...e.syncStatus,syncing:!0,progress:0}}));try{(0,h.getClient)();throw new Error("syncSources API method not available")}catch(t){throw e(e=>({syncStatus:{...e.syncStatus,syncing:!1},error:t instanceof Error?t.message:"Failed to sync sources"})),p.toast.error("Failed to sync sources"),t}},setSearchQuery:t=>{e({searchQuery:t})},setFilter:t=>{e(e=>({filter:{...e.filter,...t}}))},selectSource:t=>{e({currentSource:t})},reset:()=>{e({sources:[],currentSource:null,loading:!1,error:null,searchQuery:"",filter:{status:"all",type:"all",sortBy:"updated_at",sortOrder:"desc"},syncStatus:{syncing:!1}})}})),w=(0,a.vt)()((0,n.Zr)((e,t)=>({profile:null,loading:!1,error:null,fetchProfile:async()=>{e({loading:!0,error:null});try{const t=(0,h.getClient)(),s=await t.getUserProfile();if("success"!==s.status)throw new Error("Failed to fetch profile");e({profile:s.data,loading:!1})}catch(t){let s="Failed to fetch profile";if(401===t.status){"demo"===("undefined"!=typeof window?localStorage.getItem("customgpt.deploymentMode"):null)?(s="API key authentication failed. Please check your API key.",p.toast.error("Authentication failed. Please check your API key in demo settings.")):(s="Authentication required. Please check your API key configuration.",p.toast.error("Authentication failed. Please check your API key configuration."))}else 500===t.status?(s="Server error occurred. Please try again later.",p.toast.error("Server error. Please try again later.")):p.toast.error("Failed to load profile");e({error:s,loading:!1})}},updateProfile:async(t,s)=>{e({loading:!0,error:null});try{const a=(0,h.getClient)(),n=new FormData;n.append("name",t),s&&n.append("profile_photo",s);const r=await a.updateUserProfile(n);if("success"!==r.status)throw new Error("Failed to update profile");e({profile:r.data,loading:!1}),p.toast.success("Profile updated successfully")}catch(t){let s="Failed to update profile";if(401===t.status){"demo"===("undefined"!=typeof window?localStorage.getItem("customgpt.deploymentMode"):null)?(s="API key authentication failed. Please check your API key.",p.toast.error("Authentication failed. Please check your API key in demo settings.")):(s="Authentication required. Please check your API key configuration.",p.toast.error("Authentication failed. Please check your API key configuration."))}else if(422===t.status||400===t.status)if(t.data?.data?.errors){const e=t.data.data.errors;if(e.profile_photo&&Array.isArray(e.profile_photo))s=e.profile_photo[0],p.toast.error(s);else{s=Object.values(e).flat()[0]||"Validation error occurred",p.toast.error(s)}}else s=t.message||"Validation error occurred",p.toast.error(s);else 500===t.status?(s="Server error occurred. Please try again later.",p.toast.error("Server error. Please try again later.")):(s=t.message||"Failed to update profile",p.toast.error(s));e({error:s,loading:!1})}},reset:()=>{e({profile:null,loading:!1,error:null})}}),{name:"profile-store",partialize:e=>({profile:e.profile})})),S=new Map,j=(0,a.vt)((e,t)=>({settings:null,settingsLoading:!1,settingsError:null,plugins:[],pluginsLoading:!1,pluginsError:null,stats:null,statsLoading:!1,statsError:null,fetchSettings:async t=>{const s=`settings-${t}`;if(!S.get(s)){S.set(s,!0),e({settingsLoading:!0,settingsError:null});try{const s=await(0,h.getClient)().getAgentSettings(t);if(s&&s.data)e({settings:s.data,settingsLoading:!1,settingsError:null});else{if(!s)throw new Error("Failed to fetch project settings");e({settings:s,settingsLoading:!1,settingsError:null})}}catch(t){const s=t instanceof Error?t.message:"Failed to fetch project settings";e({settingsError:s,settingsLoading:!1}),t instanceof Error&&!t.message.includes("404")&&p.toast.error(s)}finally{S.delete(s)}}},updateSettings:async(s,a)=>{e({settingsLoading:!0,settingsError:null});try{const n=new FormData,r={ending_message:"Please email us for further support",no_answer_message:"Sorry, I don't have an answer for that.",try_asking_questions_msg:"Try asking these questions...",view_more_msg:"View more",view_less_msg:"View less",citations_answer_source_label_msg:"Where did this answer come from?",citations_sources_label_msg:"Sources",hang_in_there_msg:"Hang in there! I'm thinking..",chatbot_siesta_msg:"Oops! The agent is taking a siesta. We are aware of this and will get it back soon! Please try again later."};Object.entries(a).forEach(([e,t])=>{if(null!=t)if("example_questions"===e&&Array.isArray(t))t.forEach(e=>{n.append("example_questions[]",e)});else if(t instanceof File)n.append(e,t);else{const s=String(t);""===s&&r[e]?n.append(e,r[e]):n.append(e,s)}});if(!await(0,h.getClient)().updateAgentSettings(s,n))throw new Error("Failed to update project settings");e({settingsLoading:!1}),await t().fetchSettings(s),p.toast.success("Project settings updated successfully")}catch(t){const s=t instanceof Error?t.message:"Failed to update project settings";e({settingsError:s,settingsLoading:!1}),p.toast.error(s)}},fetchPlugins:async t=>{e({pluginsLoading:!0,pluginsError:null});try{const s=await(0,h.getClient)().getProjectPlugins(t);if(!s)throw new Error("Failed to fetch project plugins");{const t=s.data||s;e({plugins:Array.isArray(t)?t:[],pluginsLoading:!1})}}catch(t){const s=t instanceof Error?t.message:"Failed to fetch project plugins";e({pluginsError:s,pluginsLoading:!1,plugins:[]})}},updatePlugin:async(s,a,n)=>{try{if(!await(0,h.getClient)().updateProjectPlugin(s,a,{enabled:n}))throw new Error("Failed to update plugin");{const s=t().plugins.map(e=>e.id===a?{...e,enabled:n}:e);e({plugins:s}),p.toast.success(`Plugin ${n?"enabled":"disabled"} successfully`)}}catch(e){const t=e instanceof Error?e.message:"Failed to update plugin";p.toast.error(t)}},fetchStats:async t=>{e({statsLoading:!0,statsError:null});try{const s=await(0,h.getClient)().getAgentStats(t);if(!s)throw new Error("Failed to fetch project stats");{const t=s.data||s;e({stats:t,statsLoading:!1})}}catch(t){const s=t instanceof Error?t.message:"Failed to fetch project stats";e({statsError:s,statsLoading:!1}),p.toast.error(s)}},reset:()=>{e({settings:null,settingsLoading:!1,settingsError:null,plugins:[],pluginsLoading:!1,pluginsError:null,stats:null,statsLoading:!1,statsError:null})}}));var C=s(25772);const N=(0,a.vt)((e,t)=>({licenses:[],loading:!1,error:null,fetchLicenses:async t=>{e({loading:!0,error:null});try{const s=(0,h.getClient)(),a=await s.getLicenses(t);C.v.info("LICENSES","API Response",{projectId:t,status:"success",responseType:typeof a,hasData:!!a?.data,dataType:Array.isArray(a?.data)?"array":typeof a?.data,dataLength:Array.isArray(a?.data)?a.data.length:0});const n=Array.isArray(a.data)?a.data:[];C.v.info("LICENSES","Processed licenses",{count:n.length,licenses:n.map(e=>({name:e.name,key:e.key?.substring(0,8)+"...",project_id:e.project_id}))}),e({licenses:n,loading:!1})}catch(s){C.v.error("LICENSES","Failed to fetch licenses",{projectId:t,errorType:s?.constructor?.name,errorMessage:s?.message,errorStatus:s?.status,errorCode:s?.code,responseText:s?.responseText||"No response text"});let a="Failed to fetch licenses";if(403===s?.status||s?.data?.message?.includes("not allowed"))throw a="",e({error:null,loading:!1,licenses:[]}),s;s?.message?.includes("Unexpected token")?a="API returned invalid response format. This may be a server configuration issue.":s instanceof Error&&(a=s.message),a&&e({error:a,loading:!1,licenses:[]})}},createLicense:async(t,s)=>{e({loading:!0,error:null}),C.v.info("LICENSES","Creating license",{projectId:t,name:s});try{const a=(0,h.getClient)(),n=await a.createLicense(t,{name:s});C.v.info("LICENSES","Create license API response",{projectId:t,name:s,status:"success",responseType:typeof n,hasData:!!n?.data,dataStructure:n?.data?Object.keys(n.data):[],licenseKey:n.data?.licenseKey?.substring(0,8)+"..."});const r=n.data?.license||n.data;return r&&(C.v.info("LICENSES","New license created",{licenseName:r.name,licenseKey:r.key?.substring(0,8)+"...",project_id:r.project_id}),e(e=>({licenses:[...e.licenses,r],loading:!1}))),r}catch(a){C.v.error("LICENSES","Failed to create license",{projectId:t,name:s,errorType:a?.constructor?.name,errorMessage:a?.message,errorStatus:a?.status,errorCode:a?.code,responseText:a?.responseText||"No response text"});let n="Failed to create license";throw a?.message?.includes("Unexpected token")?n="API returned invalid response format. This may be a server configuration issue.":a instanceof Error&&(n=a.message),e({error:n,loading:!1}),a}},updateLicense:async(t,s,a)=>{e({loading:!0,error:null});try{const n=(0,h.getClient)(),r=await n.updateLicense(t,s,{name:a});C.v.info("LICENSES","Updated license",{projectId:t,licenseId:s,name:a});(r.license||r.data)&&e(e=>({licenses:e.licenses.map(e=>e.key===s?{...e,name:a,updated_at:(new Date).toISOString()}:e),loading:!1}))}catch(t){C.v.error("LICENSES","Failed to update license",t);const s=t instanceof Error?t.message:"Failed to update license";throw e({error:s,loading:!1}),t}},deleteLicense:async(t,s)=>{e({loading:!0,error:null});try{const a=(0,h.getClient)();await a.deleteLicense(t,s),C.v.info("LICENSES","Deleted license",{projectId:t,licenseId:s}),e(e=>({licenses:e.licenses.filter(e=>e.key!==s),loading:!1}))}catch(t){C.v.error("LICENSES","Failed to delete license",t);const s=t instanceof Error?t.message:"Failed to delete license";throw e({error:s,loading:!1}),t}},clearError:()=>{e({error:null})}}));function A(){}function _(){}},60033:(e,t,s)=>{"use strict";s.d(t,{z:()=>h});var a=s(51110),n=s(29183);function r(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class i{constructor(e=1){r(this,"currentLOD",void 0),r(this,"frameCount",0),r(this,"lastPerformanceCheck",0),r(this,"performanceHistory",[]),r(this,"lodProfiles",{0:{level:0,particleReduction:0,effectsDisabled:!1,glowDisabled:!1,simplifiedRendering:!1,skipFrames:0},1:{level:1,particleReduction:.3,effectsDisabled:!1,glowDisabled:!0,simplifiedRendering:!1,skipFrames:1},2:{level:2,particleReduction:.6,effectsDisabled:!0,glowDisabled:!0,simplifiedRendering:!0,skipFrames:2}}),this.currentLOD=this.lodProfiles[e]}updateLOD(e){if(this.frameCount++,this.frameCount-this.lastPerformanceCheck>=30){this.performanceHistory.push(e.fps),this.performanceHistory.length>5&&this.performanceHistory.shift();const t=this.performanceHistory.reduce((e,t)=>e+t,0)/this.performanceHistory.length;this.adjustLODBasedOnFPS(t),this.lastPerformanceCheck=this.frameCount}return this.currentLOD}adjustLODBasedOnFPS(e){e<21&&this.currentLOD.level<2?this.currentLOD=this.lodProfiles[Math.min(2,this.currentLOD.level+1)]:e>36&&this.currentLOD.level>0&&(this.currentLOD=this.lodProfiles[Math.max(0,this.currentLOD.level-1)])}getCurrentLOD(){return this.currentLOD}shouldSkipFrame(){return this.currentLOD.skipFrames>0&&this.frameCount%(this.currentLOD.skipFrames+1)!==0}}class o{constructor(e,t,s=50){r(this,"bounds",void 0),r(this,"margin",50),this.margin=s,this.updateBounds(e,t)}updateBounds(e,t){this.bounds={left:-this.margin,right:e+this.margin,top:-this.margin,bottom:t+this.margin,near:-200,far:200}}isVisible(e,t,s=0,a=0){return e+a>=this.bounds.left&&e-a<=this.bounds.right&&t+a>=this.bounds.top&&t-a<=this.bounds.bottom&&(void 0===this.bounds.near||s>=this.bounds.near)&&(void 0===this.bounds.far||s<=this.bounds.far)}cullParticles(e){return e.filter(e=>this.isVisible(e.x,e.y,e.z||0,e.size||0))}getCullingStats(e){const t=this.cullParticles(e),s=e.length-t.length;return{total:e.length,visible:t.length,culled:s,cullingRatio:e.length>0?s/e.length:0}}}class c{constructor(){r(this,"batches",new Map),r(this,"maxBatchSize",1e3)}addToBatch(e,t,s,a,n,r=!1,i=!1){const o=`${e}_${r}_${i}`;this.batches.has(o)||this.batches.set(o,{color:e,particles:[],glowEnabled:r,effectsEnabled:i});const c=this.batches.get(o);c.particles.length<this.maxBatchSize&&c.particles.push({x:t,y:s,size:a,alpha:n})}renderBatches(e,t){Array.from(this.batches.entries()).forEach(([s,a])=>{if(0===a.particles.length)return;e.save(),e.fillStyle=a.color;const n=a.effectsEnabled&&!t.effectsDisabled,r=a.glowEnabled&&!t.glowDisabled;t.simplifiedRendering?this.renderSimplifiedBatch(e,a):this.renderFullBatch(e,a,n,r),e.restore()})}renderSimplifiedBatch(e,t){e.beginPath(),t.particles.forEach(t=>{e.globalAlpha=t.alpha,e.moveTo(t.x+t.size,t.y),e.arc(t.x,t.y,t.size,0,2*Math.PI)}),e.fill()}renderFullBatch(e,t,s,a){t.particles.forEach(s=>{if(e.save(),e.globalAlpha=s.alpha,a&&s.alpha>.5){const a=e.createRadialGradient(s.x,s.y,0,s.x,s.y,3*s.size);a.addColorStop(0,t.color),a.addColorStop(1,"transparent"),e.fillStyle=a,e.globalAlpha=.3*s.alpha,e.beginPath(),e.arc(s.x,s.y,3*s.size,0,2*Math.PI),e.fill()}e.globalAlpha=s.alpha,e.fillStyle=t.color,e.beginPath(),e.arc(s.x,s.y,s.size,0,2*Math.PI),e.fill(),e.restore()})}clearBatches(){Array.from(this.batches.values()).forEach(e=>{e.particles=[]})}getBatchStats(){const e=this.batches.size;let t=0,s=0;return Array.from(this.batches.values()).forEach(e=>{t+=e.particles.length,s=Math.max(s,e.particles.length)}),{batchCount:e,totalParticles:t,avgBatchSize:e>0?t/e:0,largestBatch:s}}}class l{constructor(){r(this,"lastGCTime",0),r(this,"gcInterval",1e4),r(this,"memoryPressureThreshold",.85)}checkMemoryPressure(){const e=performance.now();let t=0,s=!1;if("memory"in performance){const e=performance.memory;t=e.usedJSHeapSize/e.jsHeapSizeLimit,s=t>this.memoryPressureThreshold}return e-this.lastGCTime>this.gcInterval&&(s=!0,this.lastGCTime=e),{pressure:t,shouldCleanup:s}}getOptimizationSuggestions(e){return{reduceParticles:e>.7,clearCaches:e>.8,disableEffects:e>.75,simplifyRendering:e>.85}}}class d{constructor(e=30){r(this,"isVisible",!0),r(this,"targetFPS",30),r(this,"actualInterval",1e3/30),r(this,"lastFrameTime",0),r(this,"frameBudget",16.67),this.setTargetFPS(e),this.setupVisibilityHandling()}setTargetFPS(e){this.targetFPS=Math.max(10,Math.min(60,e)),this.actualInterval=1e3/this.targetFPS}shouldRenderFrame(){if(!this.isVisible)return!1;const e=performance.now();return e-this.lastFrameTime>=this.actualInterval&&(this.lastFrameTime=e,!0)}getFrameTiming(){return{targetFPS:this.targetFPS,interval:this.actualInterval,isVisible:this.isVisible,shouldThrottle:!this.isVisible||this.targetFPS<30}}setupVisibilityHandling(){document.addEventListener("visibilitychange",()=>{this.isVisible=!document.hidden,this.isVisible?this.setTargetFPS(30):this.setTargetFPS(10)}),window.addEventListener("focus",()=>{this.isVisible=!0,this.setTargetFPS(30)}),window.addEventListener("blur",()=>{this.setTargetFPS(20)})}}class u{constructor(e,t){r(this,"lodManager",void 0),r(this,"culler",void 0),r(this,"batchRenderer",void 0),r(this,"memoryOptimizer",void 0),r(this,"animationController",void 0),this.lodManager=new i,this.culler=new o(e,t),this.batchRenderer=new c,this.memoryOptimizer=new l,this.animationController=new d}update(e,t,s){const a=this.lodManager.updateLOD(e);t&&s&&this.culler.updateBounds(t,s);const{pressure:n,shouldCleanup:r}=this.memoryOptimizer.checkMemoryPressure(),i=this.animationController.shouldRenderFrame()&&!this.lodManager.shouldSkipFrame();return{lodSettings:a,shouldRender:i,memoryPressure:n,optimizationActive:a.level>0||n>.7||!i}}getManagers(){return{lod:this.lodManager,culler:this.culler,batchRenderer:this.batchRenderer,memory:this.memoryOptimizer,animation:this.animationController}}getPerformanceReport(){const{pressure:e,shouldCleanup:t}=this.memoryOptimizer.checkMemoryPressure();return{lod:this.lodManager.getCurrentLOD(),culling:{},batching:this.batchRenderer.getBatchStats(),memory:{pressure:e,shouldCleanup:t},animation:this.animationController.getFrameTiming()}}}var g=s(23847);function m(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class h{constructor(){m(this,"id",void 0),m(this,"name",void 0),m(this,"description",void 0),m(this,"category",void 0),m(this,"performanceProfile",void 0),m(this,"currentState",a.Y.IDLE),m(this,"targetState",a.Y.IDLE),m(this,"stateTransition",0),m(this,"stateTransitionSpeed",.1),m(this,"mouseX",0),m(this,"mouseY",0),m(this,"normalizedMouseX",0),m(this,"normalizedMouseY",0),m(this,"mouseInfluence",0),m(this,"targetMouseInfluence",0),m(this,"isHovering",!1),m(this,"context",null),m(this,"canvasWidth",0),m(this,"canvasHeight",0),m(this,"centerX",0),m(this,"centerY",0),m(this,"performanceMonitor",void 0),m(this,"performanceManager",null),m(this,"performanceSettings",void 0),m(this,"currentLODSettings",null),m(this,"lastFrameTime",0),m(this,"animationTime",0),m(this,"deltaTimeAccumulator",0),this.performanceMonitor=new n.r3,this.performanceSettings={targetFPS:30,maxParticles:100,enableEffects:!0,enableGlow:!1,qualityLevel:"medium"},this.initializePerformanceCallbacks()}init(e,t,s){this.context=e,this.updateDimensions(t,s),this.initializePerformanceManager(),this.setupPerformanceSettings(),this.onInit()}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t,this.centerX=e/2,this.centerY=t/2,this.performanceManager&&this.performanceManager.getManagers().culler.updateBounds(e,t)}draw(e,t,s,a,n,r){const i=this.performanceMonitor.update();if(this.performanceManager){const e=this.performanceManager.update(i,t,s);if(this.currentLODSettings=e.lodSettings,!e.shouldRender)return}this.canvasWidth===t&&this.canvasHeight===s||this.updateDimensions(t,s),this.updateTiming(r),this.updateStateTransition(),this.updateMouseInfluence(),this.clearCanvas(e,t,s),this.onDraw(e,t,s,a,n,r),this.shouldShowPerformanceOverlay()&&this.drawPerformanceOverlay(e,i)}onUserSpeaking(){this.setTargetState(a.Y.USER_SPEAKING),this.onStateChange(a.Y.USER_SPEAKING)}onProcessing(){this.setTargetState(a.Y.PROCESSING),this.onStateChange(a.Y.PROCESSING)}onAiSpeaking(){this.setTargetState(a.Y.AI_SPEAKING),this.onStateChange(a.Y.AI_SPEAKING)}reset(){this.setTargetState(a.Y.IDLE),this.onStateChange(a.Y.IDLE),this.onReset()}setMousePosition(e,t,s,a){this.mouseX=e,this.mouseY=t,this.normalizedMouseX=e/s*2-1,this.normalizedMouseY=t/a*2-1,this.targetMouseInfluence=this.isHovering?1:.3,this.onMouseMove(e,t,this.normalizedMouseX,this.normalizedMouseY)}setHovering(e){this.isHovering=e,this.targetMouseInfluence=e?1:0,this.onHoverChange(e)}dispose(){this.onDispose()}getPerformanceMetrics(){return{...this.performanceMonitor.getCurrentMetrics(),...this.getThemeSpecificMetrics()}}onInit(){}onStateChange(e){}onReset(){}onMouseMove(e,t,s,a){}onHoverChange(e){}onDispose(){}getThemeSpecificMetrics(){return{}}clearCanvas(e,t,s){e.clearRect(0,0,t,s)}async setupPerformanceSettings(){try{const e=n.L.getInstance(),t=await e.detectCapabilities();"low"===t.performanceLevel||t.isLowPowerDevice?this.performanceSettings={targetFPS:24,maxParticles:this.getOptimalParticleCount("low"),enableEffects:!1,enableGlow:!1,qualityLevel:"low"}:"medium"===t.performanceLevel?this.performanceSettings={targetFPS:30,maxParticles:this.getOptimalParticleCount("medium"),enableEffects:!0,enableGlow:!1,qualityLevel:"medium"}:this.performanceSettings={targetFPS:60,maxParticles:this.getOptimalParticleCount("high"),enableEffects:!0,enableGlow:!0,qualityLevel:"high"}}catch(e){}}initializePerformanceManager(){this.performanceManager=new u(this.canvasWidth,this.canvasHeight)}getOptimalParticleCount(e){return{light:{low:30,medium:80,high:150},medium:{low:50,medium:120,high:250},heavy:{low:20,medium:60,high:120}}[this.performanceProfile][e]}initializePerformanceCallbacks(){this.performanceMonitor.setCallbacks({onPerformanceWarning:e=>{this.adjustPerformanceSettings(.8)},onPerformanceCritical:e=>{this.adjustPerformanceSettings(.6)}})}adjustPerformanceSettings(e){this.performanceSettings.maxParticles=Math.floor(this.performanceSettings.maxParticles*e),this.performanceSettings.enableEffects=!1,this.performanceSettings.enableGlow=!1}setTargetState(e){this.targetState!==e&&(this.targetState=e,this.stateTransition=0)}updateStateTransition(){this.currentState!==this.targetState&&(this.stateTransition+=this.stateTransitionSpeed,this.stateTransition>=1&&(this.currentState=this.targetState,this.stateTransition=1))}updateMouseInfluence(){this.mouseInfluence=(0,g.Cc)(this.mouseInfluence,this.targetMouseInfluence,.1)}updateTiming(e){this.deltaTimeAccumulator+=e,this.animationTime+=e}shouldShowPerformanceOverlay(){return!1}drawPerformanceOverlay(e,t){e.save(),e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(10,10,200,80),e.fillStyle="white",e.font="12px monospace",e.fillText(`Theme: ${this.name}`,15,25),e.fillText(`FPS: ${Math.round(t.fps)}`,15,40),e.fillText(`Frame: ${Math.round(t.frameTime)}ms`,15,55),e.fillText(`State: ${this.currentState}`,15,70),e.fillText(`Mouse: ${Math.round(100*this.mouseInfluence)}%`,15,85),e.restore()}getStateColor(e,t){return 0===this.stateTransition?e:(this.stateTransition,t)}getMouseInfluencedValue(e,t){return(0,g.Cc)(e,t,this.mouseInfluence)}shouldEnableEffects(){return this.currentLODSettings?!this.currentLODSettings.effectsDisabled:this.performanceSettings.enableEffects}shouldEnableGlow(){return this.currentLODSettings?!this.currentLODSettings.glowDisabled:this.performanceSettings.enableGlow}getMaxParticles(){const e=this.performanceSettings.maxParticles;return this.currentLODSettings?Math.floor(e*(1-this.currentLODSettings.particleReduction)):e}getCurrentLODLevel(){return this.currentLODSettings?.level||1}shouldUseSimplifiedRendering(){return this.currentLODSettings?.simplifiedRendering||!1}getPerformanceManagers(){return this.performanceManager?.getManagers()||null}isParticleVisible(e,t,s=0,a=0){const n=this.getPerformanceManagers();return!n?.culler||n.culler.isVisible(e,t,s,a)}cullParticles(e){const t=this.getPerformanceManagers();return t?.culler?t.culler.cullParticles(e):e}addToBatch(e,t,s,a,n,r=!1,i=!1){const o=this.getPerformanceManagers();o?.batchRenderer&&o.batchRenderer.addToBatch(e,t,s,a,n,r,i)}renderBatches(e){const t=this.getPerformanceManagers();t?.batchRenderer&&this.currentLODSettings&&(t.batchRenderer.renderBatches(e,this.currentLODSettings),t.batchRenderer.clearBatches())}}},70396:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=70396,e.exports=t},72781:(e,t,s)=>{"use strict";s.d(t,{default:()=>Rs});var a=s(99576),n=s(30758),r=s(92221),i=s(59033),o=s(31681),c=s(17047),l=s(79400),d=s(39014),u=s(88080),g=s(93498),m=s(90578),h=s(54347),p=s(98589),f=s(5368),x=s(12012),v=s(80846),y=s(86070);const b=(0,v.F)("relative inline-flex items-center justify-center font-medium transition-all duration-200 ease-out focus-visible:outline-none disabled:opacity-50 disabled:cursor-not-allowed disabled:pointer-events-none transform-gpu active:scale-[0.98]",{variants:{variant:{default:["bg-primary text-primary-foreground shadow-sm","hover:bg-primary-hover hover:shadow-md hover:scale-[1.02]","focus-visible:ring-2 focus-visible:ring-primary/50 focus-visible:ring-offset-2","active:bg-primary-active","transition-all duration-200"].join(" "),destructive:["bg-destructive text-destructive-foreground shadow-sm","hover:bg-destructive/90 hover:shadow-md hover:scale-[1.02]","focus-visible:ring-2 focus-visible:ring-destructive/50 focus-visible:ring-offset-2","active:bg-destructive/80"].join(" "),outline:["border border-input bg-background/50 backdrop-blur-sm","hover:bg-accent hover:text-accent-foreground hover:border-accent","focus-visible:ring-2 focus-visible:ring-accent/50 focus-visible:ring-offset-2","transition-all duration-200"].join(" "),secondary:["bg-secondary text-secondary-foreground","hover:bg-secondary/80 hover:shadow-sm","focus-visible:ring-2 focus-visible:ring-secondary/50 focus-visible:ring-offset-2"].join(" "),ghost:["hover:bg-accent hover:text-accent-foreground","focus-visible:ring-2 focus-visible:ring-accent/50 focus-visible:ring-offset-2","data-[state=open]:bg-accent data-[state=open]:text-accent-foreground"].join(" "),link:["text-primary underline-offset-4 hover:underline","focus-visible:ring-2 focus-visible:ring-primary/50 focus-visible:ring-offset-2","hover:text-primary-hover"].join(" "),premium:["bg-gradient-to-r from-primary to-primary-hover text-primary-foreground","shadow-md hover:shadow-lg hover:scale-[1.02]","focus-visible:ring-2 focus-visible:ring-primary/50 focus-visible:ring-offset-2","before:absolute before:inset-0 before:bg-white/20 before:opacity-0","hover:before:opacity-100 before:transition-opacity before:duration-200","overflow-hidden"].join(" ")},size:{default:"h-10 rounded-lg px-4 py-2 text-sm",sm:"h-8 rounded-md px-3 text-xs",lg:"h-12 rounded-lg px-8 text-base",xl:"h-14 rounded-xl px-10 text-lg",icon:"h-10 w-10 rounded-lg","icon-sm":"h-8 w-8 rounded-md","icon-lg":"h-12 w-12 rounded-lg"}},defaultVariants:{variant:"default",size:"default"}}),w=n.forwardRef(({className:e,variant:t,size:s,asChild:a=!1,loading:r=!1,loadingText:i,children:o,disabled:l,onClick:d,...u},g)=>{const[m,h]=n.useState([]),p=n.useCallback(e=>{if(r||l)return;const t=e.currentTarget.getBoundingClientRect(),s=e.clientX-t.left,a=e.clientY-t.top,n=Date.now();h(e=>[...e,{x:s,y:a,id:n}]),setTimeout(()=>{h(e=>e.filter(e=>e.id!==n))},600),d?.(e)},[r,l,d]);return(0,y.jsxs)("button",{className:(0,c.cn)(b({variant:t,size:s,className:e}),"relative overflow-hidden",r&&"cursor-wait"),ref:g,disabled:r||l,onClick:p,...u,children:[m.map(e=>(0,y.jsx)("span",{className:"absolute pointer-events-none",style:{left:e.x,top:e.y,transform:"translate(-50%, -50%)"},children:(0,y.jsx)("span",{className:"block animate-ripple rounded-full bg-white/30 dark:bg-white/20",style:{width:0,height:0,animation:"ripple-expand 0.6s ease-out forwards"}})},e.id)),r&&(0,y.jsx)("span",{className:"absolute inset-0 flex items-center justify-center bg-inherit",children:(0,y.jsxs)("svg",{className:"animate-spin h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,y.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,y.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),(0,y.jsx)("span",{className:(0,c.cn)("relative z-10 inline-flex items-center",r&&"opacity-0"),children:o}),r&&i&&(0,y.jsx)("span",{className:"absolute inset-0 flex items-center justify-center",children:(0,y.jsx)("span",{className:"ml-6",children:i})})]})});w.displayName="Button";var S=s(98637);const j={xs:{container:"w-4 h-4",icon:"w-2 h-2"},sm:{container:"w-6 h-6",icon:"w-3 h-3"},md:{container:"w-8 h-8",icon:"w-4 h-4"},lg:{container:"w-10 h-10",icon:"w-5 h-5"},xl:{container:"w-12 h-12",icon:"w-6 h-6"}},C={circle:"rounded-full",rounded:"rounded-lg",square:"rounded-none"},N=({agent:e,src:t,alt:s,size:a="md",shape:r="circle",fallback:o="bot",isSelected:l=!1,className:d})=>{const[u,g]=n.useState(!1),m=t||e?.settings?.chatbot_avatar,h=s||(e?.project_name?`${e.project_name} avatar`:"Avatar"),p=j[a],f=C[r],x=l?"bg-primary shadow-md":"bg-muted hover:bg-accent transition-all duration-200";n.useEffect(()=>{g(!1)},[m]);return(0,y.jsxs)("div",{className:(0,c.cn)("relative flex items-center justify-center flex-shrink-0 overflow-hidden","ring-2 ring-transparent","hover:ring-primary/20 hover:scale-105","transition-all duration-200",l&&"ring-primary ring-offset-2 ring-offset-background",p.container,f,x,d),children:[m&&!u?(0,y.jsx)("img",{src:m,alt:h,className:"w-full h-full object-cover",onError:()=>{g(!0)},loading:"lazy"}):(()=>{if("none"===o)return null;const e=(0,c.cn)(p.icon,l?"text-primary-foreground":"text-muted-foreground");return"user"===o?(0,y.jsx)(S.A,{className:e}):(0,y.jsx)(i.A,{className:e})})(),l&&(0,y.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 h-3 w-3 rounded-full bg-success border-2 border-background"})]})},A=({agent:e,size:t="md",isSelected:s=!1,className:a})=>(0,y.jsx)(N,{agent:e,size:t,shape:"circle",fallback:"bot",isSelected:s,alt:e?.project_name?`${e.project_name} avatar`:"Agent avatar",className:a}),_=({src:e,size:t="md",className:s})=>(0,y.jsx)(N,{src:e,size:t,shape:"circle",fallback:"user",alt:"User avatar",className:s});var I=s(9716),k=s(41912),E=s(49666),P=s(44712);const T=({citation:e,index:t,isExpanded:s,onToggle:a,onClick:n,onPreviewClick:i})=>(0,y.jsxs)("div",{className:"border border-border rounded-lg overflow-hidden transition-all hover:border-border/80",children:[(0,y.jsxs)("button",{onClick:a,className:"w-full px-3 py-2 flex items-center gap-3 hover:bg-accent transition-colors text-left",children:[(0,y.jsx)("div",{className:"flex-shrink-0 w-6 h-6 rounded bg-brand-100 flex items-center justify-center",children:(0,y.jsx)("span",{className:"text-xs font-medium text-brand-700",children:t})}),(0,y.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,y.jsx)("div",{className:"font-medium text-sm text-foreground line-clamp-1",children:e.title}),(0,y.jsx)("div",{className:"text-xs text-muted-foreground line-clamp-1",children:e.source||e.url})]}),(0,y.jsx)(k.A,{className:(0,c.cn)("w-4 h-4 text-muted-foreground transition-transform flex-shrink-0",s&&"rotate-180")})]}),(0,y.jsx)(I.N,{children:s&&(0,y.jsx)(r.P.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"overflow-hidden",children:(0,y.jsxs)("div",{className:"px-3 py-2 border-t border-border bg-accent",children:[(0,y.jsx)("p",{className:"text-sm text-foreground mb-2",children:e.content}),(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[e.url&&(0,y.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 text-xs text-brand-600 hover:text-brand-700 transition-colors",children:["View source",(0,y.jsx)(m.A,{className:"w-3 h-3"})]}),n&&(0,y.jsx)(w,{size:"sm",variant:"ghost",onClick:()=>n(e),className:"h-6 px-2 text-xs",children:"View details"}),i&&(0,y.jsxs)(w,{size:"sm",variant:"ghost",onClick:()=>i(e),className:"h-6 px-2 text-xs",children:[(0,y.jsx)(E.A,{className:"w-3 h-3 mr-1"}),"Preview file"]})]})]})})})]}),M=({citations:e,onCitationClick:t,onPreviewClick:s,maxVisible:a=5,className:i})=>{const[o,l]=(0,n.useState)(new Set),[d,u]=(0,n.useState)(!1),g=d?e:e.slice(0,a),m=e.length>a;return 0===e.length?null:(0,y.jsxs)("div",{className:(0,c.cn)("mt-4 space-y-2",i),children:[(0,y.jsxs)("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[(0,y.jsx)(P.A,{className:"w-4 h-4"}),(0,y.jsx)("span",{className:"font-medium",children:"Sources"}),(0,y.jsxs)("span",{className:"text-muted-foreground",children:["(",e.length,")"]}),m&&(0,y.jsx)(w,{size:"sm",variant:"ghost",onClick:()=>u(!d),className:"ml-auto h-6 px-2 text-xs",children:d?"Show less":`Show all ${e.length}`})]}),(0,y.jsx)("div",{className:"space-y-2",children:(0,y.jsx)(I.N,{children:g.map((e,a)=>(0,y.jsx)(r.P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.2,delay:.05*a},children:(0,y.jsx)(T,{citation:e,index:a+1,isExpanded:o.has(e.id),onToggle:()=>(e=>{const t=new Set(o);o.has(e)?t.delete(e):t.add(e),l(t)})(e.id),onClick:t,onPreviewClick:s})},e.id))})}),m&&!d&&(0,y.jsx)("div",{className:"pt-2",children:(0,y.jsxs)(w,{size:"sm",variant:"outline",onClick:()=>u(!0),className:"w-full",children:["Show ",e.length-a," more sources"]})})]})};var F=s(30710),O=s(96509);const D=({details:e,className:t})=>{const[s,a]=(0,n.useState)(!1);if(!e)return null;const i=async e=>{await(0,c.lW)(e)&&o.toast.success("Value copied to clipboard")};return(0,y.jsxs)("div",{className:(0,c.cn)("mt-2",t),children:[(0,y.jsxs)("button",{onClick:()=>a(!s),className:"flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors",children:[(0,y.jsx)(F.A,{className:"w-3 h-3"}),(0,y.jsx)("span",{children:"More Details"}),s?(0,y.jsx)(O.A,{className:"w-3 h-3"}):(0,y.jsx)(k.A,{className:"w-3 h-3"})]}),(0,y.jsx)(I.N,{children:s&&(0,y.jsx)(r.P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"overflow-hidden",children:(0,y.jsxs)("div",{className:"mt-2 p-3 bg-accent rounded-lg border border-border",children:[(0,y.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,y.jsx)("h4",{className:"text-xs font-semibold text-foreground",children:"Message Details"}),(0,y.jsxs)(w,{size:"sm",variant:"ghost",onClick:async()=>{const t=JSON.stringify(e,null,2);await(0,c.lW)(t)&&o.toast.success("Details copied to clipboard")},className:"h-6 px-2 text-xs",children:[(0,y.jsx)(h.A,{className:"w-3 h-3 mr-1"}),"Copy All"]})]}),(0,y.jsxs)("div",{className:"space-y-2",children:[void 0!==e.user_id&&(0,y.jsx)($,{label:"User ID",value:String(e.user_id),onCopy:i}),void 0!==e.conversation_id&&(0,y.jsx)($,{label:"Conversation ID",value:String(e.conversation_id),onCopy:i}),e.updated_at&&(0,y.jsx)($,{label:"Updated At",value:new Date(e.updated_at).toLocaleString(),onCopy:i}),e.metadata&&(0,y.jsxs)("div",{className:"mt-3 pt-2 border-t border-border",children:[(0,y.jsx)("h5",{className:"text-xs font-semibold text-muted-foreground mb-2",children:"Metadata"}),e.metadata.user_ip&&(0,y.jsx)($,{label:"User IP",value:e.metadata.user_ip,onCopy:i}),e.metadata.user_agent&&(0,y.jsx)($,{label:"User Agent",value:e.metadata.user_agent,onCopy:i,truncate:!0}),e.metadata.external_id&&(0,y.jsx)($,{label:"External ID",value:e.metadata.external_id,onCopy:i}),e.metadata.request_source&&(0,y.jsx)($,{label:"Request Source",value:e.metadata.request_source,onCopy:i})]})]})]})})})]})},$=({label:e,value:t,onCopy:s,truncate:a})=>(0,y.jsxs)("div",{className:"flex items-start justify-between gap-2 text-xs",children:[(0,y.jsxs)("span",{className:"text-muted-foreground font-medium whitespace-nowrap",children:[e,":"]}),(0,y.jsxs)("div",{className:"flex items-center gap-1 flex-1 min-w-0",children:[(0,y.jsx)("span",{className:(0,c.cn)("text-foreground break-all",a&&"truncate"),title:a?t:void 0,children:t}),(0,y.jsx)("button",{onClick:()=>s(t),className:"p-1 text-muted-foreground hover:text-foreground transition-colors flex-shrink-0",title:"Copy value",children:(0,y.jsx)(h.A,{className:"w-3 h-3"})})]})]});var R=s(91582),L=s(7648);const z=({language:e,value:t})=>{const[s,a]=(0,n.useState)(!1);return(0,y.jsxs)("div",{className:"relative group",children:[(0,y.jsx)("div",{className:"absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,y.jsx)(w,{size:"sm",variant:"ghost",onClick:async()=>{await(0,c.lW)(t)&&(a(!0),o.toast.success("Code copied to clipboard"),setTimeout(()=>a(!1),2e3))},className:"h-6 px-2 text-xs bg-foreground text-background hover:bg-foreground/90",children:s?"Copied!":"Copy"})}),(0,y.jsx)(u.A,{language:e,style:g.A,customStyle:{margin:0,borderRadius:"0.5rem",fontSize:"0.875rem"},children:t})]})},q=()=>(0,y.jsx)("span",{className:"inline-block w-0.5 h-4 bg-foreground animate-blink ml-0.5 align-middle"}),U=({content:e,isStreaming:t})=>{const s=e.replace(/<CONTEXT>|<\/CONTEXT>/g,"").trim();return(0,y.jsxs)("div",{className:"prose prose-sm max-w-none text-foreground",children:[(0,y.jsx)(l.oz,{remarkPlugins:[d.A],components:{code({className:e,children:t,...s}){const a=/language-(\w+)/.exec(e||"");return!!a&&a?(0,y.jsx)(z,{language:a[1],value:String(t).replace(/\n$/,""),...s}):(0,y.jsx)("code",{className:"px-1 py-0.5 rounded bg-muted text-sm font-medium",...s,children:t})},a:({href:e,children:t})=>(0,y.jsxs)("a",{href:e,target:"_blank",rel:"noopener noreferrer",className:"text-brand-600 hover:text-brand-700 no-underline hover:underline inline-flex items-center gap-1",children:[t,(0,y.jsx)(m.A,{className:"w-3 h-3"})]})},children:s}),t&&(0,y.jsx)(q,{})]})},G=({message:e,onFeedback:t,isLastAssistant:s=!1})=>{const[a,r]=(0,n.useState)(e.feedback||null),i=e=>{r(e),t?.(e),o.toast.success("Thanks for your feedback!")},l=(0,R.o)(e=>e.regenerateLastResponse);return(0,y.jsxs)("div",{className:"mt-3 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:async()=>{await(0,c.lW)(e.content)&&o.toast.success("Message copied to clipboard")},className:"h-8 w-8 text-muted-foreground hover:text-foreground",title:"Copy message",children:(0,y.jsx)(h.A,{className:"h-4 w-4"})}),(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:()=>i("like"),className:(0,c.cn)("h-8 w-8 text-muted-foreground hover:text-foreground","like"===a&&"text-success hover:text-success/90"),title:"Good response",children:(0,y.jsx)(p.A,{className:"h-4 w-4"})}),(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:()=>i("dislike"),className:(0,c.cn)("h-8 w-8 text-muted-foreground hover:text-foreground","dislike"===a&&"text-destructive hover:text-destructive/90"),title:"Bad response",children:(0,y.jsx)(f.A,{className:"h-4 w-4"})}),s&&(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:async()=>{try{await l()}catch(e){}},className:"h-8 w-8 text-muted-foreground hover:text-foreground",title:"Regenerate response",children:(0,y.jsx)(x.A,{className:"h-4 w-4"})})]})},B=({message:e,agent:t,isStreaming:s=!1,isLast:a=!1,onCitationClick:n,onPreviewClick:i,onFeedback:o,mode:l="standalone",className:d})=>{const u="user"===e.role,g=(0,R.o)(e=>{const t=L.w.getState().currentConversation;return t?e.getMessagesForConversation(t.id.toString()):[]}),m=!u&&g.length>0&&"assistant"===g[g.length-1].role&&g[g.length-1].id===e.id;return(0,y.jsx)(r.P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:(0,c.cn)("group relative px-4 py-6 transition-colors",u?"bg-background":"bg-muted border-y border-border","hover:bg-opacity-80",d),children:(0,y.jsxs)("div",{className:"max-w-3xl mx-auto flex gap-4",children:[(0,y.jsx)("div",{className:"flex-shrink-0",children:u?(0,y.jsx)(_,{size:"md",className:"bg-secondary"}):(0,y.jsx)(A,{agent:t,size:"md",className:"bg-background border border-border"})}),(0,y.jsxs)("div",{className:"flex-1 overflow-hidden",children:[e.status&&"sent"!==e.status&&(0,y.jsxs)("div",{className:"mb-2 text-xs text-muted-foreground",children:["sending"===e.status&&"Sending...","error"===e.status&&(0,y.jsx)("span",{className:"text-red-500",children:"Failed to send"})]}),u?(0,y.jsx)("p",{className:"text-foreground whitespace-pre-wrap",children:e.content}):(0,y.jsx)(U,{content:e.content,isStreaming:s}),"standalone"===l&&e.citations&&e.citations.length>0&&(0,y.jsx)(M,{citations:e.citations,onCitationClick:n,onPreviewClick:i}),(0,y.jsx)("div",{className:"mt-2 text-xs text-muted-foreground",children:(0,c.Ey)(e.timestamp)}),(0,y.jsx)(D,{details:e.details}),!u&&!s&&(0,y.jsx)(G,{message:e,onFeedback:o,isLastAssistant:m})]})]})})};var V=s(2698),K=s(10999),H=s(22020),J=s(25476),Y=s(72923),W=s(6384),X=s(80871),Q=s(8077),Z=s(29715),ee=s(98635),te=s(67052),se=s(98831);const ae=(0,n.createContext)({isRuntimeDemoMode:!1,deploymentMode:null,isInitialized:!1,isFreeTrialMode:!1}),ne=()=>{const e=(0,n.useContext)(ae);if(!e)throw new Error("useDemoModeContext must be used within DemoModeProvider");return e};var re=s(62158);const ie=({size:e="md",className:t,label:s="Loading..."})=>{const a={sm:"h-4 w-4",md:"h-6 w-6",lg:"h-8 w-8",xl:"h-12 w-12"};return(0,y.jsxs)("div",{className:"relative inline-flex",children:[(0,y.jsx)(re.A,{className:(0,c.cn)("animate-spin text-primary transition-all duration-200",a[e],t),"aria-label":s}),(0,y.jsx)("div",{className:(0,c.cn)("absolute inset-0 animate-pulse rounded-full bg-primary/20 blur-xl",a[e])})]})},oe=({className:e,animate:t=!0})=>(0,y.jsx)("div",{className:(0,c.cn)("relative overflow-hidden rounded-lg bg-muted",t&&"shimmer",e),children:t&&(0,y.jsx)("div",{className:"absolute inset-0 -translate-x-full animate-[shimmer_2s_infinite] bg-gradient-to-r from-transparent via-white/10 to-transparent"})}),ce=({visible:e,message:t,blur:s=!0,className:a})=>e?(0,y.jsx)("div",{className:(0,c.cn)("absolute inset-0 z-50 flex items-center justify-center","bg-background/60 transition-all duration-300",s&&"backdrop-blur-md","animate-in fade-in-0 duration-200",a),children:(0,y.jsxs)("div",{className:(0,c.cn)("flex flex-col items-center space-y-4 p-6","bg-background/90 backdrop-blur-sm","rounded-xl border border-border/50","shadow-xl","animate-in zoom-in-95 duration-300"),children:[(0,y.jsx)(ie,{size:"lg"}),t&&(0,y.jsx)("p",{className:"text-sm text-muted-foreground font-medium",children:t})]})}):null,le=({isAssistant:e=!1,lines:t=3})=>(0,y.jsxs)("div",{className:(0,c.cn)("flex gap-3 p-4",e?"bg-muted":"bg-background"),children:[(0,y.jsx)(oe,{className:"h-8 w-8 rounded-full flex-shrink-0"}),(0,y.jsx)("div",{className:"flex-1 space-y-2",children:Array.from({length:t}).map((e,s)=>(0,y.jsx)(oe,{className:(0,c.cn)("h-4",s===t-1?"w-3/4":"w-full")},s))})]}),de=({count:e=3})=>(0,y.jsx)("div",{className:"space-y-2 p-2",children:Array.from({length:e}).map((e,t)=>(0,y.jsxs)("div",{className:"p-3 rounded-lg",children:[(0,y.jsx)(oe,{className:"h-4 w-3/4 mb-2"}),(0,y.jsx)(oe,{className:"h-3 w-1/2"})]},t))});var ue=s(59347),ge=s(45063),me=s(6048);const he=me.Kq,pe=me.bL,fe=me.l9,xe=n.forwardRef(({className:e,sideOffset:t=6,...s},a)=>(0,y.jsx)(me.ZL,{children:(0,y.jsxs)(me.UC,{ref:a,sideOffset:t,className:(0,c.cn)("z-50 overflow-hidden","rounded-lg px-3.5 py-2","bg-gray-900 dark:bg-gray-100 backdrop-blur-sm","text-xs font-medium text-white dark:text-gray-900","shadow-lg shadow-black/20","border border-gray-800 dark:border-gray-200","animate-in fade-in-0 zoom-in-95","data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95","data-[side=bottom]:slide-in-from-top-2","data-[side=left]:slide-in-from-right-2","data-[side=right]:slide-in-from-left-2","data-[side=top]:slide-in-from-bottom-2",e),...s,children:[s.children,(0,y.jsx)(me.i3,{className:"fill-gray-900 dark:fill-gray-100",width:8,height:4})]})}));function ve({onTranscription:e,onTranscriptionStart:t,onTranscriptionEnd:s,disabled:a=!1,isMobile:r=!1,className:i}){const[l,d]=(0,n.useState)(!1),[u,g]=(0,n.useState)(!1),[m,h]=(0,n.useState)(0),p=(0,n.useRef)(null),f=(0,n.useRef)([]),x=(0,n.useRef)(null),v=(0,n.useRef)(null),b=(0,n.useCallback)(()=>{p.current&&"recording"===p.current.state&&(p.current.stop(),d(!1),x.current&&(clearTimeout(x.current),x.current=null),v.current&&(clearInterval(v.current),v.current=null),h(0))},[]),S=(0,n.useCallback)(async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:!0}),s=MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/mp4",a=new MediaRecorder(e,{mimeType:s});p.current=a,f.current=[],a.ondataavailable=e=>{e.data.size>0&&f.current.push(e.data)},a.onstop=async()=>{const t=new Blob(f.current,{type:s});e.getTracks().forEach(e=>e.stop()),await j(t)},a.start(),d(!0),t?.();const n=Date.now();v.current=setInterval(()=>{const e=Math.floor((Date.now()-n)/1e3);h(e)},100),x.current=setTimeout(()=>{b(),o.toast.info("Recording stopped after 30 seconds")},3e4)}catch(e){o.toast.error("Unable to access microphone. Please check your permissions."),s?.()}},[b,t,s]),j=async t=>{g(!0);try{const s=new FileReader;s.readAsDataURL(t),s.onloadend=async()=>{const a=s.result.split(",")[1],n={"Content-Type":"application/json"},r=localStorage.getItem("customgpt.deploymentMode")||"production";n["X-Deployment-Mode"]=r,"demo"===r&&window.__demoOpenAIKey&&(n["X-OpenAI-API-Key"]=window.__demoOpenAIKey);const i=await fetch("/api/proxy/voice/transcribe",{method:"POST",headers:n,body:JSON.stringify({audio:a,mimeType:t.type})});if(!i.ok){const e=await i.json().catch(()=>({error:"Transcription failed"}));if(500===i.status&&e.error&&e.error.includes("OpenAI API key"))throw o.toast.error(e.error),new Error("OpenAI API key not configured");throw new Error(e.error||"Transcription failed")}const c=await i.json();if(!c.text)throw new Error("No transcription received");e(c.text),o.toast.success("Speech transcribed successfully")},s.onerror=()=>{throw new Error("Failed to process audio")}}catch(e){e instanceof Error&&"OpenAI API key not configured"===e.message||(e instanceof Error&&e.message?o.toast.error(e.message):o.toast.error("Failed to transcribe speech. Please try again."))}finally{g(!1),s?.()}},C=l||u,N=e=>`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`;return(0,y.jsx)(he,{children:(0,y.jsxs)(pe,{children:[(0,y.jsx)(fe,{asChild:!0,children:(0,y.jsx)(w,{type:"button",size:"icon",variant:"ghost",onClick:()=>{l?b():S()},disabled:a||u,className:(0,c.cn)("relative text-muted-foreground hover:text-foreground transition-all",C&&"text-red-600 hover:text-red-700",l&&"animate-pulse bg-red-50 hover:bg-red-100",i),children:u?(0,y.jsxs)("div",{className:"relative",children:[(0,y.jsx)(re.A,{className:(0,c.cn)("animate-spin","h-5 w-5")}),(0,y.jsx)("span",{className:"absolute -bottom-5 left-1/2 -translate-x-1/2 text-[10px] text-muted-foreground whitespace-nowrap",children:"Processing..."})]}):l?(0,y.jsxs)("div",{className:"relative",children:[(0,y.jsx)("div",{className:"absolute inset-0 bg-red-500 rounded-full animate-ping opacity-25"}),(0,y.jsx)(ue.A,{className:(0,c.cn)("relative z-10","h-5 w-5")}),m>0&&(0,y.jsx)("span",{className:"absolute -bottom-5 left-1/2 -translate-x-1/2 text-[10px] text-red-600 font-medium whitespace-nowrap",children:N(m)})]}):(0,y.jsx)(ge.A,{className:(0,c.cn)("h-5 w-5")})})}),(0,y.jsx)(xe,{children:(0,y.jsx)("p",{children:u?"Processing your speech...":l?`Recording... ${N(m)}`:"Click to start speech-to-text"})})]})})}function ye({className:e,isActive:t=!1,size:s="md"}){const a={sm:["h-2","h-3","h-2.5","h-3","h-2"],md:["h-3","h-4","h-3.5","h-4","h-3"],lg:["h-3.5","h-5","h-4.5","h-5","h-3.5"]},n="sm"===s?a.sm:"md"===s?a.md:a.lg;return(0,y.jsx)("div",{className:(0,c.cn)("flex items-center justify-center",{sm:"w-5 h-5",md:"w-6 h-6",lg:"w-7 h-7"}[s],e),style:{gap:"2px"},children:n.map((e,a)=>(0,y.jsx)("div",{className:(0,c.cn)("rounded-full transition-all duration-300",e,t&&"animate-voice-pulse"),style:{width:"lg"===s?"3px":"md"===s?"2.5px":"2px",animationDelay:t?100*a+"ms":"0ms",background:t?`linear-gradient(to top, \n                  hsl(${260+20*a}, 85%, 55%), \n                  hsl(${320+20*a}, 85%, 65%))`:`linear-gradient(to top,\n                  hsl(${260+15*a}, 80%, 55%),\n                  hsl(${280+15*a}, 80%, 65%))`}},a))})}xe.displayName=me.UC.displayName;var be=s(93613),we=s(53216),Se=s(50908),je=s(922);const Ce=be.bL,Ne=be.l9;be.YJ,be.ZL,be.Pb,be.z6;n.forwardRef(({className:e,inset:t,children:s,...a},n)=>(0,y.jsxs)(be.ZP,{ref:n,className:(0,c.cn)("flex cursor-pointer select-none items-center","rounded-md px-3 py-2 text-sm outline-none","transition-all duration-200","hover:bg-accent/80 hover:text-accent-foreground","focus:bg-accent focus:text-accent-foreground","data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",t&&"pl-8",e),...a,children:[s,(0,y.jsx)(we.A,{className:"ml-auto h-4 w-4 transition-transform duration-200 data-[state=open]:rotate-90"})]})).displayName=be.ZP.displayName;n.forwardRef(({className:e,...t},s)=>(0,y.jsx)(be.G5,{ref:s,className:(0,c.cn)("z-50 min-w-[8rem] overflow-hidden","rounded-lg border border-gray-200/50 dark:border-gray-800/30","bg-background/95 backdrop-blur-md","p-1.5 text-foreground","shadow-lg shadow-black/10","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95","data-[side=bottom]:slide-in-from-top-2","data-[side=left]:slide-in-from-right-2","data-[side=right]:slide-in-from-left-2","data-[side=top]:slide-in-from-bottom-2",e),...t})).displayName=be.G5.displayName;const Ae=n.forwardRef(({className:e,sideOffset:t=6,...s},a)=>(0,y.jsx)(be.ZL,{children:(0,y.jsx)(be.UC,{ref:a,sideOffset:t,className:(0,c.cn)("z-50 min-w-[8rem] overflow-hidden","rounded-lg border border-gray-200/50 dark:border-gray-800/30","bg-background/95 backdrop-blur-md","p-1.5 text-foreground","shadow-lg shadow-black/10","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95","data-[side=bottom]:slide-in-from-top-2","data-[side=left]:slide-in-from-right-2","data-[side=right]:slide-in-from-left-2","data-[side=top]:slide-in-from-bottom-2",e),...s})}));Ae.displayName=be.UC.displayName;const _e=n.forwardRef(({className:e,inset:t,...s},a)=>(0,y.jsx)(be.q7,{ref:a,className:(0,c.cn)("relative flex cursor-pointer select-none items-center","rounded-md px-3 py-2 text-sm outline-none","transition-all duration-200","hover:bg-accent/80 hover:text-accent-foreground hover:scale-[0.98]","focus:bg-accent focus:text-accent-foreground","data-[disabled]:pointer-events-none data-[disabled]:opacity-50","active:scale-[0.96]",t&&"pl-8",e),...s}));_e.displayName=be.q7.displayName;n.forwardRef(({className:e,children:t,checked:s,...a},n)=>(0,y.jsxs)(be.H_,{ref:n,className:(0,c.cn)("relative flex cursor-pointer select-none items-center","rounded-md py-2 pl-8 pr-3 text-sm outline-none","transition-all duration-200","hover:bg-accent/80 hover:text-accent-foreground","focus:bg-accent focus:text-accent-foreground","data-[disabled]:pointer-events-none data-[disabled]:opacity-50",e),checked:s,...a,children:[(0,y.jsx)("span",{className:"absolute left-2 flex h-4 w-4 items-center justify-center",children:(0,y.jsx)(be.VF,{children:(0,y.jsx)(Se.A,{className:"h-3.5 w-3.5 animate-in zoom-in-0 duration-200"})})}),t]})).displayName=be.H_.displayName;n.forwardRef(({className:e,children:t,...s},a)=>(0,y.jsxs)(be.hN,{ref:a,className:(0,c.cn)("relative flex cursor-pointer select-none items-center","rounded-md py-2 pl-8 pr-3 text-sm outline-none","transition-all duration-200","hover:bg-accent/80 hover:text-accent-foreground","focus:bg-accent focus:text-accent-foreground","data-[disabled]:pointer-events-none data-[disabled]:opacity-50",e),...s,children:[(0,y.jsx)("span",{className:"absolute left-2 flex h-4 w-4 items-center justify-center",children:(0,y.jsx)(be.VF,{children:(0,y.jsx)(je.A,{className:"h-2.5 w-2.5 fill-current animate-in zoom-in-0 duration-200"})})}),t]})).displayName=be.hN.displayName;const Ie=n.forwardRef(({className:e,inset:t,...s},a)=>(0,y.jsx)(be.JU,{ref:a,className:(0,c.cn)("px-3 py-2 text-xs font-semibold","text-muted-foreground uppercase tracking-wider",t&&"pl-8",e),...s}));Ie.displayName=be.JU.displayName;const ke=n.forwardRef(({className:e,...t},s)=>(0,y.jsx)(be.wv,{ref:s,className:(0,c.cn)("-mx-1.5 my-1.5 h-px","bg-gradient-to-r from-transparent via-gray-200/50 dark:via-gray-800/20 to-transparent",e),...t}));ke.displayName=be.wv.displayName;var Ee=s(27292),Pe=s(86e3),Te=s(90040);const Me=({file:e,onRemove:t})=>{const s=(0,c.I3)(e.type);return(0,y.jsxs)(r.P.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},className:"flex items-center gap-2 px-3 py-1.5 bg-muted hover:bg-accent rounded-lg transition-colors",children:[(0,y.jsx)("div",{className:"text-muted-foreground",children:s}),(0,y.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,y.jsx)("div",{className:"text-sm font-medium text-foreground truncate",children:e.name}),(0,y.jsxs)("div",{className:"text-xs text-muted-foreground flex items-center gap-2",children:[(0,y.jsx)("span",{children:(0,c.v7)(e.size)}),"uploading"===e.status&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)("span",{children:"â€¢"}),(0,y.jsxs)("span",{children:[e.progress,"%"]})]}),"error"===e.status&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)("span",{children:"â€¢"}),(0,y.jsxs)("span",{className:"text-destructive flex items-center gap-1",children:[(0,y.jsx)(K.A,{className:"w-3 h-3"}),"Error"]})]})]})]}),"uploading"===e.status&&(0,y.jsx)("div",{className:"absolute bottom-0 left-0 right-0 h-0.5 bg-muted rounded-b",children:(0,y.jsx)("div",{className:"h-full bg-brand-500 rounded-b transition-all duration-300",style:{width:`${e.progress}%`}})}),(0,y.jsx)("button",{onClick:t,className:"p-0.5 rounded hover:bg-accent-foreground/20 transition-colors",disabled:"uploading"===e.status,children:(0,y.jsx)(H.A,{className:"w-3 h-3 text-muted-foreground"})})]})},Fe=({onUpload:e,disabled:t,isMobile:s=!1})=>{const a=(0,n.useRef)(null);return(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)("input",{ref:a,type:"file",multiple:!0,accept:c.aH.ACCEPTED_FILE_TYPES.join(","),onChange:t=>{const s=Array.from(t.target.files||[]);s.length>0&&(e(s),t.target.value="")},className:"hidden"}),(0,y.jsx)(w,{type:"button",size:"icon",variant:"ghost",onClick:()=>{a.current?.click()},disabled:t,className:(0,c.cn)("text-muted-foreground hover:text-foreground relative z-10",s?"h-10 w-10 min-w-[40px]":"h-9 w-9"),title:"Upload files",children:(0,y.jsx)(J.A,{className:(0,c.cn)(s?"h-5 w-5":"h-4 w-4")})})]})},Oe=[{value:"own_content",label:"Content",description:"Uses only your uploaded content",icon:Y.A},{value:"openai_content",label:"AI + Content",description:"Combines AI knowledge with your content",icon:W.A},{value:"default",label:"Default",description:"Uses the default agent setting",icon:X.A}],De=[{value:"gpt-4-o",label:"GPT-4",description:"Most capable model",icon:W.A,capabilities:["optimal-choice","advanced-reasoning","complex-tasks"]},{value:"gpt-4-1",label:"GPT-4.1",description:"Latest GPT-4 version",icon:Q.A,capabilities:["optimal-choice","advanced-reasoning","complex-tasks"]},{value:"gpt-4o-mini",label:"GPT-4 Mini",description:"Faster, good for most tasks",icon:Z.A,capabilities:["fastest-responses","optimal-choice"]},{value:"gpt-4-1-mini",label:"GPT-4.1 Mini",description:"Fast and efficient",icon:Z.A,capabilities:["fastest-responses","optimal-choice"]},{value:"claude-3-sonnet",label:"Claude 3",description:"Balanced performance",icon:W.A,capabilities:["optimal-choice","advanced-reasoning"]},{value:"claude-3.5-sonnet",label:"Claude 3.5",description:"Advanced reasoning",icon:Q.A,capabilities:["optimal-choice","advanced-reasoning","complex-tasks"]}],$e=[{value:"professional",label:"Professional",description:"Formal responses",icon:i.A},{value:"friendly",label:"Friendly",description:"Conversational tone",icon:S.A},{value:"technical",label:"Technical",description:"Technical explanations",icon:W.A},{value:"creative",label:"Creative",description:"Imaginative responses",icon:Q.A},{value:"educator",label:"Teacher",description:"Step-by-step guidance",icon:i.A},{value:"custom",label:"Custom",description:"Your own instructions",icon:X.A}],Re=[{value:"fastest-responses",label:"Fastest",description:"Quick answers",icon:Z.A,enterprise:!0},{value:"optimal-choice",label:"Optimal",description:"Balanced",icon:X.A,enterprise:!1},{value:"advanced-reasoning",label:"Advanced",description:"Complex tasks",icon:W.A,enterprise:!0},{value:"complex-tasks",label:"Complex Reasoning",description:"Highest quality",icon:Q.A,enterprise:!0}],Le=({onSend:e,disabled:t=!1,placeholder:s="Send a message...",maxLength:a=c.aH.MAX_MESSAGE_LENGTH,className:i,onVoiceClick:l,isMobile:d=!1,mode:u="standalone"})=>{const[g,m]=(0,n.useState)(""),[h,p]=(0,n.useState)([]),[f,x]=(0,n.useState)(!1),[v,b]=(0,n.useState)(!1),[j,C]=(0,n.useState)(!1),N=(0,n.useRef)(null),{isFreeTrialMode:A}=ne(),{currentAgent:_}=(0,Ee.o)(),{getSettings:E,updateSettings:P}=(0,Pe.w)(),T=_?.id?E(_.id):{response_source:"own_content",chatbot_model:"gpt-4-o",custom_persona:"professional",agent_capability:"optimal-choice"},M=(0,n.useCallback)(async()=>{if(_?.id)try{const e=(0,Te.getClient)(),t=await e.getAgentSettings(_.id);if(t?.data){const e={response_source:t.data.response_source||"own_content",chatbot_model:t.data.chatbot_model||"gpt-4-o",custom_persona:t.data.custom_persona||"professional",agent_capability:t.data.agent_capability||"optimal-choice"};P(_.id,e)}}catch(e){}},[_?.id,P]);(0,n.useEffect)(()=>{_?.id&&M()},[_?.id,M]);const F=async(e,t)=>{if(_?.id){b(!0);try{const s=(0,Te.getClient)();let a={[e]:t};if("agent_capability"===e){const e=De.filter(e=>e.capabilities.includes(t));!e.some(e=>e.value===T.chatbot_model)&&e.length>0&&(a.chatbot_model=e[0].value,o.toast.info(`Model changed to ${e[0].label} for ${Re.find(e=>e.value===t)?.label} mode`))}await s.updateAgentSettings(_.id,a),P(_.id,a),o.toast.success("Setting updated successfully")}catch(e){o.toast.error("Failed to update setting")}finally{b(!1)}}},O=(0,n.useCallback)(()=>{const e=N.current;if(e){e.style.height="auto";const t=e.scrollHeight,s=200;e.style.height=`${Math.min(t,s)}px`}},[]),D=s=>{if(s.preventDefault(),t)return;if(!g.trim()&&0===h.length)return;const a=h.filter(e=>"uploaded"===e.status).map(e=>e.file);e(g.trim(),a),m(""),p([]),N.current&&(N.current.style.height="auto"),setTimeout(()=>{N.current?.focus()},0)},$=(0,n.useCallback)(e=>{const t=e.filter(e=>e.size>c.aH.MAX_FILE_SIZE?(o.toast.error(`File "${e.name}" is too large. Maximum size is ${(0,c.v7)(c.aH.MAX_FILE_SIZE)}`),!1):!!(0,c.B6)(e.type,c.aH.ACCEPTED_FILE_TYPES)||(o.toast.error(`File type "${e.type}" is not supported`),!1)).map(e=>({id:(0,c.$C)(),name:e.name,size:e.size,type:e.type,status:"uploading",progress:0,file:e}));p(e=>[...e,...t]),t.forEach(e=>{R(e)})},[]),R=e=>{let t=0;const s=setInterval(()=>{t+=20*Math.random(),t>=100?(t=100,clearInterval(s),p(t=>t.map(t=>t.id===e.id?{...t,status:"uploaded",progress:100}:t))):p(s=>s.map(s=>s.id===e.id?{...s,progress:Math.round(t)}:s))},100)},{getRootProps:L,getInputProps:z,isDragActive:q}=(0,V.VB)({onDrop:$,noClick:!0,noKeyboard:!0,accept:c.aH.ACCEPTED_FILE_TYPES.reduce((e,t)=>(e[t]=[],e),{}),maxSize:c.aH.MAX_FILE_SIZE}),U=!t&&(g.trim()||h.some(e=>"uploaded"===e.status)),G=(0,n.useCallback)(e=>{m(t=>{const s=t?`${t} ${e}`:e;return s.length<=a?s:t}),setTimeout(()=>{O()},0)},[a,O]),B=(0,n.useCallback)(()=>{x(!0)},[]),K=(0,n.useCallback)(()=>{x(!1)},[]);return(0,y.jsxs)("div",{...L(),className:(0,c.cn)("relative",q&&"bg-brand-50",i),children:[(0,y.jsx)("input",{...z()}),(0,y.jsx)(I.N,{children:q&&(0,y.jsx)(r.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-brand-50 border-2 border-dashed border-brand-300 rounded-lg flex items-center justify-center z-10",children:(0,y.jsxs)("div",{className:"text-center",children:[(0,y.jsx)(ee.A,{className:"w-8 h-8 text-brand-600 mx-auto mb-2"}),(0,y.jsx)("p",{className:"text-brand-700 font-medium",children:"Drop files here to upload"}),(0,y.jsx)("p",{className:"text-brand-600 text-sm",children:"Supports PDF, DOC, TXT, and more"})]})})}),(0,y.jsx)(I.N,{children:h.length>0&&(0,y.jsx)(r.P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"px-4 pt-3 pb-2 flex flex-wrap gap-2",children:h.map(e=>(0,y.jsx)(Me,{file:e,onRemove:()=>{return t=e.id,void p(e=>e.filter(e=>e.id!==t));var t}},e.id))})}),(0,y.jsxs)("div",{className:(0,c.cn)("mx-4 my-3 bg-background border border-border rounded-2xl shadow-sm","focus-within:ring-2 focus-within:ring-brand-500 focus-within:border-transparent transition-all"),children:[(0,y.jsx)("form",{onSubmit:D,className:"relative",children:(0,y.jsxs)("div",{className:"flex items-center p-3 pb-1",children:[!A&&"standalone"===u&&(0,y.jsx)(Fe,{onUpload:$,disabled:t,isMobile:d}),"standalone"===u&&(0,y.jsx)(ve,{onTranscription:G,onTranscriptionStart:B,onTranscriptionEnd:K,disabled:t,isMobile:d,className:(0,c.cn)("!h-8 !w-8 !min-w-0 mr-2",d&&"!h-9 !w-9")}),(0,y.jsxs)("div",{className:"flex-1 relative",children:[(0,y.jsx)("textarea",{ref:N,value:g,onChange:e=>{const t=e.target.value;t.length<=a&&(m(t),O())},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),D(e))},placeholder:f?"":s,disabled:t,rows:1,className:(0,c.cn)("w-full resize-none bg-transparent border-0","focus:outline-none focus:ring-0","disabled:opacity-50 disabled:cursor-not-allowed","placeholder:text-muted-foreground text-foreground",d?"text-base min-h-[24px] max-h-[120px] placeholder:text-sm":"text-sm min-h-[20px] max-h-[200px]"),style:{height:"auto",overflowY:g.split("\n").length>5?"auto":"hidden"}}),f&&!g&&(0,y.jsx)("div",{className:"absolute top-0 left-0 right-0 bottom-0 flex items-center pointer-events-none",children:(0,y.jsxs)("span",{className:(0,c.cn)("text-muted-foreground animate-pulse",d?"text-base":"text-sm"),children:["Transcribing",(0,y.jsxs)("span",{className:"inline-flex",children:[(0,y.jsx)("span",{className:"animate-bounce",style:{animationDelay:"0ms"},children:"."}),(0,y.jsx)("span",{className:"animate-bounce",style:{animationDelay:"150ms"},children:"."}),(0,y.jsx)("span",{className:"animate-bounce",style:{animationDelay:"300ms"},children:"."})]})]})})]}),g.length>0&&(0,y.jsxs)("div",{className:(0,c.cn)("text-xs text-muted-foreground mr-2","text-xs"),children:[g.length,"/",a]}),(0,y.jsxs)("div",{className:"flex items-center gap-1",children:[l&&"standalone"===u&&(0,y.jsxs)(w,{type:"button",size:"icon",variant:"ghost",onClick:l,disabled:t,className:(0,c.cn)("relative group transition-all duration-200","bg-gradient-to-br from-purple-500/10 to-pink-500/10","hover:from-purple-500/20 hover:to-pink-500/20","border border-purple-500/20 hover:border-purple-500/40","shadow-sm hover:shadow-md",d?"h-10 w-10":"h-9 w-9"),title:"Voice mode",children:[(0,y.jsx)("div",{className:"absolute inset-0 rounded-md bg-gradient-to-br from-purple-600/5 to-pink-600/5 opacity-0 group-hover:opacity-100 transition-opacity"}),(0,y.jsx)(ye,{size:d?"lg":"md",isActive:!1,className:"relative z-10"})]}),(0,y.jsx)(w,{type:"submit",size:"icon",disabled:!U,className:(0,c.cn)("transition-all duration-200 group","bg-brand-500 hover:bg-brand-600 active:bg-brand-700","text-white shadow-sm hover:shadow-md","disabled:opacity-50 disabled:cursor-not-allowed","disabled:hover:bg-brand-500 disabled:hover:shadow-sm",d?"h-10 w-10":"h-9 w-9"),title:t?"Sending message...":"Send message",children:t?(0,y.jsx)(ie,{size:"sm",className:"text-white"}):(0,y.jsx)(te.A,{className:(0,c.cn)("transition-transform duration-200 group-hover:translate-x-0.5 group-hover:-translate-y-0.5",d?"h-5 w-5":"h-4 w-4")})})]})]})}),"standalone"===u&&(0,y.jsxs)("div",{className:"border-t border-gray-200/50 dark:border-gray-800/30",children:[(0,y.jsxs)(w,{variant:"ghost",size:"sm",onClick:()=>C(!j),className:(0,c.cn)("flex items-center gap-2 text-xs",d?"w-full justify-center h-9 px-3 py-2":"w-auto justify-start h-8 px-3 py-1.5","hover:bg-accent/50 transition-all duration-200",j&&"bg-accent/30"),title:"Customize chat settings including response source, AI model, and persona",children:[(0,y.jsx)(se.A,{className:(0,c.cn)("transition-colors",j?"text-brand-500":"text-muted-foreground",d?"h-4 w-4":"h-3.5 w-3.5")}),(0,y.jsx)("span",{className:(0,c.cn)("font-medium text-muted-foreground",j&&"text-brand-600"),children:"Customize Chat"}),(0,y.jsx)(k.A,{className:(0,c.cn)("h-3 w-3 opacity-50 transition-transform duration-200",j&&"rotate-180")})]}),(0,y.jsx)(I.N,{children:j&&(0,y.jsx)(r.P.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"overflow-hidden bg-accent/20",children:(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center border-t border-gray-200/50 dark:border-gray-800/30",d?"justify-between px-2 pb-2 pt-2":"gap-2 px-3 pb-2.5 pt-2.5"),children:[(0,y.jsxs)(Ce,{children:[(0,y.jsx)(Ne,{asChild:!0,children:(0,y.jsxs)(w,{variant:"ghost",size:"sm",className:(0,c.cn)("text-xs flex items-center justify-center",d?"h-8 flex-1 gap-4 px-1":"h-7 px-2.5 gap-1.5"),disabled:v,children:[(0,y.jsx)(Y.A,{className:(0,c.cn)("text-muted-foreground",d?"h-3 w-3":"h-3.5 w-3.5")}),(0,y.jsx)("span",{className:"font-medium text-muted-foreground",children:"Source"}),!d&&(0,y.jsx)(k.A,{className:"h-3 w-3 opacity-50"})]})}),(0,y.jsxs)(Ae,{align:"start",className:"w-64",children:[(0,y.jsx)(Ie,{className:"text-xs",children:"RESPONSE SOURCE"}),(0,y.jsx)(ke,{}),Oe.map(e=>{const t=e.icon;return(0,y.jsxs)(_e,{onClick:()=>F("response_source",e.value),className:"flex flex-col items-start py-1.5",children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(t,{className:"h-3.5 w-3.5"}),(0,y.jsx)("span",{className:"text-sm font-medium",children:e.label}),T.response_source===e.value&&(0,y.jsx)("span",{className:"text-xs text-brand-600",children:"âœ“"})]}),(0,y.jsx)("span",{className:"text-xs text-muted-foreground ml-5",children:e.description})]},e.value)})]})]}),(0,y.jsxs)(Ce,{children:[(0,y.jsx)(Ne,{asChild:!0,children:(0,y.jsxs)(w,{variant:"ghost",size:"sm",className:(0,c.cn)("text-xs flex items-center justify-center",d?"h-8 flex-1 gap-2 px-1":"h-7 px-2.5 gap-1.5"),disabled:v,children:[(0,y.jsx)(W.A,{className:(0,c.cn)("text-muted-foreground",d?"h-3 w-3":"h-3.5 w-3.5")}),(0,y.jsx)("span",{className:"font-medium text-muted-foreground",children:"Model"}),!d&&(0,y.jsx)(k.A,{className:"h-3 w-3 opacity-50"})]})}),(0,y.jsxs)(Ae,{align:"center",className:"w-72",children:[(0,y.jsx)(Ie,{className:"text-xs",children:"AI MODEL"}),(0,y.jsx)(ke,{}),De.filter(e=>T.agent_capability&&e.capabilities.includes(T.agent_capability)).map(e=>{const t=e.icon;return(0,y.jsxs)(_e,{onClick:()=>F("chatbot_model",e.value),className:"flex flex-col items-start py-1.5",children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(t,{className:"h-3.5 w-3.5"}),(0,y.jsx)("span",{className:"text-sm font-medium",children:e.label}),T.chatbot_model===e.value&&(0,y.jsx)("span",{className:"text-xs text-brand-600",children:"âœ“"})]}),(0,y.jsx)("span",{className:"text-xs text-muted-foreground ml-5",children:e.description})]},e.value)})]})]}),(0,y.jsxs)(Ce,{children:[(0,y.jsx)(Ne,{asChild:!0,children:(0,y.jsxs)(w,{variant:"ghost",size:"sm",className:(0,c.cn)("text-xs flex items-center justify-center",d?"h-8 flex-1 gap-2 px-1":"h-7 px-2.5 gap-1.5"),disabled:v,children:[(0,y.jsx)(S.A,{className:(0,c.cn)("text-muted-foreground",d?"h-3 w-3":"h-3.5 w-3.5")}),(0,y.jsx)("span",{className:"font-medium text-muted-foreground",children:"Persona"}),!d&&(0,y.jsx)(k.A,{className:"h-3 w-3 opacity-50"})]})}),(0,y.jsxs)(Ae,{align:"center",className:"w-64",children:[(0,y.jsx)(Ie,{className:"text-xs",children:"ASSISTANT PERSONA"}),(0,y.jsx)(ke,{}),$e.map(e=>{const t=e.icon;return(0,y.jsxs)(_e,{onClick:()=>F("custom_persona",e.value),className:"flex flex-col items-start py-1.5",children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(t,{className:"h-3.5 w-3.5"}),(0,y.jsx)("span",{className:"text-sm font-medium",children:e.label}),T.custom_persona===e.value&&(0,y.jsx)("span",{className:"text-xs text-brand-600",children:"âœ“"})]}),(0,y.jsx)("span",{className:"text-xs text-muted-foreground ml-5",children:e.description})]},e.value)})]})]}),(0,y.jsxs)(Ce,{children:[(0,y.jsx)(Ne,{asChild:!0,children:(0,y.jsxs)(w,{variant:"ghost",size:"sm",className:(0,c.cn)("text-xs flex items-center justify-center",d?"h-8 flex-1 gap-2 px-1":"h-7 px-2.5 gap-1.5"),disabled:v,children:[(0,y.jsx)(X.A,{className:(0,c.cn)("text-muted-foreground",d?"h-3 w-3":"h-3.5 w-3.5")}),(0,y.jsx)("span",{className:"font-medium text-muted-foreground",children:"Mode"}),!d&&(0,y.jsx)(k.A,{className:"h-3 w-3 opacity-50"})]})}),(0,y.jsxs)(Ae,{align:"end",className:"w-72",children:[(0,y.jsx)(Ie,{className:"text-xs",children:"RESPONSE MODE"}),(0,y.jsx)(ke,{}),Re.map(e=>{const t=e.icon;return(0,y.jsxs)(_e,{onClick:()=>F("agent_capability",e.value),className:"flex flex-col items-start py-1.5",children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(t,{className:"h-3.5 w-3.5"}),(0,y.jsx)("span",{className:"text-sm font-medium",children:e.label}),e.enterprise&&(0,y.jsx)("span",{className:"text-[10px] bg-muted text-muted-foreground px-1 py-0.5 rounded",children:"Enterprise only"}),T.agent_capability===e.value&&(0,y.jsx)("span",{className:"text-xs text-brand-600",children:"âœ“"})]}),(0,y.jsx)("span",{className:"text-xs text-muted-foreground ml-5",children:e.description})]},e.value)})]})]})]})})})]})]}),!d&&(0,y.jsx)("div",{className:"px-4 pb-3 text-xs text-muted-foreground",children:(0,y.jsx)("span",{children:"Press Enter to send, Shift+Enter for new line"})})]})},ze=({className:e})=>(0,y.jsx)("div",{className:(0,c.cn)("px-4 py-6 bg-muted border-y border-border",e),children:(0,y.jsxs)("div",{className:"max-w-3xl mx-auto flex gap-4",children:[(0,y.jsx)("div",{className:"w-8 h-8 rounded-full bg-background border border-border flex items-center justify-center flex-shrink-0",children:(0,y.jsx)(i.A,{className:"w-4 h-4 text-brand-600"})}),(0,y.jsxs)("div",{className:"flex items-center gap-1 py-2",children:[(0,y.jsx)("div",{className:"w-2 h-2 bg-muted-foreground rounded-full animate-bounce-subtle"}),(0,y.jsx)("div",{className:"w-2 h-2 bg-muted-foreground rounded-full animate-bounce-subtle delay-100"}),(0,y.jsx)("div",{className:"w-2 h-2 bg-muted-foreground rounded-full animate-bounce-subtle delay-200"})]})]})});var qe=s(85294),Ue=s(1216),Ge=s(51276);const Be=({agent:e,size:t="md",isSelected:s=!1,className:a})=>{const n={sm:"w-3 h-3",md:"w-4 h-4"},r=e?.settings?.chatbot_avatar;return(0,y.jsx)("div",{className:(0,c.cn)("rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden",{sm:"w-6 h-6",md:"w-8 h-8"}[t],s?"bg-brand-600":"bg-accent",a),children:r?(0,y.jsx)("img",{src:r,alt:`${e?.project_name} avatar`,className:"w-full h-full object-cover",onError:e=>{const a=e.target;a.style.display="none";const r=a.parentElement;if(r){const e=document.createElement("div");e.className="w-full h-full flex items-center justify-center",e.innerHTML=`<svg class="${n[t]} ${s?"text-white":"text-gray-600"}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`,r.appendChild(e)}}}):(0,y.jsx)(S.A,{className:(0,c.cn)(n[t],s?"text-white":"text-muted-foreground")})})},Ve=({agent:e,isSelected:t,onSelect:s,onSettingsClick:a})=>(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center justify-between p-3 rounded-lg cursor-pointer transition-colors group","hover:bg-accent",t&&"bg-brand-50 hover:bg-brand-100"),onClick:()=>s(e),children:[(0,y.jsxs)("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[(0,y.jsx)(Be,{agent:e,size:"md",isSelected:t}),(0,y.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)("h3",{className:"font-medium text-foreground truncate",children:e.project_name}),t&&(0,y.jsx)(Se.A,{className:"w-4 h-4 text-brand-600 flex-shrink-0"})]}),(0,y.jsx)("div",{className:"mt-1 text-xs text-muted-foreground",children:(0,y.jsxs)("span",{children:["Status: ",e.is_chat_active?"Active":"Inactive"]})})]})]}),a&&(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:t=>{t.stopPropagation(),a(e)},className:"opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 text-muted-foreground hover:text-foreground",title:"Agent Settings",children:(0,y.jsx)(X.A,{className:"h-3 w-3"})})]}),Ke=({className:e,showSettings:t=!0,onSettingsClick:s})=>{const[a,l]=(0,n.useState)(!1),[d,u]=(0,n.useState)(!1),[g,m]=(0,n.useState)(new Set),h=(0,n.useRef)(null),{agents:p,currentAgent:f,loading:x,error:v,fetchAgents:b,loadMoreAgents:S,selectAgent:j,setAgents:C,paginationMeta:N}=(0,Ge.useAgentStore)(),A=async e=>{const t=e.filter(e=>!e.settings&&!g.has(e.id));if(0!==t.length){m(e=>{const s=new Set(e);return t.forEach(e=>s.add(e.id)),s});try{const e=(0,Te.getClient)(),s=t.map(async t=>{try{const s=await e.getAgentSettings(t.id);return{agentId:t.id,settings:s.data||s}}catch(e){return{agentId:t.id,settings:null}}}),a=await Promise.all(s),n=p.map(e=>{const t=a.find(t=>t.agentId===e.id);return t&&t.settings?{...e,settings:t.settings}:e});C(n)}catch(e){}finally{m(e=>{const s=new Set(e);return t.forEach(e=>s.delete(e.id)),s})}}};(0,n.useEffect)(()=>{const e=e=>{h.current&&!h.current.contains(e.target)&&l(!1)};if(a)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[a]);const _=async()=>{try{await b(),o.toast.success("Agents refreshed")}catch(e){o.toast.error("Failed to refresh agents")}},E=async e=>{if(!d){u(!0);try{await j(e),l(!1),o.toast.success(`Switched to ${e.project_name}`)}catch(e){o.toast.error("Failed to switch agent")}finally{setTimeout(()=>{u(!1)},300)}}};(0,n.useEffect)(()=>{if(a&&p.length>0){p.some(e=>!e.settings)&&A(p)}},[a,p.length,p,A]);return x&&0===p.length?(0,y.jsx)("div",{className:(0,c.cn)("p-3 bg-background border border-border rounded-lg",e),children:(0,y.jsxs)("div",{className:"flex items-center gap-3",children:[(0,y.jsx)("div",{className:"w-8 h-8 rounded-full bg-muted animate-pulse"}),(0,y.jsxs)("div",{className:"flex-1",children:[(0,y.jsx)("div",{className:"h-4 bg-muted rounded animate-pulse mb-2"}),(0,y.jsx)("div",{className:"h-3 bg-muted/50 rounded animate-pulse w-3/4"})]})]})}):v&&0===p.length?(0,y.jsx)("div",{className:(0,c.cn)("p-3 bg-background border border-border rounded-lg",e),children:(0,y.jsxs)("div",{className:"flex items-center gap-3",children:[(0,y.jsx)("div",{className:"w-8 h-8 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0",children:(0,y.jsx)(K.A,{className:"w-4 h-4 text-red-600"})}),(0,y.jsxs)("div",{className:"flex-1",children:[(0,y.jsx)("p",{className:"text-sm text-red-600 font-medium",children:"Failed to load agents"}),(0,y.jsx)("p",{className:"text-xs text-red-500",children:v})]}),(0,y.jsx)(w,{size:"sm",variant:"ghost",onClick:_,className:"text-red-600 hover:text-red-700",children:(0,y.jsx)(qe.A,{className:"w-4 h-4"})})]})}):f||0!==p.length?(0,y.jsxs)("div",{className:(0,c.cn)("relative",e),ref:h,children:[d&&(0,y.jsx)("div",{className:"absolute inset-0 bg-background/80 backdrop-blur-sm rounded-lg flex items-center justify-center z-50",children:(0,y.jsxs)("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[(0,y.jsx)(ie,{size:"sm"}),(0,y.jsx)("span",{className:"text-foreground",children:"Switching agent..."})]})}),(0,y.jsx)("button",{onClick:async()=>{const e=!a;if(l(e),e&&0===p.length)try{await b()}catch(e){}},className:(0,c.cn)("w-full p-3 bg-background border border-border rounded-lg text-left transition-colors","hover:bg-accent focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent",a&&"ring-2 ring-ring border-transparent"),children:(0,y.jsxs)("div",{className:"flex items-center justify-between",children:[(0,y.jsxs)("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[(0,y.jsx)(Be,{agent:f,size:"md",isSelected:!0}),(0,y.jsx)("div",{className:"flex-1 min-w-0",children:(0,y.jsx)("h3",{className:"font-medium text-foreground truncate",children:f?.project_name||"Select Agent"})})]}),(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[f&&(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:e=>{e.stopPropagation(),window.location.href=`/projects?id=${f.id}&tab=analytics`},title:"View Analytics",className:"text-muted-foreground hover:text-foreground",children:(0,y.jsx)(Ue.A,{className:"w-4 h-4"})}),(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:e=>{e.stopPropagation(),_()},disabled:x,className:"h-6 w-6 text-muted-foreground hover:text-foreground",title:"Refresh Agents",children:(0,y.jsx)(qe.A,{className:(0,c.cn)("h-3 w-3",x&&"animate-spin")})}),(0,y.jsx)(k.A,{className:(0,c.cn)("w-4 h-4 text-muted-foreground transition-transform",a&&"rotate-180")})]})]})}),(0,y.jsx)(I.N,{children:a&&(0,y.jsx)(r.P.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.2},className:"absolute top-full left-0 right-0 mt-2 bg-background border border-border rounded-lg shadow-lg z-50 max-h-80 overflow-y-auto",children:(0,y.jsxs)("div",{className:"p-2",children:[(0,y.jsx)("div",{className:"px-2 py-1 mb-2",children:(0,y.jsxs)("h4",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wide",children:["Available Agents (",Array.isArray(p)?p.length:0,N?.totalCount&&N.totalCount!==p.length&&(0,y.jsxs)("span",{children:[" of ",N.totalCount]}),")"]})}),(0,y.jsx)("div",{className:"space-y-1",children:Array.isArray(p)&&p.length>0?p.map(e=>(0,y.jsx)(Ve,{agent:e,isSelected:f?.id===e.id,onSelect:E,onSettingsClick:t?s:void 0},e.id)):(0,y.jsxs)("div",{className:"px-2 py-4 text-center",children:[(0,y.jsx)("p",{className:"text-sm text-muted-foreground",children:"No agents found"}),(0,y.jsxs)(w,{size:"sm",variant:"ghost",onClick:_,className:"mt-2",children:[(0,y.jsx)(qe.A,{className:"w-4 h-4 mr-2"}),"Refresh"]})]})}),Array.isArray(p)&&p.length>0&&N?.hasMore&&(0,y.jsx)("div",{className:"px-2 py-2 border-t",children:(0,y.jsx)(w,{size:"sm",variant:"ghost",onClick:async()=>{try{await S()}catch(e){}},disabled:x,className:"w-full",children:x?(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(qe.A,{className:"w-4 h-4 mr-2 animate-spin"}),"Loading..."]}):(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(k.A,{className:"w-4 h-4 mr-2"}),"Load More Agents"]})})})]})})})]}):(0,y.jsx)("div",{className:(0,c.cn)("p-3 bg-background border border-border rounded-lg",e),children:(0,y.jsxs)("div",{className:"flex items-center gap-3",children:[(0,y.jsx)("div",{className:"w-8 h-8 rounded-full bg-accent flex items-center justify-center flex-shrink-0",children:(0,y.jsx)(i.A,{className:"w-4 h-4 text-muted-foreground"})}),(0,y.jsxs)("div",{className:"flex-1",children:[(0,y.jsx)("p",{className:"text-sm text-muted-foreground font-medium",children:"No agents available"}),(0,y.jsx)("p",{className:"text-xs text-muted-foreground",children:"Check your API configuration"})]}),(0,y.jsx)(w,{size:"sm",variant:"ghost",onClick:_,disabled:x,children:(0,y.jsx)(qe.A,{className:(0,c.cn)("w-4 h-4",x&&"animate-spin")})})]})})};var He=s(63373),Je=s(36069),Ye=s(47973),We=s(25772);const Xe=e=>{const[t,s]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{if("undefined"==typeof window)return;const t=window.matchMedia(e);s(t.matches);const a=e=>{s(e.matches)};return t.addEventListener("change",a),()=>t.removeEventListener("change",a)},[e]),t},Qe=()=>{const e=Xe("(max-width: 767px)"),t=Xe("(min-width: 768px) and (max-width: 1023px)"),s=Xe("(min-width: 1024px)");return{isMobile:e,isTablet:t,isDesktop:s,isLargeScreen:Xe("(min-width: 1280px)"),isTouchDevice:Xe("(pointer: coarse)"),isMobileOrTablet:e||t,isTabletOrDesktop:t||s}},Ze=new Map,et=({sessionId:e})=>(0,y.jsx)(o.Toaster,{position:"top-center",closeButton:!0,gap:8,toastOptions:{style:{zIndex:1e4,marginTop:"8px"},className:`widget-toast-${e}`},richColors:!0,theme:"light"});function tt(e){return Ze.has(e)||Ze.set(e,[]),{success:(t,s)=>{o.toast.success(t,{...s,id:`${e}-${Date.now()}-${Math.random()}`,duration:3e3,className:`widget-toast-${e}`,data:{widgetSessionId:e}})},error:(t,s)=>{o.toast.error(t,{...s,id:`${e}-${Date.now()}-${Math.random()}`,duration:4e3,className:`widget-toast-${e}`,data:{widgetSessionId:e}})},info:(t,s)=>{o.toast.info(t,{...s,id:`${e}-${Date.now()}-${Math.random()}`,duration:3e3,className:`widget-toast-${e}`,data:{widgetSessionId:e}})},warning:(t,s)=>{o.toast.warning(t,{...s,id:`${e}-${Date.now()}-${Math.random()}`,duration:3500,className:`widget-toast-${e}`,data:{widgetSessionId:e}})},loading:(t,s)=>o.toast.loading(t,{...s,id:`${e}-${Date.now()}-${Math.random()}`,className:`widget-toast-${e}`,data:{widgetSessionId:e}}),dismiss:e=>{e&&o.toast.dismiss(e)}}}const st=(0,n.createContext)(void 0),at=({widgetInstance:e,children:t})=>{const s=(0,n.useMemo)(()=>tt(e.sessionId),[e.sessionId]),a=(0,n.useMemo)(()=>({widget:e,toast:s}),[e,s]);return(0,y.jsx)(st.Provider,{value:a,children:t})},nt=()=>{const e=(0,n.useContext)(st);return e?.widget||null};var rt=s(71446),it=s(33345);function ot(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class ct{constructor(){ot(this,"debugEnabled",!0),ot(this,"logHistory",[])}static getInstance(){return ct.instance||(ct.instance=new ct),ct.instance}log(e,t,s,a="info"){if(!this.debugEnabled)return;const n={timestamp:(new Date).toISOString(),category:e,message:t,data:s,level:a};this.logHistory.push(n)}inspectLocalStorage(e){const t=Object.keys(localStorage),s=t.filter(t=>t.includes("customgpt")||t.includes("widget")||e&&t.includes(e)),a=s.filter(e=>e.includes("messages")),n=s.filter(e=>e.includes("conversation")),r={};return s.forEach(e=>{try{const t=localStorage.getItem(e);r[e]=t?JSON.parse(t):null}catch(t){r[e]=localStorage.getItem(e)}}),{allKeysCount:t.length,widgetKeysCount:s.length,keys:s,messageKeys:a,conversationKeys:n,contents:r}}getDebugInfo(e){const t=e?.sessionId||"unknown",s=e?.getConversations()||[],a=e?.currentConversationId,n=window.__customgpt_widget_stores?.[t],r=n?.messageStore?.getState();return{timestamp:(new Date).toISOString(),sessionId:t,widgetInstance:{sessionId:e?.sessionId,currentConversationId:e?.currentConversationId,config:e?.config,conversationCount:s.length},conversations:s,currentConversationId:a,messageStore:r?{messagesMapSize:r.messages?.size,messagesMapKeys:Array.from(r.messages?.keys()||[]),isStreaming:r.isStreaming,loading:r.loading,error:r.error}:null,localStorage:this.inspectLocalStorage(t),widgetStores:n?{hasMessageStore:!!n.messageStore,hasConversationStore:!!n.conversationStore,hasAgentStore:!!n.agentStore}:null}}debugConversation(e,t){this.getDebugInfo(e);const s=e?.sessionId,a=window.__customgpt_widget_stores?.[s]?.messageStore?.getState();if(a){a.messages.get(t)}[`customgpt-messages-cache-${s}`,`customgpt-messages-cache-${s}-${t}`,`customgpt-messages-${s}-${t}`].forEach(e=>{const t=localStorage.getItem(e);if(t)try{JSON.parse(t)}catch(e){}})}traceMessageFlow(e,t){(new Date).toISOString()}exportLogs(){return JSON.stringify(this.logHistory,null,2)}clearLogs(){this.logHistory=[]}setDebugEnabled(e){this.debugEnabled=e}}ot(ct,"instance",void 0),"undefined"!=typeof window&&(window.__customgpt_debug=e=>{const t=window.__customgpt_widget_instances;if(!t)return;const s=Object.keys(t);if(0===s.length)return;const a=ct.getInstance();s.forEach(s=>{const n=t[s];a.getDebugInfo(n);e&&a.debugConversation(n,e)})},window.__customgpt_debug_trace=()=>{ct.getInstance()},window.__customgpt_debug_storage=()=>{ct.getInstance().inspectLocalStorage()},window.__customgpt_debug_clear=()=>{if(confirm("This will clear all CustomGPT widget data from localStorage. Are you sure?")){Object.keys(localStorage).filter(e=>e.includes("customgpt")||e.includes("widget")).forEach(e=>localStorage.removeItem(e))}});const lt=ct.getInstance();function dt(e,t,s){const a=`customgpt-messages-cache-${e}`;function n(t,s){try{const n=`${a}-${t}`;localStorage.setItem(n,JSON.stringify(s));const r=localStorage.getItem(a),i=r?JSON.parse(r):{};i[t]=s,localStorage.setItem(a,JSON.stringify(i)),lt.log("STORAGE","Saved messages to localStorage",{conversationId:t,messageCount:s.length,storageKey:n,cacheKey:a,sessionId:e,actualKeys:[n,a],messageIds:s.map(e=>({id:e.id,role:e.role}))}),lt.traceMessageFlow("SAVE_MESSAGES",{conversationId:t,messageCount:s.length,sessionId:e,storageKeys:[n,a]})}catch(s){lt.log("STORAGE","Failed to save messages",{conversationId:t,error:s,sessionId:e},"error")}}return(0,rt.vt)((r,i)=>({messages:new Map,streamingMessage:null,isStreaming:!1,loading:!1,error:null,sendMessage:async(a,n)=>{const o="undefined"!=typeof window&&window.__customgpt_demo_mode;if(!t||!s)throw We.v.error("MESSAGES","Store references not provided"),new Error("Store references not provided");const l=t.getState().currentAgent;if(!l)throw We.v.error("MESSAGES","No agent selected"),new Error("No agent selected");We.v.info("MESSAGES","Sending message from widget store",{sessionId:e,agentId:l.id,agentName:l.project_name,messageLength:a.length,hasFiles:n&&n.length>0});const d=await s.getState().ensureConversation("string"==typeof l.id?parseInt(l.id):l.id,a);if(We.v.info("MESSAGES","Conversation ensured",{conversationId:d.id,sessionId:d.session_id,hasSessionId:!!d.session_id,isNew:!d.message_count||0===d.message_count}),!d.session_id)throw We.v.error("MESSAGES","Conversation missing session_id",{conversation:d}),new Error("Conversation missing session_id");r({loading:!0,error:null});const u=d.id.toString(),g={id:(0,c.$C)(),role:"user",content:a,timestamp:(new Date).toISOString(),status:"sending"};lt.log("MESSAGES","Adding user message",{conversationId:u,conversationIdType:typeof u,messageId:g.id,currentMapKeys:Array.from(i().messages.keys()),sessionId:e}),lt.traceMessageFlow("ADD_USER_MESSAGE",{conversationId:u,messageId:g.id,sessionId:e,content:a.substring(0,50)+"..."}),i().addMessage(u,g);const m={id:(0,c.$C)(),role:"assistant",content:"",timestamp:(new Date).toISOString(),citations:[]};r({streamingMessage:m,isStreaming:!0,loading:!1});try{if(n&&n.length>0){const e=(0,Te.getClient)();await Promise.all(n.map(t=>e.uploadFile(l.id,t)))}g.status="sent",i().addMessage(u,g);const e=(0,Te.getClient)();if(We.v.info("MESSAGES","Starting message stream",{agentId:l.id,sessionId:d.session_id,messageContent:a.substring(0,50)}),o){await new Promise(e=>setTimeout(e,1e3));const e=`This is a demo response to: "${a}"`;i().updateStreamingMessage(e),await new Promise(e=>setTimeout(e,500));const t=i().streamingMessage;return t&&(t.status="sent",i().addMessage(u,t)),void r({streamingMessage:null,isStreaming:!1})}try{await e.sendMessageStream(l.id,d.session_id,{prompt:a},e=>{if(We.v.info("MESSAGES","Received stream chunk",{type:e.type,hasContent:!!e.content,contentLength:e.content?.length,contentPreview:e.content?.substring(0,50)}),"content"===e.type&&e.content)i().updateStreamingMessage(e.content,e.citations);else if("citation"===e.type&&e.citations){const t=i().streamingMessage;t&&r({streamingMessage:{...t,citations:e.citations}})}},async t=>{We.v.error("MESSAGES","Streaming failed, attempting fallback to non-streaming",t);try{const t=await e.sendMessage(l.id,d.session_id,{prompt:a,stream:!1}),s=i().streamingMessage;if(s&&t){let e;e=t.data?t.data:t,s.content=e?.openai_response||e?.content||"No response received",s.citations=e?.citations||[],s.status="sent",i().addMessage(u,s)}r({streamingMessage:null,isStreaming:!1})}catch(e){throw We.v.error("MESSAGES","Both streaming and non-streaming failed",e),e}},()=>{const e=i().streamingMessage;e&&(e.status="sent",i().addMessage(u,e)),r({streamingMessage:null,isStreaming:!1}),s.getState().updateConversation(d.id,d.session_id,{name:d.name})})}catch(e){throw We.v.error("MESSAGES","Failed to send message",e),r({streamingMessage:null,isStreaming:!1,error:e instanceof Error?e.message:"Failed to send message"}),e}}catch(e){throw We.v.error("MESSAGES","Error in sendMessage",e),r({error:e instanceof Error?e.message:"Failed to send message",streamingMessage:null,isStreaming:!1,loading:!1}),e}},loadMessages:async t=>{lt.log("MESSAGES","loadMessages called",{conversationId:t,conversationIdType:typeof t,sessionId:e,storageKey:a,currentMapSize:i().messages.size,currentMapKeys:Array.from(i().messages.keys())}),lt.traceMessageFlow("LOAD_MESSAGES_START",{conversationId:t,sessionId:e}),r({loading:!0,error:null});try{const s=function(t){try{const s=`${a}-${t}`,n=localStorage.getItem(s);if(lt.log("STORAGE","Attempting to load messages",{conversationId:t,sessionId:e,sessionStorageKey:s,hasSessionStored:!!n,sessionStoredLength:n?.length}),n)try{const a=JSON.parse(n);return lt.log("STORAGE","Successfully loaded from session storage",{conversationId:t,messageCount:a.length,sessionId:e,messageIds:a.map(e=>({id:e.id,role:e.role}))}),lt.traceMessageFlow("LOAD_SUCCESS_SESSION",{conversationId:t,messageCount:a.length,fromKey:s}),a}catch(e){lt.log("STORAGE","Failed to parse session storage",{error:e},"error")}const r=localStorage.getItem(a);if(lt.log("STORAGE","Checking main cache",{cacheKey:a,hasCache:!!r,cacheSize:r?.length}),r)try{const e=JSON.parse(r),s=e[t];return lt.log("STORAGE","Cache lookup result",{conversationId:t,foundMessages:!!s,messageCount:s?.length||0,cacheKeys:Object.keys(e),conversationIdType:typeof t,cacheKeyTypes:Object.keys(e).map(e=>({key:e,type:typeof e}))}),s&&lt.traceMessageFlow("LOAD_SUCCESS_CACHE",{conversationId:t,messageCount:s.length,fromKey:a}),s||null}catch(e){lt.log("STORAGE","Failed to parse cache storage",{error:e},"error")}return lt.log("STORAGE","No messages found in any storage",{conversationId:t,sessionId:e,checkedKeys:[s,a],allLocalStorageKeys:Object.keys(localStorage).filter(e=>e.includes("customgpt"))},"warn"),lt.traceMessageFlow("LOAD_EMPTY",{conversationId:t,sessionId:e,reason:"No messages found in storage"}),null}catch(s){return lt.log("STORAGE","Exception loading messages",{conversationId:t,error:s,sessionId:e},"error"),null}}(t);if(lt.log("MESSAGES","Storage load result",{conversationId:t,messageCount:s?.length||0,hasMessages:!!s,firstMessage:s?.[0]?{id:s[0].id,role:s[0].role,contentPreview:s[0].content.substring(0,50)}:null}),s&&s.length>0)return void r(a=>{const n=new Map(a.messages);return n.set(t,s),lt.log("MESSAGES","Updated message map",{conversationId:t,messageCount:s.length,newMapSize:n.size,newMapKeys:Array.from(n.keys()),mapNowHasConversation:n.has(t)}),lt.traceMessageFlow("LOAD_MESSAGES_SUCCESS",{conversationId:t,messageCount:s.length,sessionId:e}),{messages:n,loading:!1}});lt.log("MESSAGES","No messages in storage, setting empty array",{conversationId:t,sessionId:e},"warn"),r(s=>{const a=new Map(s.messages);return a.set(t,[]),lt.traceMessageFlow("LOAD_MESSAGES_EMPTY",{conversationId:t,reason:"No messages found",sessionId:e}),{messages:a,loading:!1}})}catch(s){lt.log("MESSAGES","Exception in loadMessages",{conversationId:t,error:s,sessionId:e},"error"),r({error:s instanceof Error?s.message:"Failed to load messages",loading:!1})}},addMessage:(t,s)=>{lt.log("MESSAGES","addMessage called",{conversationId:t,conversationIdType:typeof t,messageId:s.id,messageRole:s.role,sessionId:e}),r(e=>{const a=new Map(e.messages),r=a.get(t)||[];lt.log("MESSAGES","Current messages for conversation",{conversationId:t,existingMessageCount:r.length,mapHasConversation:e.messages.has(t)});const i=r.findIndex(e=>e.id===s.id);return i>=0?(r[i]=s,lt.log("MESSAGES","Updated existing message",{messageId:s.id})):(r.push(s),lt.log("MESSAGES","Added new message",{messageId:s.id,newMessageCount:r.length})),a.set(t,r),n(t,r),lt.traceMessageFlow("MESSAGE_ADDED",{conversationId:t,messageId:s.id,messageCount:r.length,role:s.role}),{messages:a}})},updateStreamingMessage:(e,t)=>{r(s=>s.streamingMessage?{streamingMessage:{...s.streamingMessage,content:s.streamingMessage.content+e,citations:t||s.streamingMessage.citations}}:s)},clearMessages:e=>{if(e){r(t=>{const s=new Map(t.messages);return s.delete(e),{messages:s}});try{const t=localStorage.getItem(a);if(t){const s=JSON.parse(t);delete s[e],localStorage.setItem(a,JSON.stringify(s))}}catch(e){}}else{r({messages:new Map});try{localStorage.removeItem(a)}catch(e){}}},cancelStreaming:()=>{it.Hr.cancelAllStreams(),r({isStreaming:!1,streamingMessage:null})},getMessagesForConversation:e=>i().messages.get(e)||[],updateMessageFeedback:(e,t)=>{r(s=>{const a=new Map(s.messages);for(const[s,r]of a){const i=r.findIndex(t=>t.id===e);if(-1!==i){const e=[...r];e[i]={...e[i],feedback:t},a.set(s,e),n(s,e);break}}return{messages:a}})},reset:()=>{r({messages:new Map,streamingMessage:null,isStreaming:!1,loading:!1,error:null})},clearError:()=>{r({error:null})},setMessagesForConversation:(e,t)=>{r(s=>{const a=new Map(s.messages);return a.set(e,t),{messages:a}})}}))}function ut(e){const t=`customgpt-conversations-cache-${e}`,s=`customgpt-conversation-activity-${e}`;function a(e,s){try{const a=localStorage.getItem(t),n=a?JSON.parse(a):{};n[e]=s,localStorage.setItem(t,JSON.stringify(n))}catch(e){}}function n(e){try{const s=localStorage.getItem(t);if(!s)return null;return JSON.parse(s)[e]||null}catch(e){return null}}function r(){try{const e=localStorage.getItem(s);return e?JSON.parse(e):{}}catch(e){return{}}}return(0,rt.vt)((t,i)=>({conversations:[],allConversations:[],currentConversation:null,loading:!1,error:null,lastConversationActivity:r(),currentPage:1,totalPages:1,totalConversations:0,perPage:20,sortOrder:"desc",sortBy:"id",userFilter:"all",searchQuery:"",searchMode:"name",dateFilter:"all",fetchConversations:async(s,r)=>{const o="undefined"!=typeof window&&window.__customgpt_demo_mode;We.v.info("CONVERSATIONS","Fetching conversations for widget",{sessionId:e,projectId:s,isDemoMode:o}),t({loading:!0,error:null});try{if(o)return i().loadConversations(s.toString());const n=`widget_conversations_${e}`,c=JSON.parse(localStorage.getItem(n)||"[]");if(0===c.length)return void t({conversations:[],loading:!1});const l=(0,Te.getClient)(),d={page:r?.page??i().currentPage,per_page:r?.per_page??i().perPage,order:r?.order??i().sortOrder,orderBy:r?.orderBy??i().sortBy,userFilter:r?.userFilter??i().userFilter},u=await l.getConversations(s,d);let g=[],m=null;u&&"object"==typeof u&&(u.data&&u.data.data?(g=u.data.data,m=u.data):Array.isArray(u.data)?g=u.data:Array.isArray(u)&&(g=u));const h=g.filter(e=>c.includes(e.id));We.v.info("CONVERSATIONS","Filtered widget conversations",{totalFromAPI:g.length,widgetSpecific:h.length,widgetConvIds:c,paginationData:m}),t({allConversations:h,loading:!1,currentPage:m?.current_page??1,totalPages:m?.last_page??1,totalConversations:c.length,...r?.order&&{sortOrder:r.order},...r?.orderBy&&{sortBy:r.orderBy},...r?.userFilter&&{userFilter:r.userFilter}}),i().applyFilters(),a(s.toString(),h)}catch(e){We.v.error("CONVERSATIONS","Failed to fetch conversations",e);const a=n(s.toString());t({conversations:a||[],error:e instanceof Error?e.message:"Failed to fetch conversations",loading:!1})}},loadConversations:async s=>{const a="undefined"!=typeof window&&window.__customgpt_demo_mode;We.v.info("CONVERSATIONS","Loading conversations for widget store",{sessionId:e,agentId:s,isDemoMode:a}),t({loading:!0,error:null});try{const a=n(s);if(a){const s=a.filter(t=>t.session_id&&t.session_id.includes(e));t({allConversations:s,loading:!1}),i().applyFilters(),We.v.info("CONVERSATIONS","Loaded session-specific conversations",{totalCached:a.length,sessionSpecific:s.length,sessionId:e})}else t({allConversations:[],conversations:[],loading:!1})}catch(e){We.v.error("CONVERSATIONS","Failed to load conversations",e),t({error:e instanceof Error?e.message:"Failed to load conversations",loading:!1,allConversations:[],conversations:[]})}},createConversation:async(s,n)=>{const r="undefined"!=typeof window&&window.__customgpt_demo_mode;We.v.info("CONVERSATIONS","Creating conversation in widget store",{sessionId:e,projectId:s,name:n}),t({loading:!0,error:null});try{const o=(0,Te.getClient)();if(r){const r=Date.now(),o=`demo_session_${r}_${Math.floor(1e6*Math.random())}_${e}`,c={id:Math.floor(1e6*Math.random()),session_id:o,project_id:s,name:n||"New Conversation",message_count:0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),deleted_at:null};return t(e=>({allConversations:[...e.allConversations,c],currentConversation:c,loading:!1})),i().applyFilters(),void a(s.toString(),[...i().conversations])}const c=(await o.createConversation(s,n?{name:n}:void 0)).data,l=`widget_conversations_${e}`,d=JSON.parse(localStorage.getItem(l)||"[]");d.push(c.id),localStorage.setItem(l,JSON.stringify(d)),We.v.info("CONVERSATIONS","Created conversation via API",{conversationId:c.id,sessionId:c.session_id,projectId:c.project_id,widgetSessionId:e}),t(e=>({allConversations:[...e.allConversations,c],currentConversation:c,loading:!1})),i().applyFilters(),a(s.toString(),i().conversations)}catch(e){throw We.v.error("CONVERSATIONS","Failed to create conversation",e),t({error:e instanceof Error?e.message:"Failed to create conversation",loading:!1}),e}},updateConversation:async(e,s,n)=>{We.v.info("CONVERSATIONS","Updating conversation in widget store",{sessionId:s,conversationId:e,data:n}),t(t=>({allConversations:t.allConversations.map(t=>t.id.toString()===e.toString()?{...t,name:n.name,updated_at:(new Date).toISOString()}:t)})),i().applyFilters();const r=i().currentConversation;r&&r.id.toString()===e.toString()&&t({currentConversation:{...r,name:n.name,updated_at:(new Date).toISOString()}});const o=i().conversations.find(t=>t.id.toString()===e.toString())?.project_id;o&&a(o.toString(),i().conversations)},deleteConversation:async s=>{We.v.info("CONVERSATIONS","Deleting conversation from widget store",{sessionId:e,conversationId:s});const n=i().allConversations.find(e=>e.id.toString()===s);n&&(t(e=>({allConversations:e.allConversations.filter(e=>e.id.toString()!==s),currentConversation:e.currentConversation?.id.toString()===s?null:e.currentConversation})),i().applyFilters(),a(n.project_id.toString(),i().conversations))},selectConversation:a=>{if(We.v.info("CONVERSATIONS","Selecting conversation in widget store",{sessionId:e,conversationId:a?.id}),t({currentConversation:a}),a){const e={...i().lastConversationActivity};e[a.project_id.toString()]=a.id.toString(),t({lastConversationActivity:e}),function(e){try{localStorage.setItem(s,JSON.stringify(e))}catch(e){}}(e)}},ensureConversation:async(e,s)=>{const{currentConversation:a,allConversations:n}=i();if(a&&a.project_id===e)return a;const r=n.find(t=>t.project_id===e);if(r)return t({currentConversation:r}),r;const o=s?s.substring(0,50)+(s.length>50?"...":""):"New Conversation";await i().createConversation(e,o);const c=i().conversations[i().conversations.length-1];return t({currentConversation:c}),c},applyFilters:()=>{const e=i();let s=[...e.allConversations];if(e.searchQuery.trim()){const t=e.searchQuery.toLowerCase().trim();s=s.filter(s=>{switch(e.searchMode){case"name":default:return s.name.toLowerCase().includes(t);case"id":return s.id.toString().includes(t);case"session":return s.session_id.toLowerCase().includes(t)}})}if("all"!==e.dateFilter){const t=new Date,a=new Date;switch(e.dateFilter){case"today":a.setHours(0,0,0,0);break;case"week":a.setDate(t.getDate()-7);break;case"month":a.setDate(t.getDate()-30)}s=s.filter(e=>new Date(e.updated_at)>=a)}t({conversations:s})},setSearchQuery:e=>{t({searchQuery:e}),i().applyFilters()},setSearchMode:e=>{t({searchMode:e}),i().applyFilters()},setDateFilter:e=>{t({dateFilter:e}),i().applyFilters()},reset:()=>{t({conversations:[],allConversations:[],currentConversation:null,loading:!1,error:null,lastConversationActivity:{},searchQuery:"",searchMode:"name",dateFilter:"all"})}}))}function gt(e){const t=`customgpt-agents-cache-${e}`,s=`customgpt-selected-agent-${e}`;function a(e){try{localStorage.setItem(t,JSON.stringify(e))}catch(e){}}function n(e){try{e?localStorage.setItem(s,e):localStorage.removeItem(s)}catch(e){}}return(0,rt.vt)((r,i)=>({agents:[],currentAgent:null,loading:!1,error:null,fetchAgents:async()=>i().loadAgents(),loadAgents:async()=>{const t="undefined"!=typeof window&&window.__customgpt_demo_mode;let i=null;if("undefined"!=typeof window){if(i=window[`__customgpt_widget_${e}`],!i){const t=window.__customgpt_widget_instances;i=t?.[e]}i||(i=window.__customgpt_widget_instance)}We.v.info("AGENTS","Loading agents for widget store",{sessionId:e,isDemoMode:t,hasWidget:!!i,configuredAgentId:i?.config?.agentId}),r({loading:!0,error:null});try{if(i?.config?.agentId){const e="string"==typeof i.config.agentId?parseInt(i.config.agentId):i.config.agentId,s={id:e,project_name:i.config.agentName||i.config.name||`Agent ${e}`,type:"WIDGET",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),is_chat_active:!0,is_shared:!1,user_id:0,team_id:0,settings:{chatbot_avatar:"./logo.png"}};if(We.v.info("AGENTS","Creating fallback agent for widget",{agentId:e,agentName:s.project_name,isDemoMode:t}),r({agents:[s],currentAgent:s,loading:!1}),a([s]),n(s.id.toString()),!t)try{const t=(0,Te.getClient)(),s=await t.getAgent(e),o=s.data||s;try{const s=await t.getAgentSettings(e),a=s.data||s;o.settings=a,We.v.info("AGENTS","Fetched agent settings",{agentId:o.id,hasAvatar:!!a?.chatbot_avatar,avatarUrl:a?.chatbot_avatar})}catch(e){We.v.warn("AGENTS","Failed to fetch agent settings",e),o.settings={chatbot_avatar:"./logo.png"}}i.config.agentName&&(o.project_name=i.config.agentName),We.v.info("AGENTS","Updated agent with API data",{agentId:o.id,agentName:o.project_name,hasSettings:!!o.settings,avatarUrl:o.settings?.chatbot_avatar}),r({agents:[o],currentAgent:o,loading:!1}),a([o]),n(o.id.toString())}catch(e){We.v.warn("AGENTS","Failed to fetch agent from API, using fallback",e)}return}if(!i){We.v.warn("AGENTS","No widget configuration found, creating demo agent");const e={id:1,project_name:"Demo Assistant",type:"DEMO",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),is_chat_active:!0,is_shared:!1,user_id:0,team_id:0,settings:{chatbot_avatar:"./logo.png"}};return r({agents:[e],currentAgent:e,loading:!1}),a([e]),void n(e.id.toString())}if(!t){const e=(0,Te.getClient)(),t=await e.getAgents({page:1,per_page:100});let i=[];t&&"object"==typeof t&&("data"in t&&"total"in t||Array.isArray(t.data)?i=t.data:Array.isArray(t)&&(i=t)),We.v.info("AGENTS","Fetched agents from API (first page)",{count:i.length,total:t?.total||i.length});const o=function(){try{return localStorage.getItem(s)}catch(e){return null}}(),c=o&&i.find(e=>e.id.toString()===o)||i[0];return r({agents:i,currentAgent:c||null,loading:!1}),a(i),void(c&&n(c.id.toString()))}if(t){const e=[{id:1,project_name:"Demo Assistant",type:"DEMO",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),is_chat_active:!0,is_shared:!1,user_id:0,team_id:0,settings:{chatbot_avatar:"/logo.png"}}];return r({agents:e,currentAgent:e[0],loading:!1}),a(e),void n(e[0].id.toString())}r({agents:[],currentAgent:null,loading:!1})}catch(e){We.v.error("AGENTS","Failed to load agents",e),r({error:e instanceof Error?e.message:"Failed to load agents",loading:!1})}},selectAgent:t=>{We.v.info("AGENTS","Selecting agent in widget store",{sessionId:e,agentId:t?.id,agentName:t?.project_name}),r({currentAgent:t}),n(t?.id.toString()||null);const s=`__customgpt_widget_${e}`,a="undefined"!=typeof window?window[s]:null;a&&t&&(a.config.agentId=t.id,a.config.name=t.project_name)},setAgents:e=>{r({agents:e}),a(e)},updateAgent:async(t,s)=>{We.v.info("AGENTS","Updating agent in widget store",{sessionId:e,agentId:t,data:s});const n=i().agents.find(e=>e.id===t);if(!n)throw new Error("Agent not found");const o={...n,...s};return r(e=>({agents:e.agents.map(e=>e.id===t?o:e),currentAgent:e.currentAgent?.id===t?o:e.currentAgent})),a(i().agents),o},deleteAgent:async t=>{We.v.info("AGENTS","Deleting agent from widget store",{sessionId:e,agentId:t}),r(e=>({agents:e.agents.filter(e=>e.id!==t),currentAgent:e.currentAgent?.id===t?null:e.currentAgent})),a(i().agents)},createAgent:async e=>{throw new Error("Creating agents is not supported in widget mode")},replicateAgent:async e=>{throw new Error("Replicating agents is not supported in widget mode")},getAgentStats:async e=>({messages_sent:0,users_interacted:0,last_message_at:null}),reset:()=>{r({agents:[],currentAgent:null,loading:!1,error:null});try{localStorage.removeItem(t),localStorage.removeItem(s)}catch(e){}}}))}const mt=(0,n.createContext)(null),ht=({children:e,sessionId:t})=>{const s=(0,n.useRef)(null);if(!s.current){const e=gt(t),a=ut(t),n=dt(t,e,a);s.current={messageStore:n,conversationStore:a,agentStore:e},"undefined"!=typeof window&&(window.__customgpt_widget_stores||(window.__customgpt_widget_stores={}),window.__customgpt_widget_stores[t]=s.current)}return(0,y.jsx)(mt.Provider,{value:{stores:s.current},children:e})},pt=({isOpen:e,onClose:t,citationId:s,projectId:a})=>{const[i,o]=(0,n.useState)(!1),[l,d]=(0,n.useState)(null),[u,g]=(0,n.useState)(null),[h,p]=(0,n.useState)(!1),{isMobile:f}=Qe(),x=nt(),v=(0,Ee.o)(),b=(0,n.useContext)(mt),S=x&&b?b.stores.agentStore.getState().currentAgent:v.currentAgent,j=a||S?.id,C=(0,n.useCallback)(async()=>{if(j&&s){o(!0),d(null),p(!1);try{const e=(0,Te.getClient)(),t=await e.getCitation(j,"string"==typeof s?parseInt(s,10):s);t.data&&(g(t.data),We.v.info("CITATION","Citation details fetched",{citationId:s,projectId:j,hasImage:!!t.data.image}))}catch(e){const t=e instanceof Error?e.message:"Failed to fetch citation details";d(t),We.v.error("CITATION","Failed to fetch citation details",{error:e,citationId:s,projectId:j})}finally{o(!1)}}else d("Missing project or citation information")},[j,s]);return(0,n.useEffect)(()=>{e&&j&&s&&C()},[e,j,s,C]),e?(0,y.jsx)(I.N,{children:e&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(r.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:t,className:"fixed inset-0 bg-black/50 z-50"}),(0,y.jsxs)(r.P.div,{initial:{opacity:0,scale:.95,y:f?"100%":0},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:f?"100%":0},className:(0,c.cn)("fixed bg-background shadow-xl z-50",f?"inset-x-0 bottom-0 top-20 rounded-t-xl flex flex-col":"inset-x-0 top-[10%] mx-auto max-w-2xl rounded-lg max-h-[90vh] overflow-hidden"),children:[(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center justify-between border-b border-border bg-background/95 backdrop-blur-sm flex-shrink-0",f?"px-4 py-4":"p-4"),children:[(0,y.jsx)("h2",{className:(0,c.cn)("font-semibold text-foreground","text-lg"),children:"Citation Details"}),(0,y.jsx)(w,{variant:"ghost",size:"icon",onClick:t,className:(0,c.cn)(f?"h-9 w-9 touch-target":"h-8 w-8"),children:(0,y.jsx)(H.A,{className:(0,c.cn)(f?"h-5 w-5":"h-4 w-4")})})]}),(0,y.jsx)("div",{className:(0,c.cn)("overflow-y-auto",f?"flex-1 px-4 py-4 pb-6 safe-area-pb":"p-4 max-h-[calc(90vh-120px)]"),children:i?(0,y.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,y.jsx)(He.A,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):l?(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center gap-3 p-4 bg-red-50 dark:bg-red-950/20 rounded-lg",f&&"mx-0"),children:[(0,y.jsx)(K.A,{className:(0,c.cn)("text-red-600 flex-shrink-0","h-5 w-5")}),(0,y.jsxs)("div",{className:"flex-1",children:[(0,y.jsx)("p",{className:(0,c.cn)("font-medium text-red-900 dark:text-red-200","text-sm"),children:"Error loading citation"}),(0,y.jsx)("p",{className:(0,c.cn)("text-red-700 dark:text-red-300 mt-1",f?"text-xs":"text-sm"),children:l})]})]}):u?(0,y.jsxs)("div",{className:(0,c.cn)("space-y-4",f&&"space-y-5"),children:[u.image&&!h&&(0,y.jsxs)("div",{className:(0,c.cn)("relative rounded-lg overflow-hidden bg-muted",f&&"-mx-4 rounded-none"),children:[(0,y.jsx)("img",{src:u.image,alt:u.title,className:"w-full h-auto",onError:()=>p(!0)}),f&&(0,y.jsx)("div",{className:"absolute inset-0 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"})]}),(0,y.jsx)("div",{children:(0,y.jsx)("h3",{className:(0,c.cn)("font-semibold text-foreground",f?"text-lg leading-tight":"text-xl"),children:u.title})}),(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center gap-2 text-muted-foreground","text-sm"),children:[(0,y.jsx)(Je.A,{className:(0,c.cn)("flex-shrink-0","h-4 w-4")}),(0,y.jsx)("a",{href:u.url,target:"_blank",rel:"noopener noreferrer",className:(0,c.cn)("hover:text-brand-600 transition-colors",f?"break-all":"truncate"),children:u.url})]}),u.description&&(0,y.jsx)("div",{className:"prose prose-gray dark:prose-invert max-w-none",children:(0,y.jsx)("p",{className:(0,c.cn)("text-foreground",f?"text-sm leading-relaxed":""),children:u.description})}),(0,y.jsxs)("div",{className:(0,c.cn)("pt-4 border-t border-border space-y-3",f&&"space-y-3"),children:[(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center justify-between","text-sm"),children:[(0,y.jsx)("span",{className:"text-muted-foreground",children:"Citation ID"}),(0,y.jsxs)("span",{className:(0,c.cn)("font-mono text-foreground",f?"text-base":""),children:["#",u.id]})]}),u.image&&(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center justify-between","text-sm"),children:[(0,y.jsx)("span",{className:"text-muted-foreground",children:"Has preview image"}),(0,y.jsx)(Ye.A,{className:(0,c.cn)("text-muted-foreground","h-4 w-4")})]})]})]}):null}),(0,y.jsx)("div",{className:(0,c.cn)("border-t bg-muted flex-shrink-0",f?"p-4 safe-area-pb":"p-4"),children:(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center",f?"flex-col gap-3":"justify-between"),children:[(0,y.jsx)("div",{className:(0,c.cn)("text-muted-foreground",f?"text-xs text-center":"text-xs"),children:"Open Graph data from cited source"}),u&&(0,y.jsxs)("a",{href:u.url,target:"_blank",rel:"noopener noreferrer",className:(0,c.cn)("inline-flex items-center gap-2 font-medium text-brand-600 hover:text-brand-700 transition-colors",f?"w-full justify-center bg-brand-600 text-white hover:bg-brand-700 hover:text-white rounded-lg px-4 py-3 text-base touch-target":"px-3 py-1.5 text-sm"),children:["Visit source",(0,y.jsx)(m.A,{className:(0,c.cn)(f?"h-4 w-4":"h-3.5 w-3.5")})]})]})})]})]})}):null};var ft=s(58722);const xt=({isOpen:e,onClose:t,citationId:s,fileName:a="Citation File"})=>{const[i,c]=(0,n.useState)(!1),[l,d]=(0,n.useState)(null),[u,g]=(0,n.useState)(null),[m,p]=(0,n.useState)("text/plain"),[f,x]=(0,n.useState)(!1),v=(0,n.useCallback)(async()=>{c(!0),d(null);try{const e=(0,Te.getClient)(),t=await e.previewCitationFile(s);"string"==typeof t?(g(t),p("text/plain")):t.data?(g(t.data.content||t.data),p(t.data.content_type||"text/plain")):(g(JSON.stringify(t,null,2)),p("application/json")),We.v.info("CITATION_PREVIEW","File preview fetched",{citationId:s,contentLength:u?.length})}catch(e){We.v.error("CITATION_PREVIEW","Failed to fetch file preview",{error:e,citationId:s}),400===e.status?d("Invalid citation ID."):401===e.status?d("Authentication failed. Please log in again."):403===e.status?d("Access denied. You do not have permission to view this file."):404===e.status?d("Citation file not found."):500===e.status?d("Server error. Please try again later."):d("Failed to load file preview.")}finally{c(!1)}},[s]);(0,n.useEffect)(()=>{e&&s&&v()},[e,s,v]);return e?(0,y.jsx)(I.N,{children:(0,y.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[(0,y.jsx)(r.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:t,className:"absolute inset-0 bg-black/50"}),(0,y.jsxs)(r.P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"relative bg-background rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[(0,y.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[(0,y.jsxs)("div",{className:"flex items-center gap-3",children:[(0,y.jsx)(E.A,{className:"h-5 w-5 text-muted-foreground"}),(0,y.jsx)("h2",{className:"text-lg font-semibold text-foreground",children:a})]}),(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(w,{variant:"outline",size:"sm",onClick:async()=>{if(u)try{await navigator.clipboard.writeText(u),x(!0),o.toast.success("Content copied to clipboard"),setTimeout(()=>x(!1),2e3)}catch(e){o.toast.error("Failed to copy content")}},disabled:!u,children:f?(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(Se.A,{className:"h-4 w-4 mr-2"}),"Copied"]}):(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(h.A,{className:"h-4 w-4 mr-2"}),"Copy"]})}),(0,y.jsxs)(w,{variant:"outline",size:"sm",onClick:()=>{if(!u)return;const e=new Blob([u],{type:m}),t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download=a,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(t),o.toast.success("File downloaded")},disabled:!u,children:[(0,y.jsx)(ft.A,{className:"h-4 w-4 mr-2"}),"Download"]}),(0,y.jsx)(w,{variant:"ghost",size:"icon",onClick:t,className:"h-8 w-8",children:(0,y.jsx)(H.A,{className:"h-4 w-4"})})]})]}),(0,y.jsx)("div",{className:"p-4 overflow-y-auto max-h-[calc(90vh-120px)]",children:i?(0,y.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,y.jsx)(He.A,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):l?(0,y.jsxs)("div",{className:"flex items-center gap-3 p-4 bg-red-50 rounded-lg",children:[(0,y.jsx)(K.A,{className:"h-5 w-5 text-red-600 flex-shrink-0"}),(0,y.jsxs)("div",{className:"flex-1",children:[(0,y.jsx)("p",{className:"text-sm font-medium text-destructive",children:"Error loading file"}),(0,y.jsx)("p",{className:"text-sm text-destructive/90 mt-1",children:l})]})]}):u?(0,y.jsx)("div",{className:"font-mono text-sm bg-accent rounded-lg p-4 text-foreground",children:(0,y.jsx)("pre",{className:"whitespace-pre-wrap break-words",children:u})}):null}),(0,y.jsx)("div",{className:"p-4 border-t border-border bg-accent",children:(0,y.jsxs)("div",{className:"flex items-center justify-between",children:[(0,y.jsxs)("div",{className:"text-xs text-muted-foreground",children:["Citation ID: ",s]}),(0,y.jsx)("div",{className:"text-xs text-muted-foreground",children:m})]})})]})]})}):null};var vt=s(57724),yt=s(3458),bt=s(35734),wt=s(56455),St=s(16369);const jt=({error:e,statusCode:t,onRetry:s,className:a})=>{const{statusCode:n,message:r}=(e=>{if("string"==typeof e){const t=e.match(/(\d{3})/);return{statusCode:t?parseInt(t[1]):void 0,message:e}}return{statusCode:e.status||e.statusCode,message:e.message}})(e),i=t||n,o=((e,t)=>{switch(e){case 400:return{icon:K.A,title:"Invalid Request",description:"The request format is invalid. Please check your input and try again.",className:"border-orange-200 bg-orange-50",iconClassName:"text-orange-600",textClassName:"text-orange-800"};case 401:return{icon:vt.A,title:"Authentication Failed",description:"Your API key is either missing or invalid. Please check your API key configuration.",className:"border-red-200 bg-red-50",iconClassName:"text-red-600",textClassName:"text-red-800",showSupport:!0};case 403:return t&&(t.toLowerCase().includes("inactive")||t.toLowerCase().includes("no documents")||t.toLowerCase().includes("agent is not active")||t.toLowerCase().includes("project is not active")||t.toLowerCase().includes("no documents uploaded"))?{icon:K.A,title:"Agent Inactive",description:"This agent is inactive. Please add documents to activate it before starting a conversation.",className:"border-orange-200 bg-orange-50",iconClassName:"text-orange-600",textClassName:"text-orange-800"}:{icon:vt.A,title:"Access Denied",description:"You don't have permission to access this resource. Please check your API key permissions.",className:"border-red-200 bg-red-50",iconClassName:"text-red-600",textClassName:"text-red-800",showSupport:!0};case 404:return{icon:yt.A,title:"Not Found",description:"The requested agent or conversation was not found. It may have been deleted or you may not have access.",className:"border-border bg-accent",iconClassName:"text-muted-foreground",textClassName:"text-foreground"};case 429:return{icon:bt.A,title:"Query Credits Exhausted",description:"You have exhausted your current query credits. Please contact customer service for assistance.",className:"border-yellow-200 bg-yellow-50",iconClassName:"text-yellow-600",textClassName:"text-yellow-800",showSupport:!0,supportUrl:"https://customgpt.freshdesk.com/support/home"};case 500:case 502:case 503:case 504:return{icon:wt.A,title:"Server Error",description:"An internal server error occurred. Please try again later or contact support if the issue persists.",className:"border-red-200 bg-red-50",iconClassName:"text-red-600",textClassName:"text-red-800",showRetry:!0};default:return{icon:St.A,title:"Error",description:t||"An unexpected error occurred. Please try again.",className:"border-red-200 bg-red-50",iconClassName:"text-red-600",textClassName:"text-red-800",showRetry:!0}}})(i,r),l=o.icon;return(0,y.jsx)("div",{className:(0,c.cn)("p-4 rounded-lg border",o.className,a),children:(0,y.jsxs)("div",{className:"flex items-start gap-3",children:[(0,y.jsx)(l,{className:(0,c.cn)("w-5 h-5 mt-0.5 flex-shrink-0",o.iconClassName)}),(0,y.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,y.jsxs)("div",{children:[(0,y.jsxs)("h3",{className:(0,c.cn)("font-medium",o.textClassName),children:[o.title,i&&` (${i})`]}),(0,y.jsx)("p",{className:(0,c.cn)("text-sm mt-1",o.textClassName,"opacity-90"),children:o.description})]}),(0,y.jsxs)("div",{className:"flex items-center gap-2 mt-3",children:[o.showRetry&&s&&(0,y.jsx)(w,{size:"sm",variant:"outline",onClick:s,className:"text-xs",children:"Try Again"}),o.showSupport&&(0,y.jsx)("a",{href:o.supportUrl||"https://customgpt.freshdesk.com/support/home",target:"_blank",rel:"noopener noreferrer",className:"text-xs underline hover:no-underline",children:"Contact Support"})]}),r&&r!==o.description&&(0,y.jsxs)("details",{className:"mt-3",children:[(0,y.jsx)("summary",{className:(0,c.cn)("text-xs cursor-pointer",o.textClassName,"opacity-70"),children:"Technical Details"}),(0,y.jsx)("pre",{className:(0,c.cn)("mt-2 p-2 text-xs rounded bg-background bg-opacity-50 overflow-x-auto",o.textClassName,"opacity-80"),children:r})]})]})]})})};function Ct(){try{return null!==(0,n.useContext)(mt)}catch{return!1}}function Nt(){const e=(0,n.useContext)(mt);return e?.stores}function At(){const e=Ct(),t=Nt(),s=(0,Ge.useMessageStore)(),a=(0,rt.Pj)(t?.messageStore||Ge.useMessageStore,e=>e);return e&&t?a:s}function _t(){const e=Ct(),t=Nt(),s=(0,Ge.useConversationStore)(),a=(0,rt.Pj)(t?.conversationStore||Ge.useConversationStore,e=>e);return e&&t?a:s}function It(){const e=Ct(),t=Nt(),s=(0,Ge.useAgentStore)(),a=(0,rt.Pj)(t?.agentStore||Ge.useAgentStore,e=>e);return e&&t?a:s}var kt=s(2690),Et=s(99360),Pt=s.n(Et),Tt=s(57611);function Mt(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class Ft{constructor(){Mt(this,"registeredThemes",new Map),Mt(this,"currentTheme",null),Mt(this,"canvas",null),Mt(this,"context",null),Mt(this,"isTransitioning",!1),Mt(this,"transitionTheme",null),Mt(this,"transitionProgress",0),Mt(this,"transitionOptions",{duration:1e3,easing:"ease-in-out",crossfade:!0}),Mt(this,"callbacks",{}),this.registerBuiltInThemes()}static getInstance(){return Ft.instance||(Ft.instance=new Ft),Ft.instance}initialize(e,t){this.canvas=e,this.context=t,this.currentTheme&&this.context&&this.currentTheme.init(this.context,e.width,e.height)}registerTheme(e){this.registeredThemes.has(e.id),this.registeredThemes.set(e.id,e)}unregisterTheme(e){return this.currentTheme?.id!==e&&this.registeredThemes.delete(e)}getAvailableThemes(){return Array.from(this.registeredThemes.values()).map(e=>e.metadata)}getThemeMetadata(e){const t=this.registeredThemes.get(e);return t?t.metadata:null}async switchTheme(e,t){if(this.isTransitioning)return!1;const s=this.registeredThemes.get(e);if(!s){const t=new Error(`Theme not found: ${e}`);return this.callbacks.onThemeError?.(t,e),!1}if(this.currentTheme?.id===e)return!0;try{this.transitionOptions={...this.transitionOptions,...t};const e=s.factory();return this.context&&this.canvas&&e.init(this.context,this.canvas.width,this.canvas.height),await this.performThemeTransition(e),!0}catch(t){return this.callbacks.onThemeError?.(t,e),!1}}getCurrentTheme(){return this.currentTheme}getCurrentThemeId(){return this.currentTheme?.id||null}setCallbacks(e){this.callbacks={...this.callbacks,...e}}draw(e,t,s,a,n,r){this.isTransitioning&&this.transitionOptions.crossfade?this.drawTransition(e,t,s,a,n,r):this.currentTheme&&this.currentTheme.draw(e,t,s,a,n,r)}onUserSpeaking(){this.currentTheme?.onUserSpeaking(),this.transitionTheme?.onUserSpeaking()}onProcessing(){this.currentTheme?.onProcessing(),this.transitionTheme?.onProcessing()}onAiSpeaking(){this.currentTheme?.onAiSpeaking(),this.transitionTheme?.onAiSpeaking()}reset(){this.currentTheme?.reset(),this.transitionTheme?.reset()}setMousePosition(e,t,s,a){this.currentTheme?.setMousePosition(e,t,s,a),this.transitionTheme?.setMousePosition(e,t,s,a)}setHovering(e){this.currentTheme?.setHovering(e),this.transitionTheme?.setHovering(e)}getPerformanceMetrics(){return this.currentTheme?.getPerformanceMetrics()||{}}dispose(){this.currentTheme?.dispose(),this.transitionTheme?.dispose(),this.currentTheme=null,this.transitionTheme=null,this.isTransitioning=!1}registerBuiltInThemes(){Promise.resolve().then(s.bind(s,26998)).then(({DefaultTheme:e})=>{this.registerTheme({id:"default",factory:()=>new e,metadata:{id:"default",name:"Classic Sphere",description:"The original 3D particle sphere with smooth color transitions",category:"particle",performanceProfile:"medium",previewColors:["#4285F4","#34A853","#EA4335"],previewDescription:"Rotating particle sphere with dynamic colors"}})}),s.e(365).then(s.bind(s,88365)).then(({StarfieldTheme:e})=>{this.registerTheme({id:"starfield",factory:()=>new e,metadata:{id:"starfield",name:"Cosmic Starfield",description:"Twinkling stars, dynamic constellations, and flowing nebula clouds",category:"particle",performanceProfile:"medium",previewColors:["#FFFFFF","#ADD8E6","#FFD700","#FFC0CB"],previewDescription:"Immersive space environment with stars and constellations"}})}),s.e(352).then(s.bind(s,18352)).then(({JarvisTheme:e})=>{this.registerTheme({id:"jarvis",factory:()=>new e,metadata:{id:"jarvis",name:"J.A.R.V.I.S.",description:"Advanced AI interface with arc reactor, HUD elements, and energy particles",category:"advanced",performanceProfile:"heavy",previewColors:["#00A2E8","#00FFFF","#FF6500","#FF00FF"],previewDescription:"Iron Man-inspired technological interface with arc reactor"}})}),s.e(236).then(s.bind(s,2236)).then(({LegoTheme:e})=>{this.registerTheme({id:"lego",factory:()=>new e,metadata:{id:"lego",name:"LEGO Blocks",description:"3D building blocks that construct and deconstruct with satisfying physics",category:"artistic",performanceProfile:"medium",previewColors:["#C4281C","#0D69AB","#12852B","#F5CD2F"],previewDescription:"Interactive LEGO blocks building structures with authentic colors"}})}),s.e(638).then(s.bind(s,2638)).then(({StarWarsTheme:e})=>{this.registerTheme({id:"starwars",factory:()=>new e,metadata:{id:"starwars",name:"Star Wars",description:"Lightsabers, holograms, and the Force in a galaxy far, far away",category:"advanced",performanceProfile:"heavy",previewColors:["#00A2FF","#FF0000","#00FF00","#9333EA"],previewDescription:"Epic Star Wars experience with lightsabers and hologram effects"}})}),s.e(964).then(s.bind(s,43964)).then(({OceanWaveTheme:e})=>{this.registerTheme({id:"ocean",factory:()=>new e,metadata:{id:"ocean",name:"Ocean Waves",description:"Calming underwater environment with waves, bubbles, and marine life",category:"particle",performanceProfile:"medium",previewColors:["#0077BE","#00BCF2","#C8E6FF","#98CB3B"],previewDescription:"Serene ocean experience with realistic wave physics and bubbles"}})}),s.e(613).then(s.bind(s,46613)).then(({NFTTheme:e})=>{this.registerTheme({id:"nft",factory:()=>new e,metadata:{id:"nft",name:"NFT Art",description:"Vibrant digital art with morphing shapes, dynamic gradients, and artistic trails",category:"artistic",performanceProfile:"heavy",previewColors:["#FF00FF","#00FFFF","#FFFF00","#8000FF","#FF0080"],previewDescription:"Bold NFT-style aesthetics with morphing geometric shapes"}})}),s.e(258).then(s.bind(s,99258)).then(({NothingPhoneTheme:e})=>{this.registerTheme({id:"nothing",factory:()=>new e,metadata:{id:"nothing",name:"Nothing Phone",description:"Minimalist design inspired by Nothing Phone with clean dots and typography",category:"artistic",performanceProfile:"light",previewColors:["#FFFFFF","#F5F5F5","#C8C8C8","#808080","#000000"],previewDescription:"Clean minimalist interface with Glyph-inspired dot patterns"}})}),s.e(404).then(s.bind(s,75404)).then(({MinecraftTheme:e})=>{this.registerTheme({id:"minecraft",factory:()=>new e,metadata:{id:"minecraft",name:"Minecraft",description:"Blocky voxel world with building, breaking, and crafting animations",category:"artistic",performanceProfile:"medium",previewColors:["#7CBD52","#FEF63F","#A28A4E","#63EDE5","#888888"],previewDescription:"Interactive voxel blocks with authentic Minecraft aesthetics"}})}),s.e(139).then(s.bind(s,40139)).then(({FuturisticTheme:e})=>{this.registerTheme({id:"futuristic",factory:()=>new e,metadata:{id:"futuristic",name:"Futuristic",description:"High-tech cyberpunk interface with holograms, wireframes, and data streams",category:"advanced",performanceProfile:"heavy",previewColors:["#00FFFF","#FF00FF","#FFFF00","#00FF00","#0096FF"],previewDescription:"Cyberpunk-inspired holographic displays and wireframe models"}})}),s.e(482).then(s.bind(s,83101)).then(({VintageModernTheme:e})=>{this.registerTheme({id:"vintage-modern",factory:()=>new e,metadata:{id:"vintage-modern",name:"Vintage Modern",description:"Retro aesthetics meets modern design with film grain and neon glow",category:"artistic",performanceProfile:"medium",previewColors:["#FF6F91","#FF9A00","#ED75FF","#5FE1FA","#FFF176"],previewDescription:"Nostalgic blend of retro TV effects with modern animations"}})}),s.e(135).then(s.bind(s,74135)).then(({AuroraTheme:e})=>{this.registerTheme({id:"aurora",factory:()=>new e,metadata:{id:"aurora",name:"Aurora Borealis",description:"Ethereal northern lights with flowing ribbons and magnetic fields",category:"particle",performanceProfile:"heavy",previewColors:["#00FF00","#0064FF","#9300D3","#FF0064","#5FE1FA"],previewDescription:"Mesmerizing aurora borealis with realistic light bands"}})})}async performThemeTransition(e){const t=this.currentTheme,s=t?.id||null;if(this.isTransitioning=!0,this.transitionTheme=e,this.transitionProgress=0,this.callbacks.onTransitionStart?.(s,e.id),this.transitionOptions.crossfade)return new Promise(s=>{const a=performance.now(),{duration:n,easing:r}=this.transitionOptions,i=o=>{const c=o-a;let l=Math.min(c/n,1);l=this.applyEasing(l,r),this.transitionProgress=l,l>=1?(this.completeTransition(e,t),s()):requestAnimationFrame(i)};requestAnimationFrame(i)});this.completeTransition(e,t)}completeTransition(e,t){t?.dispose(),this.currentTheme=e,this.transitionTheme=null,this.isTransitioning=!1,this.transitionProgress=0,this.callbacks.onThemeChange?.(t?.id||null,e.id),this.callbacks.onTransitionComplete?.(e.id)}drawTransition(e,t,s,a,n,r){const i=document.createElement("canvas"),o=document.createElement("canvas");i.width=o.width=t,i.height=o.height=s;const c=i.getContext("2d"),l=o.getContext("2d");c&&l&&(this.currentTheme&&this.currentTheme.draw(c,t,s,a,n,r),this.transitionTheme&&this.transitionTheme.draw(l,t,s,a,n,r),e.clearRect(0,0,t,s),e.globalAlpha=1-this.transitionProgress,e.drawImage(i,0,0),e.globalAlpha=this.transitionProgress,e.drawImage(o,0,0),e.globalAlpha=1)}applyEasing(e,t){switch(t){case"linear":default:return e;case"ease-in":return e*e;case"ease-out":return e*(2-e);case"ease-in-out":return e<.5?2*e*e:(4-2*e)*e-1}}}Mt(Ft,"instance",void 0);var Ot=s(26998);const Dt=(0,n.forwardRef)(({},e)=>{const t=(0,n.useRef)(null),s=e||t,a=(0,n.useRef)(Ft.getInstance()),r=(0,n.useRef)(!1);return(0,n.useEffect)(()=>{const e=s.current;if(!e)return;const t=e.getContext("2d");if(!t)return;const n=a.current,i=()=>{e.width=window.innerWidth,e.height=window.innerHeight},o=function(e,t){let s=null;return(...a)=>{s&&clearTimeout(s),s=setTimeout(()=>{e(...a),s=null},t)}}(i,250);i(),window.addEventListener("resize",o),r.current||(n.initialize(e,t),n.getThemeMetadata("default")||n.registerTheme({id:"default",factory:()=>new Ot.DefaultTheme,metadata:{id:"default",name:"Classic Sphere",description:"The original 3D particle sphere with smooth color transitions",category:"particle",performanceProfile:"medium",previewColors:["#4285F4","#34A853","#EA4335"],previewDescription:"Rotating particle sphere with dynamic colors"}}),n.switchTheme("default"),r.current=!0);const c=function(e,t){let s=0,a=null;return(...n)=>{const r=Date.now(),i=r-s;i>=t?(s=r,e(...n)):(a&&clearTimeout(a),a=setTimeout(()=>{s=Date.now(),e(...n),a=null},t-i))}}(t=>{const s=e.getBoundingClientRect(),a=t.clientX-s.left,r=t.clientY-s.top;n.setMousePosition(a,r,e.width,e.height)},16),l=()=>{n.setHovering(!0)},d=()=>{n.setHovering(!1)};let u;e.addEventListener("mousemove",c),e.addEventListener("mouseenter",l),e.addEventListener("mouseleave",d);let g=0;const m=1e3/30;let h=0,p=performance.now(),f=30;const x=s=>{const a=s-g;if(a>=m){g=s-a%m;const r=e.width,i=e.height,o=r/2,c=i/2;n.draw(t,r,i,o,c,a),h++;const l=performance.now();l-p>=1e3&&(f=h,h=0,p=l)}u=window.requestAnimationFrame(x)};return u=window.requestAnimationFrame(x),()=>{window.cancelAnimationFrame(u),window.removeEventListener("resize",o),e.removeEventListener("mousemove",c),e.removeEventListener("mouseenter",l),e.removeEventListener("mouseleave",d)}},[]),Dt.getThemeManager=()=>a.current,Dt.onUserSpeaking=()=>a.current.onUserSpeaking(),Dt.onProcessing=()=>a.current.onProcessing(),Dt.onAiSpeaking=()=>a.current.onAiSpeaking(),Dt.reset=()=>a.current.reset(),(0,y.jsx)("canvas",{ref:s,className:"absolute inset-0 w-full h-full",style:{background:"transparent"}})});Dt.displayName="Canvas";const $t=Dt;var Rt=s(9794),Lt=s(35189);const zt=(0,rt.vt)()((0,Lt.Zr)((e,t)=>({selectedVoice:"alloy",selectedPersona:"assistant",isVoiceModalOpen:!1,setVoice:t=>{e({selectedVoice:t})},setPersona:t=>{e({selectedPersona:t})},setVoiceModalOpen:t=>{e({isVoiceModalOpen:t})},getSettings:()=>{const e=t();return{selectedVoice:e.selectedVoice,selectedPersona:e.selectedPersona}}}),{name:"customgpt-voice-settings",partialize:e=>({selectedVoice:e.selectedVoice,selectedPersona:e.selectedPersona})}));function qt({isOpen:e,onClose:t,projectId:s}){const{selectedVoice:a,selectedPersona:r,setVoice:i,setPersona:o}=zt(),{currentAgent:c,updateSettings:l}=((0,Rt.useRouter)(),(0,Ee.o)()),[d,u]=(0,n.useState)(a),[g,m]=(0,n.useState)(r),[h,p]=(0,n.useState)(c?.settings?.chatbot_model||"gpt-3.5-turbo");(0,n.useEffect)(()=>{e&&(u(a),m(r),p(c?.settings?.chatbot_model||"gpt-3.5-turbo"))},[e,a,r,c]);return e?(0,y.jsx)("div",{className:"fixed inset-0 z-[10001] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4",children:(0,y.jsxs)("div",{className:"bg-gray-900 rounded-2xl border border-gray-700 w-full max-w-2xl max-h-[70vh] flex flex-col",children:[(0,y.jsxs)("div",{className:"p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0",children:[(0,y.jsxs)("div",{className:"flex items-center gap-3",children:[(0,y.jsx)(X.A,{className:"w-5 h-5 text-white"}),(0,y.jsx)("h2",{className:"text-lg font-semibold text-white",children:"Voice Settings"})]}),(0,y.jsx)("button",{onClick:t,className:"w-8 h-8 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition-colors",children:(0,y.jsx)(H.A,{className:"w-4 h-4 text-white"})})]}),(0,y.jsx)("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:(0,y.jsxs)("div",{className:"grid grid-cols-1 gap-6",children:[(0,y.jsxs)("div",{children:[(0,y.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,y.jsx)(ge.A,{className:"w-4 h-4 text-white"}),(0,y.jsx)("h3",{className:"text-sm font-semibold text-white uppercase tracking-wider",children:"Voice"})]}),(0,y.jsx)("div",{className:"grid grid-cols-3 gap-2",children:[{id:"alloy",name:"Alloy",desc:"Neutral"},{id:"echo",name:"Echo",desc:"Clear"},{id:"fable",name:"Fable",desc:"Warm"},{id:"onyx",name:"Onyx",desc:"Deep"},{id:"nova",name:"Nova",desc:"Bright"},{id:"shimmer",name:"Shimmer",desc:"Smooth"}].map(e=>(0,y.jsxs)("button",{onClick:()=>u(e.id),className:"p-3 rounded-lg border transition-all text-left "+(d===e.id?"border-blue-500 bg-blue-500/10":"border-gray-600 bg-gray-800/50 hover:bg-gray-700/50"),children:[(0,y.jsx)("div",{className:"text-sm font-medium text-white",children:e.name}),(0,y.jsx)("div",{className:"text-xs text-gray-400",children:e.desc})]},e.id))})]}),(0,y.jsxs)("div",{children:[(0,y.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,y.jsx)(S.A,{className:"w-4 h-4 text-white"}),(0,y.jsx)("h3",{className:"text-sm font-semibold text-white uppercase tracking-wider",children:"Persona"})]}),(0,y.jsx)("div",{className:"grid grid-cols-3 gap-2",children:[{id:"assistant",name:"Assistant",desc:"Helpful"},{id:"creative",name:"Creative",desc:"Artistic"},{id:"analytical",name:"Analytical",desc:"Logical"},{id:"casual",name:"Casual",desc:"Relaxed"},{id:"professional",name:"Professional",desc:"Formal"}].map(e=>(0,y.jsxs)("button",{onClick:()=>m(e.id),className:"p-3 rounded-lg border transition-all text-left "+(g===e.id?"border-purple-500 bg-purple-500/10":"border-gray-600 bg-gray-800/50 hover:bg-gray-700/50"),children:[(0,y.jsx)("div",{className:"text-sm font-medium text-white",children:e.name}),(0,y.jsx)("div",{className:"text-xs text-gray-400",children:e.desc})]},e.id))})]}),s&&c&&(0,y.jsxs)("div",{children:[(0,y.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,y.jsx)(X.A,{className:"w-4 h-4 text-white"}),(0,y.jsx)("h3",{className:"text-sm font-semibold text-white uppercase tracking-wider",children:"Model"})]}),(0,y.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,y.jsxs)("button",{onClick:()=>p("gpt-3.5-turbo"),className:"p-3 rounded-lg border transition-all text-left "+("gpt-3.5-turbo"===h?"border-green-500 bg-green-500/10":"border-gray-600 bg-gray-800/50 hover:bg-gray-700/50"),children:[(0,y.jsx)("div",{className:"text-sm font-medium text-white",children:"GPT-3.5"}),(0,y.jsx)("div",{className:"text-xs text-gray-400",children:"Fast"})]}),(0,y.jsxs)("button",{onClick:()=>p("gpt-4"),className:"p-3 rounded-lg border transition-all text-left "+("gpt-4"===h?"border-green-500 bg-green-500/10":"border-gray-600 bg-gray-800/50 hover:bg-gray-700/50"),children:[(0,y.jsx)("div",{className:"text-sm font-medium text-white",children:"GPT-4"}),(0,y.jsx)("div",{className:"text-xs text-gray-400",children:"Powerful"})]}),(0,y.jsxs)("button",{onClick:()=>p("gpt-4-o"),className:"p-3 rounded-lg border transition-all text-left "+("gpt-4-o"===h?"border-green-500 bg-green-500/10":"border-gray-600 bg-gray-800/50 hover:bg-gray-700/50"),children:[(0,y.jsx)("div",{className:"text-sm font-medium text-white",children:"GPT-4o"}),(0,y.jsx)("div",{className:"text-xs text-gray-400",children:"Optimized"})]}),(0,y.jsxs)("button",{onClick:()=>p("claude-3-opus"),className:"p-3 rounded-lg border transition-all text-left "+("claude-3-opus"===h?"border-green-500 bg-green-500/10":"border-gray-600 bg-gray-800/50 hover:bg-gray-700/50"),children:[(0,y.jsx)("div",{className:"text-sm font-medium text-white",children:"Claude 3 Opus"}),(0,y.jsx)("div",{className:"text-xs text-gray-400",children:"Powerful"})]}),(0,y.jsxs)("button",{onClick:()=>p("claude-3-sonnet"),className:"p-3 rounded-lg border transition-all text-left "+("claude-3-sonnet"===h?"border-green-500 bg-green-500/10":"border-gray-600 bg-gray-800/50 hover:bg-gray-700/50"),children:[(0,y.jsx)("div",{className:"text-sm font-medium text-white",children:"Claude 3 Sonnet"}),(0,y.jsx)("div",{className:"text-xs text-gray-400",children:"Balanced"})]}),(0,y.jsxs)("button",{onClick:()=>p("claude-3-haiku"),className:"p-3 rounded-lg border transition-all text-left "+("claude-3-haiku"===h?"border-green-500 bg-green-500/10":"border-gray-600 bg-gray-800/50 hover:bg-gray-700/50"),children:[(0,y.jsx)("div",{className:"text-sm font-medium text-white",children:"Claude 3 Haiku"}),(0,y.jsx)("div",{className:"text-xs text-gray-400",children:"Fast"})]})]}),(0,y.jsx)("p",{className:"text-xs text-gray-400 mt-2",children:"Recommended for voice: Mini models provide faster responses"})]})]})}),(0,y.jsxs)("div",{className:"p-4 border-t border-gray-700 flex justify-end gap-3 flex-shrink-0",children:[(0,y.jsx)("button",{onClick:()=>{u(a),m(r),p(c?.settings?.chatbot_model||"gpt-3.5-turbo"),t()},className:"px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white text-sm transition-colors",children:"Cancel"}),(0,y.jsx)("button",{onClick:async()=>{if(i(d),o(g),c&&h!==c.settings?.chatbot_model)try{await l(c.id,{chatbot_model:h})}catch(e){}t()},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white text-sm transition-colors",children:"Save Settings"})]})]})}):null}function Ut(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class Gt{constructor(){Ut(this,"audioQueue",[]),Ut(this,"pendingChunks",new Map),Ut(this,"nextExpectedChunkId",0),Ut(this,"isPlaying",!1),Ut(this,"audioContext",null),Ut(this,"currentSource",null),Ut(this,"onPlaybackComplete",void 0),Ut(this,"onError",void 0),this.initAudioContext()}async initAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),"suspended"===this.audioContext.state&&await this.audioContext.resume()}catch(e){}}async addTextChunk(e,t="alloy"){try{const s=await this.textToSpeech(e,t);this.audioQueue.push(s),this.isPlaying||this.playNextChunk()}catch(e){this.onError?.("Failed to generate speech for chunk")}}async addAudioBuffer(e){try{this.audioQueue.push(e),this.isPlaying||this.playNextChunk()}catch(e){this.onError?.("Failed to queue audio buffer")}}async addAudioBufferWithId(e,t){try{for(this.pendingChunks.set(t,e);this.pendingChunks.has(this.nextExpectedChunkId);){const e=this.pendingChunks.get(this.nextExpectedChunkId);this.pendingChunks.delete(this.nextExpectedChunkId),this.audioQueue.push(e),this.nextExpectedChunkId++,this.isPlaying||this.playNextChunk()}}catch(e){this.onError?.("Failed to queue audio buffer")}}async textToSpeech(e,t){if(!e.trim())throw new Error("Empty text provided");const s=await fetch("/api/proxy/tts/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"tts-1",input:e,voice:t,response_format:"mp3"})});if(!s.ok)throw new Error(`TTS API error: ${s.status}`);const a=await s.blob(),n=await a.arrayBuffer();if(!this.audioContext)throw new Error("AudioContext not initialized");return await this.audioContext.decodeAudioData(n)}async playNextChunk(){if(0===this.audioQueue.length)return this.isPlaying=!1,void this.onPlaybackComplete?.();if(!this.audioContext)return;this.isPlaying=!0;const e=this.audioQueue.shift();if(e)try{this.currentSource=this.audioContext.createBufferSource(),this.currentSource.buffer=e,this.currentSource.connect(this.audioContext.destination),this.currentSource.onended=()=>{this.currentSource=null,setTimeout(()=>{this.playNextChunk()},50)},this.currentSource.start(0)}catch(e){setTimeout(()=>{this.playNextChunk()},100)}}stopPlayback(){if(this.currentSource){try{this.currentSource.stop()}catch(e){}this.currentSource=null}this.audioQueue=[],this.pendingChunks.clear(),this.nextExpectedChunkId=0,this.isPlaying=!1}resetChunkCounter(){this.nextExpectedChunkId=0,this.pendingChunks.clear()}isCurrentlyPlaying(){return this.isPlaying}getQueueLength(){return this.audioQueue.length}onPlaybackCompleted(e){this.onPlaybackComplete=e}onStreamingError(e){this.onError=e}destroy(){this.stopPlayback(),this.pendingChunks.clear(),this.nextExpectedChunkId=0,this.audioContext&&(this.audioContext.close(),this.audioContext=null)}}function Bt(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const Vt=new class{constructor(){Bt(this,"source",null),Bt(this,"sourceIsStarted",!1),Bt(this,"conversationThusFar",[]),Bt(this,"callbacks",{}),Bt(this,"projectId",null),Bt(this,"sessionId",null),Bt(this,"voiceSettings",null),Bt(this,"streamingTTS",null),Bt(this,"chatbotModel","gpt-3.5-turbo"),Bt(this,"onSpeechStart",()=>{this.debug("Speech started - user is speaking"),this.callbacks.onUserSpeaking?.(),this.stopSourceIfNeeded()}),Bt(this,"onSpeechEnd",async e=>{this.debug("Speech ended",{audioLength:e.length,audioDuration:e.length/16e3+"s"}),await this.processAudio(e)}),Bt(this,"onMisfire",()=>{this.debug("VAD misfire - noise detected but not speech"),this.callbacks.onReset?.()}),Bt(this,"stopSourceIfNeeded",()=>{this.source&&this.sourceIsStarted&&(this.debug("Stopping current audio playback"),this.source.stop(0),this.sourceIsStarted=!1)}),Bt(this,"stopAudio",()=>{this.stopSourceIfNeeded(),this.streamingTTS&&(this.streamingTTS.stopPlayback(),this.debug("ðŸ›‘ Streaming TTS stopped")),this.callbacks.onReset?.(),this.debug("Audio stopped by user")}),Bt(this,"processManualAudio",async e=>{this.debug("Processing manual audio",{size:`${(e.size/1024).toFixed(2)}KB`,type:e.type}),this.callbacks.onProcessing?.();try{await this.validate(e),await this.sendData(e)}catch(e){this.error("Error processing manual audio",e),this.callbacks.onReset?.()}}),Bt(this,"processAudio",async e=>{this.debug("Processing audio started"),this.callbacks.onProcessing?.();try{const t=this.createAudioBlob(e);await this.validate(t),await this.sendData(t)}catch(e){this.error("Error processing audio",e),this.callbacks.onReset?.()}}),Bt(this,"createAudioBlob",e=>{const t=kt.utils.encodeWAV(e),s=new Blob([t],{type:"audio/wav"});return this.debug("Created audio blob",{size:`${(s.size/1024).toFixed(2)}KB`,type:s.type,samples:e.length,duration:e.length/16e3+"s"}),s}),Bt(this,"sendData",async e=>{await this.sendStreamingData(e)}),Bt(this,"sendStreamingData",async e=>{if(this.debug("ðŸš€ Sending audio data to streaming API"),!this.projectId)return this.error("No project ID set - cannot send audio"),void this.callbacks.onReset?.();this.streamingTTS?this.streamingTTS.resetChunkCounter():(this.streamingTTS=new Gt,this.streamingTTS.onPlaybackCompleted(()=>{this.debug("ðŸ”„ Streaming playback completed"),this.callbacks.onReset?.()}),this.streamingTTS.onStreamingError(e=>{this.error("ðŸŽµ Streaming TTS error",e)}));const t=new FormData;t.append("audio",e,"audio.wav"),t.append("project_id",this.projectId),this.sessionId&&t.append("session_id",this.sessionId),this.voiceSettings&&(t.append("voice",this.voiceSettings.voice),t.append("persona",this.voiceSettings.persona)),this.debug("ðŸ”„ Starting streaming voice request",{projectId:this.projectId,sessionId:this.sessionId,conversationLength:this.conversationThusFar.length,audioSize:`${(e.size/1024).toFixed(2)}KB`,voice:this.voiceSettings?.voice,persona:this.voiceSettings?.persona,lastMessages:this.conversationThusFar.slice(-2).map(e=>({role:e.role,preview:e.content.slice(0,50)}))});try{const e={conversation:this.base64Encode(JSON.stringify(this.conversationThusFar))},s=localStorage.getItem("customgpt.deploymentMode")||"production";e["X-Deployment-Mode"]=s,"demo"===s&&(window.__demoOpenAIKey&&(e["X-OpenAI-API-Key"]=window.__demoOpenAIKey),window.__demoCustomGPTKey&&(e["X-CustomGPT-API-Key"]=window.__demoCustomGPTKey));const a=await fetch("/api/proxy/voice/streaming",{method:"POST",body:t,headers:e});if(this.debug("ðŸŽ¯ Streaming response received",{status:a.status,ok:a.ok,contentType:a.headers.get("content-type")}),!a.ok){const e=await a.text();let t;try{t=JSON.parse(e)}catch{t={error:e}}if(503===a.status&&t.userMessage)throw new Error(t.userMessage);throw new Error(`Streaming API Error (${a.status}): ${t.error||e}`)}await this.processStreamingResponse(a)}catch(e){this.error("âŒ Failed to process streaming voice",e),this.handleError(e)}}),Bt(this,"processStreamingResponse",async e=>{if(!e.body)throw new Error("No response body for streaming");const t=e.body.getReader(),s=new TextDecoder;let a="",n="",r=!1;this.debug("ðŸ”„ Processing streaming response chunks");try{for(;;){const{done:e,value:i}=await t.read();if(e){this.debug("âœ… Streaming response complete");break}const o=s.decode(i).split("\n");for(const e of o)if(e.startsWith("data: ")){const t=e.slice(6);if(""===t.trim())continue;try{const e=JSON.parse(t);"text"===e.type?(a+=e.text,this.callbacks.onStreamingTextChunk?.(e.text),this.debug(`ðŸ“ Text chunk received: "${e.text}"`)):"audio"===e.type||"audio_ref"===e.type?(e.audioUrl||e.audioId)&&(r||(this.callbacks.onAiSpeaking?.(),r=!0),e.audioUrl?await this.queueAudioChunk(e.audioUrl,e.chunkId):e.audioId&&await this.queueAudioChunkById(e.audioId,e.chunkId),this.debug(`ðŸŽµ Audio chunk queued: ${e.chunkId} (${e.text?.slice(0,50)}...)`)):"complete"===e.type?(a=e.fullResponse||a,n=e.transcript||n,this.debug("âœ… Stream complete",{responseLength:a.length,transcript:n}),n&&this.callbacks.onTranscriptReceived?.(n),a&&this.callbacks.onResponseReceived?.(a),this.callbacks.onStreamingComplete?.(a,n)):"error"===e.type&&(this.error(`ðŸš¨ Stream error: ${e.error}`),this.callbacks.onReset?.())}catch(e){this.debug(`âš ï¸ Failed to parse chunk: ${t}`,e)}}}}catch(e){this.error("âŒ Error processing streaming response",e),this.callbacks.onReset?.()}finally{t.releaseLock()}}),Bt(this,"queueAudioChunk",async(e,t)=>{if(this.streamingTTS)try{const s=parseInt(t.replace("chunk_","")),a=await fetch(e),n=await a.blob(),r=await n.arrayBuffer(),i=new(window.AudioContext||window.webkitAudioContext),o=await i.decodeAudioData(r);await this.streamingTTS.addAudioBufferWithId(o,s),this.debug(`ðŸŽµ Audio chunk queued with ID ${s}: ${t}`)}catch(e){this.error(`âŒ Failed to queue audio chunk ${t}`,e)}else this.error("âŒ StreamingTTS not initialized")}),Bt(this,"queueAudioChunkById",async(e,t)=>{if(this.streamingTTS)try{const s=parseInt(t.replace("chunk_","")),a=await fetch(`/api/proxy/voice/streaming?id=${e}`);if(!a.ok){if(404===a.status)return void this.debug(`âš ï¸ Audio chunk not found (server may have restarted): ${t}`);throw new Error(`Failed to fetch audio chunk: ${a.status}`)}const n=await a.blob(),r=await n.arrayBuffer(),i=new(window.AudioContext||window.webkitAudioContext),o=await i.decodeAudioData(r);await this.streamingTTS.addAudioBufferWithId(o,s),this.debug(`ðŸŽµ Audio chunk fetched and queued with ID ${s}: ${t}`)}catch(e){this.error(`âŒ Failed to fetch/queue audio chunk ${t}`,e)}else this.error("âŒ StreamingTTS not initialized")}),Bt(this,"handleSuccess",async e=>{this.debug("Playing AI response audio");try{const t=new(window.AudioContext||window.webkitAudioContext);this.stopSourceIfNeeded();const s=await e.arrayBuffer(),a=await t.decodeAudioData(s);this.debug("Audio decoded",{duration:`${a.duration.toFixed(2)}s`,sampleRate:a.sampleRate,numberOfChannels:a.numberOfChannels}),this.source=t.createBufferSource(),this.source.buffer=a,this.source.connect(t.destination),this.source.start(0),this.sourceIsStarted=!0,this.source.onended=()=>{this.debug("Audio playback ended"),this.callbacks.onReset?.()},this.callbacks.onAiSpeaking?.()}catch(e){this.error("Failed to play audio",e),this.callbacks.onReset?.()}}),Bt(this,"handleError",e=>{this.error(`Error encountered: ${e.message}`,e),this.callbacks.onReset?.()}),Bt(this,"validate",async e=>{this.debug("Validating audio duration");try{const t=new Blob([e],{type:e.type}),s=await t.arrayBuffer(),a=new AudioContext,n=(await a.decodeAudioData(s)).duration,r=.4;if(this.debug("Audio validation",{duration:`${n.toFixed(2)}s`,minDuration:`${r}s`,valid:n>=r}),n<r)throw new Error(`Duration is ${n}s, which is less than minimum of ${r}s`)}catch(e){throw this.error("Audio validation failed",e),e}})}setCallbacks(e){this.callbacks=e,this.debug("Callbacks set",{hasCallbacks:Object.keys(e)})}setProjectId(e){this.projectId=e,this.debug("Project ID set",{projectId:e})}setSessionId(e){this.sessionId=e,this.debug("Session ID set",{sessionId:e})}setVoiceSettings(e,t){this.voiceSettings={voice:e,persona:t},this.debug("Voice settings set",{voice:e,persona:t})}setChatbotModel(e){this.chatbotModel=e,this.debug("Chatbot model set",{model:e})}debug(e,t){this.callbacks.onDebug?.(e,t)}error(e,t){(new Date).toISOString();this.callbacks.onError?.(e)}base64Encode(e){const t=(new TextEncoder).encode(e);return window.btoa(String.fromCharCode(...new Uint8Array(t)))}base64Decode(e){const t=window.atob(e),s=new Uint8Array([...t].map(e=>e.charCodeAt(0)));return(new TextDecoder).decode(s)}clearConversation(){this.conversationThusFar=[]}getConversationThusFar(){return this.conversationThusFar}getSessionId(){return this.sessionId}setConversationHistory(e){const t=e.filter((e,t,s)=>t===s.findIndex(t=>t.content===e.content&&t.role===e.role)).map(e=>({role:e.role,content:e.content}));this.conversationThusFar=t,this.debug("Conversation history loaded",{messageCount:this.conversationThusFar.length,originalCount:e.length})}destroy(){this.stopAudio(),this.streamingTTS&&(this.streamingTTS.destroy(),this.streamingTTS=null),this.debug("ðŸ§¹ SpeechManager destroyed")}};function Kt(e){return e.replace(/\*\*(.*?)\*\*/g,"$1").replace(/\*(.*?)\*/g,"$1").replace(/```[\s\S]*?```/g,"").replace(/`([^`]+)`/g,"$1").replace(/#{1,6}\s+/g,"").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/!\[([^\]]*)\]\([^)]+\)/g,"").replace(/^-{3,}$/gm,"").replace(/^\s*[-*+]\s+/gm,"").replace(/^\s*\d+\.\s+/gm,"").replace(/\n{3,}/g,"\n\n").trim()}function Ht(e,t){let s="";for(let a=0;a<e.length;a++)s+=String.fromCharCode(e.charCodeAt(a)^t.charCodeAt(a%t.length));return btoa(s)}function Jt(e,t){try{const s=atob(e);let a="";for(let e=0;e<s.length;e++)a+=String.fromCharCode(s.charCodeAt(e)^t.charCodeAt(e%t.length));return a}catch{return""}}function Yt(e){const t=e.trim();if(!t.includes("|"))return!1;const[s,a]=t.split("|");return!(!s||!/^\d+$/.test(s))&&!(!a||a.length<20)}const Wt="customgpt-demo-key",Xt="customgpt-demo-openai-key",Qt="customgpt-demo-enc",Zt="customgpt-demo-session",es=72e5,ts=(0,rt.vt)((e,t)=>({isDemoMode:"undefined"!=typeof window&&"demo"===localStorage.getItem("customgpt.deploymentMode"),apiKey:null,openAIApiKey:null,encryptionKey:null,isAuthenticated:!1,error:null,sessionStartTime:null,sessionTimeout:es,setApiKey:t=>{const s=t.trim();if(Yt(s))try{const t=function(){const e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}(),a=Ht(s,t);sessionStorage.setItem(Wt,a),sessionStorage.setItem(Qt,t);const n={startTime:Date.now(),encKey:t};sessionStorage.setItem(Zt,JSON.stringify(n)),e({apiKey:s,encryptionKey:t,isAuthenticated:!0,error:null,sessionStartTime:Date.now()})}catch(t){e({error:"Failed to store API key"})}else e({error:"Invalid API key format"})},setOpenAIApiKey:s=>{const a=s.trim(),n=t();if(n.isAuthenticated)if(!a||a.startsWith("sk-"))try{const t=n.encryptionKey;if(!t)return void e({error:"Encryption key not found"});if(a){const s=Ht(a,t);sessionStorage.setItem(Xt,s),e({openAIApiKey:a,error:null})}else sessionStorage.removeItem(Xt),e({openAIApiKey:null,error:null})}catch(t){e({error:"Failed to store OpenAI API key"})}else e({error:"Invalid OpenAI API key format"});else e({error:"Please enter CustomGPT.ai API key first"})},clearApiKey:()=>{sessionStorage.removeItem(Wt),sessionStorage.removeItem(Xt),sessionStorage.removeItem(Qt),sessionStorage.removeItem(Zt),e({apiKey:null,openAIApiKey:null,encryptionKey:null,isAuthenticated:!1,error:null,sessionStartTime:null})},validateSession:()=>{const e=t();if(e.sessionStartTime){if(Date.now()-e.sessionStartTime>e.sessionTimeout)return e.clearApiKey(),e.setError("Session expired. Please enter your API key again."),!1}return e.isAuthenticated},setError:t=>{e({error:t})},initializeFromStorage:()=>{const e=t();e.isDemoMode&&e.restoreSession()},restoreSession:()=>{const s=t();try{const t=sessionStorage.getItem(Zt);if(!t)return!1;const a=JSON.parse(t),{startTime:n,encKey:r}=a;if(Date.now()-n>es)return s.clearApiKey(),s.setError("Session expired. Please enter your API key again."),!1;const i=sessionStorage.getItem(Wt),o=sessionStorage.getItem(Xt);if(!i||!r)return!1;const c=Jt(i,r);if(!c||!Yt(c))return s.clearApiKey(),!1;let l=null;return o&&(l=Jt(o,r)),e({apiKey:c,openAIApiKey:l,encryptionKey:r,isAuthenticated:!0,sessionStartTime:n,error:null}),!0}catch{return s.clearApiKey(),!1}}}));"undefined"!=typeof window&&(document.addEventListener("visibilitychange",()=>{document.hidden}),setInterval(()=>{const{validateSession:e}=ts.getState();e()},6e4));var ss=s(95367);function as({isOpen:e,onClose:t,projectId:a,projectName:r}){const[i,o]=(0,n.useState)(!0),[l,d]=(0,n.useState)(""),[u,g]=(0,n.useState)(""),[m,h]=(0,n.useState)(!1),[p,f]=(0,n.useState)(null),[x,v]=(0,n.useState)(!1),[b,w]=(0,n.useState)(!1),[S,j]=(0,n.useState)(!1),[C,N]=(0,n.useState)("idle"),[A,_]=((0,n.useRef)(null),(0,n.useState)(!1)),[I,k]=(0,n.useState)(""),{addMessage:E,messages:P,loadMessages:T}=At(),{currentConversation:M,ensureConversation:F,updateConversation:O}=_t(),[D,$]=(0,n.useState)(null),[R,L]=(0,n.useState)(null),z=(0,n.useRef)(!1),{selectedVoice:q,selectedPersona:U,setVoiceModalOpen:G}=zt(),{isDemoMode:B,openAIApiKey:V}=ts(),K=(0,n.useCallback)(()=>!("demo"===(localStorage.getItem("customgpt.deploymentMode")||"production")&&!V),[V]),J=(0,kt.useMicVAD)({preSpeechPadFrames:10,positiveSpeechThreshold:.8,negativeSpeechThreshold:.6,minSpeechFrames:3,startOnLoad:!1,workletURL:"/vad.worklet.bundle.min.js",modelURL:"/silero_vad.onnx",onSpeechStart:()=>{Vt.onSpeechStart()},onSpeechEnd:e=>{Vt.onSpeechEnd(e)},onVADMisfire:()=>{Vt.onMisfire()}});(0,n.useEffect)(()=>{G(e),e||(z.current=!1,L(null),setTimeout(()=>{G(!1)},100))},[e,G]),(0,n.useEffect)(()=>{if(e&&a){if(Vt.setProjectId(a),Vt.setVoiceSettings(q,U),B){V&&(window.__demoOpenAIKey=V);const e=ts.getState().apiKey;e&&(window.__demoCustomGPTKey=e)}const e=Ee.o.getState().agents.find(e=>e.id===parseInt(a));e&&e.is_chat_active,e?.settings?.chatbot_model?Vt.setChatbotModel(e.settings.chatbot_model):Vt.setChatbotModel("gpt-3.5-turbo");(async()=>{if(!z.current)try{z.current=!0;let e=M;if(e||R)e?L(e):R&&(e=R);else{e=await F(parseInt(a),"Voice Conversation");try{await O(e.id,e.session_id,{name:"Voice Conversation"})}catch(e){}L(e)}if(!e)return;const t=(P.get(e.id.toString())||[]).filter((e,t,s)=>t===s.findIndex(t=>t.id===e.id)).sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime());Vt.setConversationHistory(t),Vt.setSessionId(e.session_id)}catch(e){}finally{z.current=!1}})(),Vt.setCallbacks({onUserSpeaking:()=>{$t.onUserSpeaking?.(),d(""),k(""),_(!1),N("recording")},onProcessing:async()=>{$t.onProcessing?.(),N("processing");const e={id:(0,c.$C)(),role:"user",content:"ðŸŽ¤ Processing voice input...",timestamp:(new Date).toISOString(),status:"sending"};$(e.id);const t=R||M;t&&E(t.id.toString(),e)},onAiSpeaking:()=>{$t.onAiSpeaking?.(),w(!0),N("speaking")},onReset:()=>{$t.reset?.(),w(!1),_(!1),N("idle")},onDebug:(e,t)=>{},onError:e=>{if(e.includes("OpenAI API key")||e.includes("API key")){v(!0);const e="demo"===("undefined"!=typeof window?localStorage.getItem("customgpt.deploymentMode"):null)?"Voice feature requires an OpenAI API key. Please enable voice capability in demo settings and provide your OpenAI API key.":"Voice feature requires OpenAI API key configuration. Please add OPENAI_API_KEY to your .env.local file.";Promise.resolve().then(s.bind(s,31681)).then(({toast:t})=>{t.error(e)})}_(!1),N("idle")},onTranscriptReceived:async e=>{d(e);const t=R||M;if(t){if((P.get(t.id.toString())||[]).length<=1){const s=t.name||"";if(!s||"New voice conversation"===s||"New Conversation"===s||"Processing..."===s||s.startsWith("Chat ")||s.startsWith("OpenAI-")||s.includes("OpenAI-")){let s="Voice Conversation";if(e&&e.length>0){const t=e.replace(/^(OpenAI-|System-|API-|Assistant:|User:)\s*/i,"").trim();if(t.length>0){const e=t.split(/\s+/).slice(0,6).join(" ");s=`Voice: ${e.length>40?e.substring(0,40).trim()+"...":e}`}}try{await O(t.id,t.session_id,{name:s})}catch(e){}}}}if(t&&D){const s={id:D,role:"user",content:e,timestamp:(new Date).toISOString(),status:"sent"};E(t.id.toString(),s)}else{const t=R||M;if(!t)return;const s={id:(0,c.$C)(),role:"user",content:e,timestamp:(new Date).toISOString(),status:"sent"};$(s.id),E(t.id.toString(),s)}},onResponseReceived:async e=>{const t=R||M;if(t){const s={id:(0,c.$C)(),role:"assistant",content:e,timestamp:(new Date).toISOString(),status:"sent",citations:[]};E(t.id.toString(),s);P.get(t.id.toString())}},onStreamingTextChunk:e=>{_(!0),k(t=>{const s=t+e,a=Kt(s);return g(a),s})},onStreamingAudioReady:(e,t)=>{"speaking"!==C&&(N("speaking"),w(!0))},onStreamingComplete:(e,t)=>{const s=Kt(e);g(s),k(e),_(!1)}})}e||(d(""),g(""),k(""),_(!1),w(!1),L(null),N("idle"),$(null),window.__demoOpenAIKey&&delete window.__demoOpenAIKey,window.__demoCustomGPTKey&&delete window.__demoCustomGPTKey,J.listening&&J.pause(),Vt.destroy(),G(!1),M&&T(M.id.toString()))},[e,a,M,P,q,U,B,V,T]),(0,n.useEffect)(()=>{if(e&&a){Vt.setVoiceSettings(q,U);const e=Ee.o.getState().agents.find(e=>e.id===parseInt(a));e?.settings?.chatbot_model&&Vt.setChatbotModel(e.settings.chatbot_model)}},[q,U,e,a]),(0,n.useEffect)(()=>{J.errored||!J.loading&&J.errored},[J.loading,J.errored]);const Y=(0,n.useCallback)(async()=>{if(!K()){v(!0);const e="demo"===(localStorage.getItem("customgpt.deploymentMode")||"production")?"Voice feature requires an OpenAI API key. Please enable voice capability in demo settings and provide your OpenAI API key.":"Voice feature requires OpenAI API key. Please add OPENAI_API_KEY to your .env.local file.";return void Promise.resolve().then(s.bind(s,31681)).then(({toast:t})=>{t.error(e)})}if(J.errored)try{return void setTimeout(()=>{J.listening||J.loading||J.start()},1e3)}catch(e){return}try{if(J.listening)J.pause(),N("idle");else{N("listening");try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop())}catch(e){e instanceof Error&&e.message}try{J.start()}catch(e){e instanceof Error&&e.message}}}catch(e){}},[J,K]),W=(0,n.useCallback)(async()=>{if(!K()){v(!0);const e="demo"===(localStorage.getItem("customgpt.deploymentMode")||"production")?"Voice feature requires an OpenAI API key. Please enable voice capability in demo settings and provide your OpenAI API key.":"Voice feature requires OpenAI API key. Please add OPENAI_API_KEY to your .env.local file.";return void Promise.resolve().then(s.bind(s,31681)).then(({toast:t})=>{t.error(e)})}try{if(m)p&&p.stop();else{N("recording");const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:48e3}}),t=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":"audio/webm",s=new MediaRecorder(e,{mimeType:t}),a=[];s.ondataavailable=e=>{e.data.size>0&&a.push(e.data)},s.onstop=async()=>{const t=new Blob(a,{type:s.mimeType||"audio/webm"});try{const e=new AudioContext,s=await t.arrayBuffer(),a=await e.decodeAudioData(s),n=a.getChannelData(0);let r;if(16e3!==a.sampleRate){const e=16e3/a.sampleRate,t=Math.floor(n.length*e);r=new Float32Array(t);for(let s=0;s<t;s++){const t=s/e,a=Math.floor(t),i=Math.min(a+1,n.length-1),o=t-a;r[s]=n[a]*(1-o)+n[i]*o}}else r=new Float32Array(n);Vt.onSpeechStart(),await Vt.onSpeechEnd(r),await e.close()}catch(e){}e.getTracks().forEach(e=>e.stop()),h(!1),f(null)},f(s),h(!0),s.start()}}catch(e){}},[m,p,K]),[Q,Z]=(0,n.useState)(!1),ee=(0,n.useCallback)(()=>{Vt.stopAudio(),w(!1)},[]);return(0,n.useEffect)(()=>{J.errored||(e&&!J.loading&&!J.listening&&J.errored,e&&!J.loading&&J.errored&&Q&&setTimeout(()=>{J.errored&&!J.listening&&Y()},1500),!e&&J.listening&&J.pause())},[e,J.loading,J.listening,J.errored,Q]),(0,n.useEffect)(()=>{e&&(Z(!1),v(!1),d(""),g(""),k(""),_(!1),w(!1),L(null))},[e]),(0,n.useEffect)(()=>{o(J.loading)},[J.loading]),(0,y.jsxs)(y.Fragment,{children:[e&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)("style",{jsx:!0,global:!0,children:"\n            /* Custom scrollbar styles for voice modal */\n            .voice-response-scroll::-webkit-scrollbar {\n              width: 6px;\n            }\n            \n            .voice-response-scroll::-webkit-scrollbar-track {\n              background: rgba(255, 255, 255, 0.1);\n              border-radius: 3px;\n            }\n            \n            .voice-response-scroll::-webkit-scrollbar-thumb {\n              background: rgba(255, 255, 255, 0.3);\n              border-radius: 3px;\n            }\n            \n            .voice-response-scroll::-webkit-scrollbar-thumb:hover {\n              background: rgba(255, 255, 255, 0.5);\n            }\n            \n            /* Firefox scrollbar */\n            .voice-response-scroll {\n              scrollbar-width: thin;\n              scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1);\n            }\n            \n            /* Mobile touch scrolling optimization */\n            .voice-response-scroll {\n              -webkit-overflow-scrolling: touch;\n              scroll-behavior: smooth;\n            }\n          "}),(0,y.jsxs)("div",{className:"fixed top-4 sm:top-6 md:top-8 right-4 sm:right-6 md:right-8 flex items-center gap-2 sm:gap-3 z-[10000]",style:{pointerEvents:"auto"},children:[(0,y.jsx)("button",{onClick:e=>{e.preventDefault(),e.stopPropagation(),j(!0)},className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white/10 hover:bg-white/20 active:bg-white/30 backdrop-blur-sm flex items-center justify-center transition-all transform active:scale-95","aria-label":"Voice settings",children:(0,y.jsx)(X.A,{className:"w-5 h-5 sm:w-6 sm:h-6 text-white"})}),(0,y.jsx)("button",{onClick:e=>{e.preventDefault(),e.stopPropagation(),t()},className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white/10 hover:bg-white/20 active:bg-white/30 backdrop-blur-sm flex items-center justify-center transition-all transform active:scale-95","aria-label":"Close voice mode",children:(0,y.jsx)(H.A,{className:"w-5 h-5 sm:w-6 sm:h-6 text-white"})})]}),(0,y.jsxs)("div",{className:"fixed inset-0 z-[9999] overflow-hidden",children:[(0,y.jsx)("div",{className:"absolute inset-0 transition-all duration-1000 pointer-events-none "+("idle"===C?"voice-gradient-idle":"listening"===C?"voice-gradient-listening":"recording"===C?"voice-gradient-recording":"processing"===C?"voice-gradient-processing":"voice-gradient-speaking")}),("processing"===C||"speaking"===C)&&(0,y.jsx)("div",{className:"absolute inset-0 voice-overlay-wave pointer-events-none"}),"recording"===C&&(0,y.jsx)("div",{className:"absolute inset-0 bg-red-500/10 voice-overlay-pulse pointer-events-none"}),i?(0,y.jsx)("div",{className:"flex items-center justify-center h-full relative z-10",children:(0,y.jsx)(Pt(),{loading:i,color:"#ffffff","aria-label":"Loading Voice","data-testid":"loader"})}):(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)("div",{className:"absolute inset-0 pointer-events-none z-0",children:(0,y.jsx)($t,{})}),(0,y.jsxs)("div",{className:"absolute top-4 sm:top-6 md:top-8 left-4 sm:left-6 md:left-8 z-20 space-y-2",children:[B&&(0,y.jsxs)("div",{className:"bg-amber-500/20 backdrop-blur-sm rounded-lg px-3 py-2 text-amber-300 text-xs flex items-center gap-2 border border-amber-500/30",children:[(0,y.jsx)(ss.A,{className:"w-3 h-3"}),(0,y.jsx)("span",{className:"font-medium",children:"Demo Mode"})]}),(0,y.jsxs)("div",{className:"bg-white/5 backdrop-blur-sm rounded-lg px-3 py-2 text-white/70 text-xs space-y-1",children:[(0,y.jsxs)("div",{children:["Voice: ",q]}),(0,y.jsxs)("div",{children:["Persona: ",U]}),(0,y.jsxs)("div",{children:["Model: ",(()=>{const e=Ee.o.getState().agents.find(e=>e.id===parseInt(a));return e?.settings?.chatbot_model||"gpt-3.5-turbo"})()]})]})]}),(0,y.jsxs)("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white text-center px-4 z-10 pointer-events-auto max-w-full",style:{maxHeight:"80vh",display:"flex",flexDirection:"column"},children:[(0,y.jsxs)("div",{className:"relative",children:[(0,y.jsx)("p",{className:"text-2xl sm:text-3xl md:text-4xl font-light mb-4 leading-tight transition-all duration-300 "+("recording"===C?"text-red-400":"processing"===C?"text-purple-400":"speaking"===C?"text-green-400":"listening"===C?"text-blue-400":"text-white/90"),children:m?"Analyzing...":"listening"===C?"Listening...":"processing"===C?"Thinking...":"speaking"===C?"Speaking...":J.loading?"Initializing...":"Ready to chat"}),"processing"===C&&(0,y.jsxs)("div",{className:"flex justify-center gap-1 mt-2",children:[(0,y.jsx)("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),(0,y.jsx)("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),(0,y.jsx)("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]}),l&&(0,y.jsxs)("div",{className:"mb-4 sm:mb-6",children:[(0,y.jsx)("p",{className:"text-xs sm:text-sm text-white/70 mb-1",children:"You said:"}),(0,y.jsxs)("p",{className:"text-sm sm:text-lg text-white/90 max-w-xs sm:max-w-md mx-auto px-2",children:["â€œ",l,"â€"]})]}),u&&(0,y.jsxs)("div",{className:"animate-fade-in pointer-events-auto",children:[(0,y.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,y.jsx)("p",{className:"text-xs text-white/70",children:"Agent:"}),A&&(0,y.jsxs)("div",{className:"flex items-center gap-1",children:[(0,y.jsx)("div",{className:"w-1.5 h-1.5 bg-blue-400 rounded-full animate-pulse"}),(0,y.jsx)("span",{className:"text-xs text-blue-400/70",children:"streaming..."})]})]}),(0,y.jsx)("div",{className:"voice-response-scroll max-h-[40vh] sm:max-h-[50vh] overflow-y-auto overflow-x-hidden px-4 py-2 -mx-2 rounded-lg bg-white/5 relative",children:(0,y.jsxs)("p",{className:"text-sm sm:text-base text-white max-w-xs sm:max-w-md mx-auto leading-relaxed break-words whitespace-pre-wrap",children:[u,A&&(0,y.jsx)("span",{className:"inline-block w-2 h-4 bg-white/60 ml-1 animate-pulse"})]})}),"speaking"===C&&(0,y.jsx)("div",{className:"flex justify-center items-center gap-1 mt-4",children:[...Array(5)].map((e,t)=>(0,y.jsx)("div",{className:"w-1 bg-green-400 rounded-full audio-wave-bar",style:{height:"20px",animationDelay:.1*t+"s"}},t))})]})]}),(0,y.jsxs)("div",{className:"absolute bottom-6 sm:bottom-8 md:bottom-12 left-1/2 transform -translate-x-1/2 flex flex-col items-center gap-4 px-4",style:{pointerEvents:"auto",zIndex:1e4},children:["demo"!==(localStorage.getItem("customgpt.deploymentMode")||"production")||V?null:(0,y.jsxs)("div",{className:"bg-red-500/20 backdrop-blur-sm rounded-lg px-4 py-3 text-red-300 text-sm flex items-center gap-2 border border-red-500/30 max-w-xs",children:[(0,y.jsx)(ss.A,{className:"w-4 h-4 flex-shrink-0"}),(0,y.jsx)("span",{children:"Voice requires OpenAI API key. Add it in demo settings."})]}),(0,y.jsxs)("div",{className:"flex items-center justify-center",children:[(m||"listening"===C)&&(0,y.jsxs)("button",{onClick:m?W:Y,className:"relative w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-red-500/20 hover:bg-red-500/30 active:bg-red-500/40 backdrop-blur-sm transition-all transform active:scale-95 pointer-events-auto shadow-lg border-2 border-red-500/50",style:{pointerEvents:"auto"},"aria-label":m?"Stop recording":"Stop listening",children:[(0,y.jsx)("div",{className:"absolute inset-0 rounded-full bg-red-500/30 animate-ping"}),(0,y.jsx)("div",{className:"relative z-10 w-full h-full flex items-center justify-center",children:(0,y.jsx)("div",{className:"w-6 h-6 sm:w-8 sm:h-8 bg-red-500 rounded-sm"})})]}),"processing"===C&&(0,y.jsxs)("button",{disabled:!0,className:"relative w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-purple-500/20 backdrop-blur-sm shadow-lg border-2 border-purple-500/50","aria-label":"Processing",children:[(0,y.jsx)("div",{className:"absolute inset-3 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin"}),(0,y.jsx)("div",{className:"absolute inset-6 border-2 border-purple-500/20 border-t-purple-500/60 rounded-full animate-spin",style:{animationDirection:"reverse",animationDuration:"1.5s"}})]}),"speaking"===C&&(0,y.jsxs)("button",{onClick:ee,className:"relative w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-orange-500/20 hover:bg-orange-500/30 active:bg-orange-500/40 backdrop-blur-sm transition-all transform active:scale-95 pointer-events-auto shadow-lg border-2 border-orange-500/50",style:{pointerEvents:"auto"},"aria-label":"Stop response",children:[(0,y.jsx)("div",{className:"absolute inset-0 rounded-full",children:[...Array(3)].map((e,t)=>(0,y.jsx)("div",{className:"absolute inset-0 rounded-full border border-orange-500/30 animate-ping",style:{animationDelay:.2*t+"s",animationDuration:"1.5s"}},t))}),(0,y.jsx)("div",{className:"relative z-10 w-full h-full flex items-center justify-center",children:(0,y.jsx)(Tt.A,{className:"w-8 h-8 sm:w-10 sm:h-10 text-orange-500"})})]}),!J.loading&&!m&&"speaking"!==C&&"listening"!==C&&"processing"!==C&&(0,y.jsxs)("button",{onClick:J.errored?W:Y,disabled:"demo"===(localStorage.getItem("customgpt.deploymentMode")||"production")&&!V,className:"relative w-20 h-20 sm:w-24 sm:h-24 rounded-full backdrop-blur-sm transition-all transform shadow-lg border-2 "+("demo"!==(localStorage.getItem("customgpt.deploymentMode")||"production")||V?"bg-blue-500/20 hover:bg-blue-500/30 active:bg-blue-500/40 hover:scale-105 active:scale-95 pointer-events-auto border-blue-500/50":"bg-gray-500/20 border-gray-500/50 cursor-not-allowed opacity-50"),style:{pointerEvents:"auto"},"aria-label":"demo"!==(localStorage.getItem("customgpt.deploymentMode")||"production")||V?"Start voice chat":"Voice disabled - API key required",children:[(0,y.jsx)("div",{className:"absolute inset-0 rounded-full bg-blue-500/10 blur-sm"}),(0,y.jsx)("div",{className:"relative z-10 w-full h-full flex items-center justify-center",children:(0,y.jsx)(ge.A,{className:"w-8 h-8 sm:w-10 sm:h-10 "+("demo"!==(localStorage.getItem("customgpt.deploymentMode")||"production")||V?"text-blue-500":"text-gray-500")})})]}),J.loading&&(0,y.jsx)("button",{disabled:!0,className:"relative w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-gray-500/20 backdrop-blur-sm shadow-lg border-2 border-gray-500/50","aria-label":"Loading",children:(0,y.jsx)("div",{className:"absolute inset-4 border-3 border-gray-500/30 border-t-gray-500 rounded-full animate-spin"})})]}),(0,y.jsx)("div",{className:"text-xs text-white/60 text-center",children:"demo"===(localStorage.getItem("customgpt.deploymentMode")||"production")&&!V||J.loading?"Initializing...":m?"Tap to stop":"listening"===C?"Listening...":"processing"===C?"Processing...":"speaking"===C?"Tap to stop":"Tap to speak"})]})]})]})]}),(0,y.jsx)(qt,{isOpen:S,onClose:()=>j(!1),projectId:a})]})}function ns(e){const{setVoiceModalOpen:t}=zt();return n.useEffect(()=>{t(e.isOpen)},[e.isOpen,t]),e.isOpen?(0,y.jsx)(as,{...e}):null}const rs=["What can you help me with?","Explain this document","Summarize key points","Answer my questions"],is=({prompt:e,onClick:t})=>(0,y.jsx)("button",{onClick:()=>t(e),className:(0,c.cn)("text-left bg-card border border-border rounded-lg","hover:border-accent hover:shadow-sm transition-all","text-card-foreground","p-2.5","text-xs","min-h-[50px] flex items-center","w-full"),children:e}),os=({onPromptClick:e})=>{const{currentAgent:t}=It(),[s,a]=(0,n.useState)(rs),[o,l]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{(async()=>{if(t)if(t.settings?.example_questions&&t.settings.example_questions.length>0)a(t.settings.example_questions);else{l(!0);try{const e=(0,Te.getClient)(),s=await e.getAgentSettings(t.id),n=s.data||s;n.example_questions&&n.example_questions.length>0?(a(n.example_questions),We.v.info("UI","Loaded custom example questions from API",{agentId:t.id,questionCount:n.example_questions.length})):We.v.info("UI","No custom example questions found, using defaults",{agentId:t.id})}catch(e){We.v.warn("UI","Failed to load agent settings for example questions",{agentId:t.id,error:e instanceof Error?e.message:String(e)})}finally{l(!1)}}})()},[t]),(0,y.jsx)("div",{className:(0,c.cn)("flex flex-col items-center justify-center h-full py-8","px-4 md:px-8"),children:(0,y.jsxs)(r.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:(0,c.cn)("text-center w-full","max-w-sm sm:max-w-md md:max-w-lg"),children:[(0,y.jsx)("div",{className:"w-16 h-16 rounded-full flex items-center justify-center mb-6 mx-auto overflow-hidden bg-accent",children:t?.settings?.chatbot_avatar?(0,y.jsx)("img",{src:t.settings.chatbot_avatar,alt:`${t.project_name} avatar`,className:"w-16 h-16 rounded-full object-cover"}):(0,y.jsx)(i.A,{className:"w-8 h-8 text-muted-foreground"})}),(0,y.jsxs)("h3",{className:(0,c.cn)("font-semibold text-foreground mb-2","text-lg sm:text-xl md:text-2xl"),children:["Welcome to ",t?.project_name||"CustomGPT","!"]}),(0,y.jsx)("p",{className:(0,c.cn)("text-muted-foreground mb-6 sm:mb-8","text-sm sm:text-base"),children:"I'm here to help answer your questions and assist with your tasks. How can I help you today?"}),(0,y.jsx)("div",{className:(0,c.cn)("grid gap-2 sm:gap-3 w-full","grid-cols-2","max-w-full sm:max-w-md md:max-w-lg","auto-cols-fr"),children:s.map((s,a)=>(0,y.jsx)(r.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:.1+.1*a},children:(0,y.jsx)(is,{prompt:s,onClick:e})},`${t?.id}-${a}`))}),o&&(0,y.jsx)(r.P.div,{initial:{opacity:0},animate:{opacity:1},className:"mt-4",children:(0,y.jsx)("p",{className:"text-xs text-muted-foreground",children:"Loading custom questions..."})})]})})},cs=({className:e,mode:t="standalone"})=>{const{messages:s,streamingMessage:a,isStreaming:r,error:i,sendMessage:l,updateMessageFeedback:d,loading:u,clearError:g,setMessagesForConversation:m}=At(),{currentConversation:h}=_t(),{currentAgent:p}=It(),f=(0,n.useRef)(null),[x,v]=n.useState(!1),[b,w]=n.useState(null),[S,j]=n.useState(null),[C,N]=n.useState(!1),[A,_]=n.useState(null),[I,k]=n.useState(!1),[E,P]=n.useState(!1);n.useEffect(()=>{if("undefined"!=typeof window){const e=localStorage.getItem("customgpt.freeTrialMode");P("true"===e)}},[]);const T=h&&s.get(h.id.toString())||[];(0,n.useEffect)(()=>{},[h,T,t,s,x,u]),(0,n.useEffect)(()=>{if(h&&h.id.toString()!==b){v(!0),w(h.id.toString());const e=setTimeout(()=>{v(!1)},1e3);return()=>clearTimeout(e)}},[h,b]),(0,n.useEffect)(()=>{x&&(T.length>0||!u)&&v(!1)},[T,x,u]),(0,n.useEffect)(()=>{if(f.current){const e=x?"auto":"smooth";f.current.scrollTo({top:f.current.scrollHeight,behavior:e})}},[T,a,x]);const M=e=>{We.v.info("UI","Citation clicked",{citationId:e.id,citationIndex:e.index,citationTitle:e.title}),e.id&&(j(e.id),N(!0))},F=e=>{We.v.info("UI","Citation preview requested",{citationId:e.id,citationTitle:e.title}),e.id&&(_(e.id),k(!0))};return(0,y.jsxs)("div",{ref:f,className:(0,c.cn)("flex-1 overflow-y-auto scroll-smooth","bg-gradient-to-b from-muted/50 to-background",e),children:[i&&(0,y.jsx)("div",{className:"p-4 m-4",children:(0,y.jsx)(jt,{error:i,onRetry:()=>{if(g(),h){const e=s.get(h.id.toString())||[],t=e.filter(e=>"user"===e.role).pop();if(t){const s=e.filter(e=>e.id!==t.id);m(h.id.toString(),s),l(t.content)}}}})}),x&&(0,y.jsx)(ce,{visible:!0,message:T.length>0?"Loading conversation...":"Switching to conversation...",blur:!0}),x&&0===T.length&&!r&&(0,y.jsxs)("div",{className:"space-y-0 opacity-30",children:[(0,y.jsx)(le,{isAssistant:!1,lines:2}),(0,y.jsx)(le,{isAssistant:!0,lines:3}),(0,y.jsx)(le,{isAssistant:!1,lines:1}),(0,y.jsx)(le,{isAssistant:!0,lines:4})]}),0===T.length&&!a&&!i&&!x&&(0,y.jsx)(os,{onPromptClick:e=>{E?o.toast.error("Free Trial Limitation",{description:"Sending messages is not available in free trial mode. Please use your own API key to send messages.",duration:5e3}):(We.v.info("UI","Example prompt clicked",{prompt:e}),l(e))}}),T.length>0&&(0,y.jsx)("div",{className:"space-y-0",children:T.map((e,s)=>(0,y.jsx)(B,{message:e,agent:p,isLast:s===T.length-1,onCitationClick:M,onPreviewClick:F,onFeedback:t=>(async(e,t)=>{We.v.info("UI","Message feedback provided",{messageId:e,feedback:t}),await d(e,t)})(e.id,t),mode:t},e.id))}),a&&!T.some(e=>e.id===a.id)&&(0,y.jsx)(B,{message:a,agent:p,isStreaming:!0,isLast:!0,onCitationClick:M,onPreviewClick:F,mode:t}),r&&!a&&(0,y.jsx)(ze,{}),S&&(0,y.jsx)(pt,{isOpen:C,onClose:()=>{N(!1),j(null)},citationId:S,projectId:p?.id||0}),A&&(0,y.jsx)(xt,{isOpen:I,onClose:()=>{k(!1),_(null)},citationId:A,fileName:`Citation_${A}.txt`})]})},ls=({mode:e="standalone",onClose:t,onAgentSettings:s,enableConversationManagement:a=!1,maxConversations:n,sessionId:r,currentConversationId:o,onConversationChange:c,onCreateConversation:l,conversationRefreshKey:d})=>{const{currentAgent:u}=It(),{isMobile:g}=Qe();return"widget"===e||"floating"===e?(0,y.jsx)("header",{className:"border-b border-border bg-background",children:(0,y.jsxs)("div",{className:"flex items-center justify-between px-4 py-3",children:[(0,y.jsxs)("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[(0,y.jsx)("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0",children:(0,y.jsx)("img",{src:"widget"===e||"floating"===e?"./logo.png":"/logo.png",alt:"CustomGPT.ai Logo",className:"w-8 h-8 rounded-lg"})}),(0,y.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,y.jsx)("h2",{className:"font-semibold text-foreground truncate",children:u?.project_name||"CustomGPT Assistant"}),(0,y.jsx)("p",{className:"text-xs text-muted-foreground",children:u?.is_chat_active?"Online":"Offline"})]})]}),t&&(0,y.jsxs)("button",{onClick:t,className:"p-1.5 rounded-lg hover:bg-accent hover:text-accent-foreground transition-colors flex-shrink-0",children:[(0,y.jsx)("span",{className:"sr-only",children:"Close"}),"Ã—"]})]})}):"standalone"!==e||g?null:(0,y.jsxs)("header",{className:"flex items-center justify-between px-4 py-3 border-b border-border bg-background",children:[(0,y.jsxs)("div",{className:"flex items-center gap-3",children:[(0,y.jsx)("div",{className:"w-8 h-8 rounded-lg bg-brand-500 flex items-center justify-center",children:(0,y.jsx)(i.A,{className:"w-5 h-5 text-white"})}),(0,y.jsx)("h1",{className:"text-lg font-semibold text-foreground",children:"Agent Chat"})]}),(0,y.jsx)("div",{className:"flex-1 max-w-xs ml-4",children:(0,y.jsx)(Ke,{onSettingsClick:s,className:"w-full"})})]})},ds=({mode:e="standalone",className:t,onClose:s,onAgentSettings:a,enableConversationManagement:r=!1,maxConversations:i,sessionId:l,threadId:d,onConversationChange:u,onMessage:g,conversationRefreshKey:m,isMobile:h=!1})=>{const{sendMessage:p,isStreaming:f,cancelStreaming:x}=At(),{fetchAgents:v,agents:b,currentAgent:w}=It(),{currentConversation:S}=_t(),j=nt(),[C,N]=n.useState(null),[A,_]=n.useState(!1),[I,k]=n.useState(null),{isDemoMode:E,openAIApiKey:P}=ts(),[T,M]=n.useState(!1);n.useEffect(()=>{if("standalone"===e&&"undefined"!=typeof window){const e=localStorage.getItem("customgpt.freeTrialMode");M("true"===e)}},[e]);(0,n.useEffect)(()=>{(async()=>{if(0!==b.length||w)We.v.info("UI","Agents already initialized",{agentCount:b.length,hasCurrentAgent:!!w,currentAgentName:w?.project_name});else{We.v.info("UI","Initializing agents on ChatContainer mount");try{await v(),We.v.info("UI","Agents initialized successfully",{agentCount:b.length})}catch(e){We.v.error("UI","Failed to initialize agents",e,{errorMessage:e instanceof Error?e.message:String(e)})}}})()},[b.length,w,v]);return(0,y.jsxs)("div",{className:(0,c.cn)("flex flex-col bg-background","standalone"===e&&"h-full","widget"===e&&!h&&"h-[600px] w-[400px] rounded-lg shadow-xl border border-border","floating"===e&&!h&&"h-[600px] w-[400px] rounded-lg shadow-2xl border border-border",h&&"h-full w-full",t),children:[(0,y.jsx)(ls,{mode:e,onClose:s,onAgentSettings:e=>{We.v.info("UI","Agent settings requested",{agentId:e.id,agentName:e.project_name}),a?.(e)},enableConversationManagement:r,maxConversations:i,sessionId:l,currentConversationId:C||S?.id.toString(),onConversationChange:e=>{N(e.id),u?.(e),j&&j.switchConversation(e.id)},onCreateConversation:async()=>{if(j)try{const e=await j.createConversation();if(e)N(e.id);else{const e=j.configuration?.maxConversations||5;o.toast.error(`You've reached the maximum limit of ${e} conversations. Please delete an existing conversation to create a new one.`)}}catch(e){o.toast.error("Failed to create conversation. Please try again.")}},conversationRefreshKey:m}),(0,y.jsx)(cs,{className:"flex-1 overflow-y-auto",mode:e}),(0,y.jsx)("div",{className:(0,c.cn)("mt-auto",h&&"standalone"===e?"pb-[30px]":""),children:(0,y.jsx)(Le,{onSend:async(e,t)=>{if(T)o.toast.error("Free Trial Limitation",{description:"Sending messages is not available in free trial mode. Please use your own API key to send messages.",duration:5e3});else{We.v.info("UI","Sending message from ChatContainer",{contentLength:e.length,hasFiles:t&&t.length>0,fileCount:t?.length||0,currentAgent:w?.project_name,agentId:w?.id});try{await p(e,t),We.v.info("UI","Message sent successfully")}catch(e){We.v.error("UI","Failed to send message from ChatContainer",e,{errorMessage:e instanceof Error?e.message:String(e),isAuthError:e instanceof Error&&(e.message.includes("403")||e.message.includes("unauthorized"))})}}},disabled:f||T,placeholder:T?"Free trial mode - Use your API key to send messages":f?"AI is thinking...":"Send a message...",onVoiceClick:()=>{const{available:e,error:t}=E?P?{available:!0}:{available:!1,error:"Voice feature requires an OpenAI API key. Please enable voice capability in demo settings and provide your OpenAI API key."}:{available:!0};e?_(!0):o.toast.error(t||"Voice feature is not available")},isMobile:h,mode:e})}),(0,y.jsx)("div",{className:(0,c.cn)("px-4 py-2 border-t border-border bg-muted","standalone"===e&&"flex items-center justify-center"),children:(0,y.jsx)("a",{href:"https://customgpt.ai",target:"_blank",rel:"noopener noreferrer",className:(0,c.cn)("text-xs text-muted-foreground hover:text-foreground transition-colors","standalone"===e?"inline-flex items-center":"block text-center"),children:"Powered by CustomGPT.ai"})}),w&&w.id&&(0,y.jsx)(ns,{isOpen:A,onClose:()=>_(!1),projectId:w.id.toString(),projectName:w.project_name})]})};var us=s(37600),gs=s.n(us),ms=s(51793),hs=s(30348),ps=s(36846),fs=s(17225),xs=s(45436),vs=s(55854),ys=s(2553);const bs=ys.bL,ws=(ys.YJ,ys.WT),Ss=n.forwardRef(({className:e,children:t,...s},a)=>(0,y.jsxs)(ys.l9,{ref:a,className:(0,c.cn)("flex h-11 w-full items-center justify-between rounded-lg border border-input bg-background px-3.5 py-2 text-sm","transition-all duration-200 ease-out","hover:border-primary/30","focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary","focus:bg-primary/5","disabled:cursor-not-allowed disabled:opacity-50 disabled:bg-muted/50","text-foreground placeholder:text-muted-foreground","[&>span]:line-clamp-1","group",e),...s,children:[t,(0,y.jsx)(ys.In,{asChild:!0,children:(0,y.jsx)(k.A,{className:"h-4 w-4 opacity-50 transition-transform duration-200 group-data-[state=open]:rotate-180"})})]}));Ss.displayName=ys.l9.displayName;const js=n.forwardRef(({className:e,...t},s)=>(0,y.jsx)(ys.PP,{ref:s,className:(0,c.cn)("flex cursor-default items-center justify-center py-1","border-b border-gray-200/30 dark:border-gray-800/20 bg-background/50","hover:bg-accent/50 transition-colors",e),...t,children:(0,y.jsx)(O.A,{className:"h-4 w-4 opacity-50"})}));js.displayName=ys.PP.displayName;const Cs=n.forwardRef(({className:e,...t},s)=>(0,y.jsx)(ys.wn,{ref:s,className:(0,c.cn)("flex cursor-default items-center justify-center py-1","border-t border-gray-200/30 dark:border-gray-800/20 bg-background/50","hover:bg-accent/50 transition-colors",e),...t,children:(0,y.jsx)(k.A,{className:"h-4 w-4 opacity-50"})}));Cs.displayName=ys.wn.displayName;const Ns=n.forwardRef(({className:e,children:t,position:s="popper",...a},n)=>(0,y.jsx)(ys.ZL,{children:(0,y.jsxs)(ys.UC,{ref:n,className:(0,c.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden","rounded-lg border border-gray-200/50 dark:border-gray-800/30","bg-background/95 backdrop-blur-md","text-foreground shadow-lg","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95","data-[side=bottom]:slide-in-from-top-2","data-[side=left]:slide-in-from-right-2","data-[side=right]:slide-in-from-left-2","data-[side=top]:slide-in-from-bottom-2","popper"===s&&["data-[side=bottom]:translate-y-1","data-[side=left]:-translate-x-1","data-[side=right]:translate-x-1","data-[side=top]:-translate-y-1"],e),position:s,...a,children:[(0,y.jsx)(js,{}),(0,y.jsx)(ys.LM,{className:(0,c.cn)("p-1.5","popper"===s&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:t}),(0,y.jsx)(Cs,{})]})}));Ns.displayName=ys.UC.displayName;n.forwardRef(({className:e,...t},s)=>(0,y.jsx)(ys.JU,{ref:s,className:(0,c.cn)("py-1.5 pl-8 pr-2 text-sm font-semibold",e),...t})).displayName=ys.JU.displayName;const As=n.forwardRef(({className:e,children:t,...s},a)=>(0,y.jsxs)(ys.q7,{ref:a,className:(0,c.cn)("relative flex w-full cursor-pointer select-none items-center","rounded-md py-2 pl-8 pr-2 text-sm outline-none","transition-all duration-150","hover:bg-accent hover:text-accent-foreground","focus:bg-accent focus:text-accent-foreground","data-[state=checked]:bg-primary/10 data-[state=checked]:text-primary","data-[disabled]:pointer-events-none data-[disabled]:opacity-50",e),...s,children:[(0,y.jsx)("span",{className:"absolute left-2 flex h-4 w-4 items-center justify-center",children:(0,y.jsx)(ys.VF,{children:(0,y.jsx)(Se.A,{className:"h-3.5 w-3.5 animate-in fade-in-0 zoom-in-0"})})}),(0,y.jsx)(ys.p4,{children:t})]}));As.displayName=ys.q7.displayName;function _s({value:e,onValueChange:t,options:s,placeholder:a="Select an option",className:n,disabled:r=!1,name:i,id:o}){return(0,y.jsxs)(bs,{value:e,onValueChange:t,disabled:r,name:i,children:[(0,y.jsx)(Ss,{className:(0,c.cn)("w-full",n),id:o,children:(0,y.jsx)(ws,{placeholder:a})}),(0,y.jsx)(Ns,{children:s.map(e=>(0,y.jsx)(As,{value:e.value,disabled:e.disabled,children:e.label},e.value))})]})}n.forwardRef(({className:e,...t},s)=>(0,y.jsx)(ys.wv,{ref:s,className:(0,c.cn)("-mx-1 my-1 h-px bg-border",e),...t})).displayName=ys.wv.displayName;var Is=s(51714),ks=s(23252);const Es=({conversation:e,isOpen:t,onClose:s})=>{const{isMobile:a}=Qe();if(!t||!e)return null;const n=(e,t)=>{navigator.clipboard.writeText(e),o.toast.success(`${t} copied to clipboard`)},i=e=>new Date(e).toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZoneName:"short"});return(0,y.jsx)(I.N,{children:t&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(r.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:s}),(0,y.jsxs)(r.P.div,{initial:{opacity:0,scale:.95,y:a?"100%":0},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:a?"100%":0},className:(0,c.cn)("fixed bg-background shadow-xl z-50",a?"inset-x-0 bottom-0 top-20 rounded-t-xl flex flex-col":"inset-x-0 top-[10%] mx-auto max-w-2xl rounded-lg max-h-[80vh] overflow-hidden"),onClick:e=>e.stopPropagation(),children:[(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center justify-between border-b border-border bg-background/95 backdrop-blur-sm flex-shrink-0",a?"px-4 py-4":"p-6"),children:[(0,y.jsx)("h2",{className:(0,c.cn)("font-semibold text-foreground",a?"text-base":"text-xl"),children:"Conversation Details"}),(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:s,className:(0,c.cn)(a?"h-9 w-9 touch-target":"h-8 w-8"),children:(0,y.jsx)(H.A,{className:(0,c.cn)(a?"h-5 w-5":"h-4 w-4")})})]}),(0,y.jsxs)("div",{className:(0,c.cn)("overflow-y-auto",a?"flex-1 px-4 py-4 pb-6 safe-area-pb space-y-6":"p-6 space-y-6 max-h-[calc(80vh-200px)]"),children:[(0,y.jsxs)("div",{children:[(0,y.jsx)("h3",{className:(0,c.cn)("font-medium text-muted-foreground uppercase tracking-wider mb-4",a?"text-xs":"text-sm"),children:"Basic Information"}),(0,y.jsxs)("div",{className:(0,c.cn)("bg-muted rounded-lg space-y-4",a?"p-4":"p-4 space-y-3"),children:[(0,y.jsxs)("div",{className:(0,c.cn)(a?"space-y-2":"flex items-start justify-between"),children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(Is.A,{className:(0,c.cn)("text-muted-foreground","h-4 w-4")}),(0,y.jsx)("span",{className:(0,c.cn)("font-medium text-foreground","text-sm"),children:"Conversation Name"})]}),(0,y.jsx)("span",{className:(0,c.cn)("text-foreground font-medium break-words",a?"text-sm ml-6 block":"text-sm"),children:e.name})]}),(0,y.jsxs)("div",{className:(0,c.cn)(a?"space-y-2":"flex items-start justify-between"),children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(Is.A,{className:(0,c.cn)("text-muted-foreground","h-4 w-4")}),(0,y.jsx)("span",{className:(0,c.cn)("font-medium text-foreground","text-sm"),children:"Conversation ID"})]}),(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center gap-2",a?"ml-6":""),children:[(0,y.jsx)("span",{className:(0,c.cn)("text-foreground font-mono",a?"text-xs":"text-sm"),children:e.id}),(0,y.jsx)(w,{size:"icon",variant:"ghost",className:(0,c.cn)(a?"h-8 w-8 touch-target":"h-6 w-6"),onClick:()=>n(e.id.toString(),"Conversation ID"),children:(0,y.jsx)(h.A,{className:(0,c.cn)(a?"h-4 w-4":"h-3 w-3")})})]})]}),(0,y.jsxs)("div",{className:(0,c.cn)(a?"space-y-2":"flex items-start justify-between"),children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(Is.A,{className:(0,c.cn)("text-muted-foreground","h-4 w-4")}),(0,y.jsx)("span",{className:(0,c.cn)("font-medium text-foreground","text-sm"),children:"Session ID"})]}),(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center gap-2",a?"ml-6":""),children:[(0,y.jsx)("span",{className:(0,c.cn)("text-foreground font-mono break-all",a?"text-sm":"text-sm truncate max-w-[300px]"),title:e.session_id,children:e.session_id}),(0,y.jsx)(w,{size:"icon",variant:"ghost",className:(0,c.cn)(a?"h-8 w-8 touch-target flex-shrink-0":"h-6 w-6"),onClick:()=>n(e.session_id,"Session ID"),children:(0,y.jsx)(h.A,{className:(0,c.cn)(a?"h-4 w-4":"h-3 w-3")})})]})]}),(0,y.jsxs)("div",{className:(0,c.cn)(a?"space-y-2":"flex items-start justify-between"),children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(Is.A,{className:(0,c.cn)("text-muted-foreground","h-4 w-4")}),(0,y.jsx)("span",{className:(0,c.cn)("font-medium text-foreground","text-sm"),children:"Project ID"})]}),(0,y.jsx)("span",{className:(0,c.cn)("text-foreground",a?"text-sm ml-6 block":"text-sm"),children:e.project_id})]}),void 0!==e.message_count&&(0,y.jsxs)("div",{className:(0,c.cn)(a?"space-y-2":"flex items-start justify-between"),children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(Is.A,{className:(0,c.cn)("text-muted-foreground","h-4 w-4")}),(0,y.jsx)("span",{className:(0,c.cn)("font-medium text-foreground","text-sm"),children:"Message Count"})]}),(0,y.jsxs)("span",{className:(0,c.cn)("text-foreground",a?"text-sm ml-6 block":"text-sm"),children:[e.message_count," messages"]})]})]})]}),(0,y.jsxs)("div",{children:[(0,y.jsx)("h3",{className:(0,c.cn)("font-medium text-muted-foreground uppercase tracking-wider mb-4",a?"text-xs":"text-sm"),children:"Timeline"}),(0,y.jsxs)("div",{className:(0,c.cn)("bg-muted rounded-lg space-y-4",a?"p-4":"p-4 space-y-3"),children:[(0,y.jsxs)("div",{className:(0,c.cn)(a?"space-y-2":"flex items-start justify-between"),children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(ks.A,{className:(0,c.cn)("text-muted-foreground","h-4 w-4")}),(0,y.jsx)("span",{className:(0,c.cn)("font-medium text-foreground","text-sm"),children:"Created At"})]}),(0,y.jsxs)("div",{className:(0,c.cn)(a?"ml-6 space-y-1":"text-right"),children:[(0,y.jsx)("span",{className:(0,c.cn)("text-foreground block","text-sm"),children:i(e.created_at)}),(0,y.jsxs)("span",{className:(0,c.cn)("text-muted-foreground","text-xs"),children:["(",(0,c.Ey)(e.created_at),")"]})]})]}),(0,y.jsxs)("div",{className:(0,c.cn)(a?"space-y-2":"flex items-start justify-between"),children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(ms.A,{className:(0,c.cn)("text-muted-foreground","h-4 w-4")}),(0,y.jsx)("span",{className:(0,c.cn)("font-medium text-foreground","text-sm"),children:"Last Updated"})]}),(0,y.jsxs)("div",{className:(0,c.cn)(a?"ml-6 space-y-1":"text-right"),children:[(0,y.jsx)("span",{className:(0,c.cn)("text-foreground block","text-sm"),children:i(e.updated_at)}),(0,y.jsxs)("span",{className:(0,c.cn)("text-muted-foreground","text-xs"),children:["(",(0,c.Ey)(e.updated_at),")"]})]})]}),e.deleted_at&&(0,y.jsxs)("div",{className:(0,c.cn)(a?"space-y-2":"flex items-start justify-between"),children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(K.A,{className:(0,c.cn)("text-red-400","h-4 w-4")}),(0,y.jsx)("span",{className:(0,c.cn)("font-medium text-red-700","text-sm"),children:"Deleted At"})]}),(0,y.jsxs)("div",{className:(0,c.cn)(a?"ml-6 space-y-1":"text-right"),children:[(0,y.jsx)("span",{className:(0,c.cn)("text-red-900 block","text-sm"),children:i(e.deleted_at)}),(0,y.jsxs)("span",{className:(0,c.cn)("text-red-500","text-xs"),children:["(",(0,c.Ey)(e.deleted_at),")"]})]})]})]})]}),e.created_by&&(0,y.jsxs)("div",{children:[(0,y.jsx)("h3",{className:(0,c.cn)("font-medium text-muted-foreground uppercase tracking-wider mb-4",a?"text-xs":"text-sm"),children:"User Information"}),(0,y.jsx)("div",{className:(0,c.cn)("bg-accent rounded-lg","p-4"),children:(0,y.jsxs)("div",{className:(0,c.cn)(a?"space-y-2":"flex items-start justify-between"),children:[(0,y.jsxs)("div",{className:"flex items-center gap-2",children:[(0,y.jsx)(S.A,{className:(0,c.cn)("text-muted-foreground","h-4 w-4")}),(0,y.jsx)("span",{className:(0,c.cn)("font-medium text-foreground","text-sm"),children:"Created By"})]}),(0,y.jsxs)("span",{className:(0,c.cn)("text-foreground",a?"text-sm ml-6 block":"text-sm"),children:["User ID: ",e.created_by]})]})})]})]}),!a&&(0,y.jsx)("div",{className:"p-6 border-t border-border bg-accent",children:(0,y.jsx)("div",{className:"flex justify-end",children:(0,y.jsx)(w,{onClick:s,children:"Close"})})})]})]})})},Ps=({isOpen:e,conversationName:t,messageCount:s,onConfirm:a,onCancel:i})=>{const[o,l]=(0,n.useState)(!1),[d,u]=(0,n.useState)(null),{isMobile:g}=Qe();return e?(0,y.jsx)(I.N,{children:e&&(0,y.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[(0,y.jsx)(r.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-black bg-opacity-50",onClick:o?void 0:i}),(0,y.jsx)(r.P.div,{initial:{opacity:0,scale:g?1:.95,y:g?"100%":0},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:g?1:.95,y:g?"100%":0},className:(0,c.cn)("relative bg-background shadow-xl",g?"fixed inset-x-0 bottom-0 rounded-t-xl safe-area-pb":"w-full max-w-md rounded-lg"),onClick:e=>e.stopPropagation(),children:(0,y.jsxs)("div",{className:(0,c.cn)(g?"p-4 pb-6":"p-6"),children:[(0,y.jsxs)("div",{className:(0,c.cn)("flex items-start",g?"gap-3":"gap-4"),children:[(0,y.jsx)("div",{className:(0,c.cn)("bg-red-100 rounded-full flex-shrink-0",g?"p-2.5":"p-3"),children:(0,y.jsx)(ss.A,{className:(0,c.cn)("text-red-600",g?"w-5 h-5":"w-6 h-6")})}),(0,y.jsxs)("div",{className:"flex-1",children:[(0,y.jsx)("h3",{className:(0,c.cn)("font-semibold text-foreground",g?"text-base":"text-lg"),children:"Delete Conversation"}),(0,y.jsxs)("p",{className:(0,c.cn)("mt-2 text-muted-foreground","text-sm"),children:["Are you sure you want to delete ",(0,y.jsxs)("strong",{children:["â€œ",t,"â€"]}),"?"]}),void 0!==s&&s>0&&(0,y.jsxs)("p",{className:(0,c.cn)("mt-2 text-muted-foreground","text-sm"),children:["This conversation contains ",s," message",1!==s?"s":"","."]}),(0,y.jsxs)("div",{className:(0,c.cn)("mt-3 bg-red-50 rounded-lg","p-3"),children:[(0,y.jsx)("p",{className:(0,c.cn)("text-red-800 font-medium","text-sm"),children:"âš ï¸ This action cannot be undone"}),(0,y.jsx)("p",{className:(0,c.cn)("text-red-700 mt-1","text-xs"),children:"All messages and data associated with this conversation will be permanently deleted."})]}),d&&(0,y.jsx)("div",{className:(0,c.cn)("mt-3 bg-red-100 border border-red-200 rounded-lg","p-3"),children:(0,y.jsxs)("p",{className:(0,c.cn)("text-red-900 font-medium","text-sm"),children:["Error: ",d]})})]})]}),(0,y.jsxs)("div",{className:(0,c.cn)("flex items-center gap-3",g?"mt-6 flex-col-reverse":"mt-6 justify-end"),children:[(0,y.jsx)(w,{variant:"outline",onClick:i,disabled:o,className:(0,c.cn)(g&&"w-full h-11 touch-target"),children:"Cancel"}),(0,y.jsx)(w,{variant:"destructive",onClick:async()=>{l(!0),u(null);try{await a()}catch(e){let t="Failed to delete conversation";400===e.status?t="Invalid request. Please try again.":401===e.status?t="Authentication failed. Please refresh the page and try again.":404===e.status?t="Conversation not found. It may have already been deleted.":500===e.status?t="Server error. Please try again later.":e.message&&(t=e.message),u(t),l(!1)}},disabled:o,className:(0,c.cn)("min-w-[100px]",g&&"w-full h-11 touch-target"),children:o?(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Deleting..."]}):(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(fs.A,{className:(0,c.cn)("mr-2","w-4 h-4")}),"Delete"]})})]})]})})]})}):null},Ts=({conversation:e,isSelected:t,onSelect:s,onDelete:a,onRename:i})=>{const[o,l]=(0,n.useState)(!1),[d,u]=(0,n.useState)(e.name),[g,m]=(0,n.useState)(!1),[h,p]=(0,n.useState)(!1),[f,x]=(0,n.useState)(!1),[v,b]=(0,n.useState)(!1),[S,j]=(0,n.useState)(!1),C=(0,n.useRef)(null),N=(0,n.useRef)(null);(0,n.useEffect)(()=>{const e=e=>{N.current&&!N.current.contains(e.target)&&m(!1)};if(g)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[g]),(0,n.useEffect)(()=>{o&&C.current&&(C.current.focus(),C.current.select())},[o]);const A=()=>{d.trim()&&d.trim()!==e.name&&i(e.id.toString(),d.trim()),l(!1),u(e.name)};return(0,y.jsxs)("div",{className:(0,c.cn)("group relative p-3 rounded-lg cursor-pointer transition-colors","hover:bg-accent",t&&"bg-accent/50 hover:bg-accent/70"),onClick:async()=>{if(!o&&!S){j(!0);try{await s(e)}finally{j(!1)}}},children:[S&&(0,y.jsx)("div",{className:"absolute inset-0 bg-background/70 backdrop-blur-sm rounded-lg flex items-center justify-center z-10",children:(0,y.jsx)(ie,{size:"sm"})}),(0,y.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,y.jsxs)("div",{className:"flex-1 min-w-0",children:[o?(0,y.jsx)("input",{ref:C,type:"text",value:d,onChange:e=>u(e.target.value),onBlur:A,onKeyDown:t=>{"Enter"===t.key?A():"Escape"===t.key&&(l(!1),u(e.name))},className:"w-full px-2 py-1 text-sm font-medium text-foreground bg-background border border-input rounded focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent",maxLength:100}):(0,y.jsx)("h3",{className:"font-medium text-foreground text-sm truncate",children:e.name}),(0,y.jsxs)("div",{className:"flex items-center gap-2 mt-1 text-xs text-muted-foreground",children:[(0,y.jsx)(ms.A,{className:"w-3 h-3"}),(0,y.jsx)("span",{title:new Date(e.updated_at).toLocaleString(),children:(0,c.Ey)(e.updated_at)}),void 0!==e.message_count&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)("span",{children:"â€¢"}),(0,y.jsx)(Y.A,{className:"w-3 h-3"}),(0,y.jsx)("span",{children:e.message_count})]})]}),(0,y.jsx)("button",{onClick:e=>{e.stopPropagation(),p(!h)},className:"flex items-center gap-1 mt-2 text-xs text-muted-foreground hover:text-foreground transition-colors",children:h?(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(O.A,{className:"w-3 h-3"}),"Hide Details"]}):(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(k.A,{className:"w-3 h-3"}),"More Details"]})}),(0,y.jsx)(I.N,{children:h&&(0,y.jsx)(r.P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"mt-2 pt-2 border-t border-border",children:(0,y.jsxs)("div",{className:"space-y-1 text-xs text-muted-foreground",children:[(0,y.jsxs)("div",{className:"flex items-center justify-between",children:[(0,y.jsx)("span",{children:"Session ID:"}),(0,y.jsx)("span",{className:"font-mono text-foreground truncate max-w-[150px]",title:e.session_id,children:e.session_id})]}),(0,y.jsxs)("div",{className:"flex items-center justify-between",children:[(0,y.jsx)("span",{children:"Created:"}),(0,y.jsx)("span",{className:"text-foreground",children:(0,c.Ey)(e.created_at)})]}),e.deleted_at&&(0,y.jsxs)("div",{className:"flex items-center justify-between",children:[(0,y.jsx)("span",{className:"text-destructive",children:"Deleted:"}),(0,y.jsx)("span",{className:"text-destructive",children:(0,c.Ey)(e.deleted_at)})]})]})})})]}),!o&&(0,y.jsxs)("div",{className:"relative",ref:N,children:[(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:e=>{e.stopPropagation(),m(!g)},className:"opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 text-muted-foreground hover:text-foreground",children:(0,y.jsx)(hs.A,{className:"h-3 w-3"})}),(0,y.jsx)(I.N,{children:g&&(0,y.jsx)(r.P.div,{initial:{opacity:0,scale:.95,y:-5},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:-5},transition:{duration:.1},className:"absolute right-0 top-6 mt-1 w-40 bg-background border border-border rounded-lg shadow-lg z-50",children:(0,y.jsxs)("div",{className:"py-1",children:[(0,y.jsxs)("button",{onClick:e=>{e.stopPropagation(),x(!0),m(!1)},className:"flex items-center gap-2 w-full px-3 py-2 text-sm text-foreground hover:bg-accent",children:[(0,y.jsx)(F.A,{className:"w-3 h-3"}),"View Details"]}),(0,y.jsxs)("button",{onClick:e=>{e.stopPropagation(),l(!0),m(!1)},className:"flex items-center gap-2 w-full px-3 py-2 text-sm text-foreground hover:bg-accent",children:[(0,y.jsx)(ps.A,{className:"w-3 h-3"}),"Rename"]}),(0,y.jsx)("div",{className:"border-t border-border my-1"}),(0,y.jsxs)("button",{onClick:e=>{e.stopPropagation(),b(!0),m(!1)},className:"flex items-center gap-2 w-full px-3 py-2 text-sm text-destructive hover:bg-destructive/10",children:[(0,y.jsx)(fs.A,{className:"w-3 h-3"}),"Delete"]})]})})})]})]}),(0,y.jsx)(Es,{conversation:e,isOpen:f,onClose:()=>x(!1)}),(0,y.jsx)(Ps,{isOpen:v,conversationName:e.name,messageCount:e.message_count,onConfirm:async()=>{await a(e.id.toString()),b(!1)},onCancel:()=>b(!1)})]})},Ms=({className:e,isCollapsed:t=!1,onToggle:s,isMobile:a=!1,onConversationSelect:l})=>{const[d,u]=(0,n.useState)(!1),[g,m]=(0,n.useState)(!1),[h,p]=(0,n.useState)(!1),{isFreeTrialMode:f}=ne(),{conversations:x,currentConversation:v,loading:b,error:S,fetchConversations:j,createConversation:C,selectConversation:N,deleteConversation:A,updateConversation:_,currentPage:E,totalPages:P,totalConversations:T,perPage:M,sortOrder:F,sortBy:D,userFilter:$,searchQuery:R,searchMode:L,dateFilter:z,setSearchQuery:q,setSearchMode:U,setDateFilter:G,applyFilters:B}=_t(),{currentAgent:V}=It(),{clearMessages:K,loadMessages:J}=At();(0,n.useEffect)(()=>{const e="undefined"!=typeof window&&window.__customgpt_demo_mode;V&&!e?(We.v.info("UI","Agent changed in sidebar, fetching conversations",{agentId:V.id,agentName:V.project_name,isActive:V.is_chat_active}),j(V.id)):V?e&&We.v.info("UI","Skipping conversation fetch in demo mode"):We.v.warn("UI","No current agent selected in sidebar")},[V,j]);const[W,X]=(0,n.useState)(R);(0,n.useEffect)(()=>{X(R)},[R]);const Q=(0,n.useCallback)(e=>{p(!0);try{q(e.trim())}catch(e){We.v.error("UI","Failed to search conversations",e)}finally{p(!1)}},[q]);(0,n.useEffect)(()=>{const e=setTimeout(()=>{W!==R&&Q(W)},300);return()=>clearTimeout(e)},[W,R,Q]);const Z=e=>{U(e)},ee=Array.isArray(x)?x:[],te=async e=>{if(!b){We.v.info("UI","Selecting conversation",{conversationId:e.id,conversationName:e.name,projectId:e.project_id,messageCount:e.message_count}),N(e);try{We.v.info("UI","Loading messages for selected conversation",{conversationId:e.id,agentId:V?.id,agentName:V?.project_name}),await J(e.id.toString()),We.v.info("UI","Messages loaded successfully for conversation",{conversationId:e.id}),l&&l()}catch(t){We.v.error("UI","Failed to load messages for conversation",t,{conversationId:e.id,errorMessage:t instanceof Error?t.message:String(t),errorType:t instanceof Error?t.constructor.name:typeof t}),o.toast.error("Failed to load conversation messages")}}},se=async(e,t)=>{if(f)return void o.toast.error("Renaming conversations is not available in free trial mode");const s=x.find(t=>t.id.toString()===e);if(s)try{await _(s.project_id,s.session_id,{name:t}),o.toast.success("Conversation renamed")}catch(e){o.toast.error("Failed to rename conversation")}};return t&&!a?(0,y.jsx)("div",{className:(0,c.cn)("w-12 bg-muted border-r border-border flex flex-col",e),children:(0,y.jsx)("div",{className:"p-2",children:(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:s,className:"w-8 h-8",title:"Expand sidebar",children:(0,y.jsx)(Y.A,{className:"h-4 w-4"})})})}):(0,y.jsxs)("div",{className:(0,c.cn)("bg-muted flex flex-col",a?"w-full h-full":"w-80 border-r border-border",e),children:[(0,y.jsxs)("div",{className:"p-4 border-b border-border bg-background",children:[(0,y.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,y.jsx)("h2",{className:"font-semibold text-foreground",children:"Conversations"}),!a&&(0,y.jsx)(w,{size:"icon",variant:"ghost",onClick:s,className:"h-8 w-8",title:"Collapse sidebar",children:(0,y.jsx)(H.A,{className:"h-4 w-4"})})]}),(0,y.jsxs)("div",{className:"space-y-2",children:[(0,y.jsxs)("div",{className:"relative",children:[(0,y.jsx)(yt.A,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),(0,y.jsx)("input",{type:"text",placeholder:a?"Search conversations...":`Search by ${L}...`,value:W,onChange:e=>{return t=e.target.value,void X(t);var t},className:(0,c.cn)("w-full pl-9 pr-12 py-2 text-sm border border-input bg-background text-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent placeholder:text-muted-foreground",a&&"py-3")}),h&&(0,y.jsx)("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:(0,y.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-brand-600"})})]}),!a&&(0,y.jsxs)("div",{className:"flex gap-1",children:[(0,y.jsx)("button",{onClick:()=>Z("name"),className:(0,c.cn)("flex-1 px-2 py-1 text-xs rounded transition-colors","name"===L?"bg-brand-500 text-white":"bg-muted text-muted-foreground hover:bg-accent"),children:"Name"}),(0,y.jsx)("button",{onClick:()=>Z("id"),className:(0,c.cn)("flex-1 px-2 py-1 text-xs rounded transition-colors","id"===L?"bg-brand-500 text-white":"bg-muted text-muted-foreground hover:bg-accent"),children:"ID"}),(0,y.jsx)("button",{onClick:()=>Z("session"),className:(0,c.cn)("flex-1 px-2 py-1 text-xs rounded transition-colors","session"===L?"bg-brand-500 text-white":"bg-muted text-muted-foreground hover:bg-accent"),children:"Session"})]})]}),!a&&(0,y.jsxs)(w,{size:"sm",variant:"outline",onClick:()=>m(!g),className:"w-full mt-2 justify-center gap-2",children:[(0,y.jsx)(xs.A,{className:"h-3 w-3"}),"Sort & Filter",g?(0,y.jsx)(O.A,{className:"h-3 w-3"}):(0,y.jsx)(k.A,{className:"h-3 w-3"})]}),!a&&g&&(0,y.jsx)(I.N,{children:(0,y.jsxs)(r.P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"space-y-3 mt-3 overflow-hidden",children:[(0,y.jsxs)("div",{children:[(0,y.jsx)("label",{className:"text-xs font-medium text-foreground mb-1 block",children:"Sort By"}),(0,y.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,y.jsx)(_s,{value:D,onValueChange:e=>{V&&j(V.id,{orderBy:e})},options:[{value:"id",label:"Date Created"},{value:"updated_at",label:"Last Updated"},{value:"name",label:"Name"}],className:"text-xs"}),(0,y.jsx)(_s,{value:F,onValueChange:e=>{V&&j(V.id,{order:e})},options:[{value:"desc",label:"Newest First"},{value:"asc",label:"Oldest First"}],className:"text-xs"})]})]}),(0,y.jsxs)("div",{children:[(0,y.jsx)("label",{className:"text-xs font-medium text-foreground mb-1 block",children:"Filter By Date"}),(0,y.jsx)(_s,{value:z,onValueChange:e=>(e=>{G(e)})(e),options:[{value:"all",label:"All Time"},{value:"today",label:"Today"},{value:"week",label:"Last 7 Days"},{value:"month",label:"Last 30 Days"}],className:"w-full text-xs"})]}),(0,y.jsxs)("div",{children:[(0,y.jsx)("label",{className:"text-xs font-medium text-foreground mb-1 block",children:"Filter By User"}),(0,y.jsx)(_s,{value:$,onValueChange:e=>{V&&j(V.id,{userFilter:e})},options:[{value:"all",label:"All Users"},{value:"me",label:"My Conversations"}],className:"w-full text-xs"})]})]})})]}),(0,y.jsxs)("div",{className:"p-4 space-y-2",children:[(0,y.jsx)(gs(),{href:"/dashboard/projects/create",children:(0,y.jsxs)(w,{className:"w-full justify-start gap-2",variant:"default",disabled:f,title:f?"Creating new agents is not available in free trial mode":"",children:[(0,y.jsx)(i.A,{className:"w-4 h-4"}),"Create New Agent"]})}),(0,y.jsx)(w,{onClick:async()=>{if(V&&!d)if(f)o.toast.error("Creating new conversations is not available in free trial mode");else{We.v.info("UI","Creating new conversation",{agentId:V.id,agentName:V.project_name}),u(!0);try{const e=`New Chat ${(new Date).toLocaleDateString()}`;await C(V.id,e),K(),We.v.info("UI","New conversation created successfully",{name:e}),o.toast.success("New conversation created"),l&&l()}catch(e){We.v.error("UI","Failed to create conversation",e,{agentId:V.id,errorMessage:e instanceof Error?e.message:String(e)}),o.toast.error("Failed to create new conversation")}finally{u(!1)}}},disabled:!V||d||f,className:"w-full justify-start gap-2",variant:"outline",title:f?"Creating new conversations is not available in free trial mode":"",children:d?(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(ie,{size:"sm"}),(0,y.jsx)("span",{children:"Creating..."})]}):(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(vs.A,{className:"w-4 h-4"}),(0,y.jsx)("span",{children:"New Chat"})]})})]}),(0,y.jsx)("div",{className:"flex-1 overflow-y-auto",children:!b||Array.isArray(x)&&0!==x.length?!S||Array.isArray(x)&&0!==x.length?0===ee.length?(0,y.jsxs)("div",{className:"p-4 text-center",children:[(0,y.jsx)(Y.A,{className:"w-8 h-8 text-muted-foreground mx-auto mb-2"}),(0,y.jsx)("p",{className:"text-sm text-muted-foreground",children:R?"No conversations found":"No conversations yet"}),!R&&(0,y.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Start a new conversation to get going"}),V&&(0,y.jsxs)("div",{className:"text-xs text-muted-foreground mt-2 space-y-1",children:[(0,y.jsxs)("p",{children:["Agent: ",V.project_name," (ID: ",V.id,")"]}),S&&(0,y.jsxs)("p",{className:"text-destructive",children:["Error: ",S]}),(0,y.jsxs)("p",{children:["Conversations loaded: ",x.length]})]})]}):(0,y.jsx)("div",{className:"p-2 space-y-1",children:ee.map(e=>(0,y.jsx)(Ts,{conversation:e,isSelected:v?.id===e.id,onSelect:te,onDelete:e=>(async e=>{if(f)o.toast.error("Deleting conversations is not available in free trial mode");else try{await A(e),o.toast.success("Conversation deleted")}catch(e){o.toast.error("Failed to delete conversation")}})(e),onRename:se},e.id))}):(0,y.jsxs)("div",{className:"p-4 text-center",children:[(0,y.jsx)("p",{className:"text-sm text-destructive mb-2",children:"Failed to load conversations"}),(0,y.jsx)(w,{size:"sm",variant:"ghost",onClick:()=>V&&j(V.id),children:"Try Again"})]}):(0,y.jsx)(de,{count:5})}),(0,y.jsxs)("div",{className:"p-4 border-t border-border bg-background space-y-3",children:[(0,y.jsxs)("div",{className:"text-xs text-muted-foreground text-center",children:[R?(0,y.jsxs)(y.Fragment,{children:[ee.length," result",1!==ee.length?"s":""]}):(0,y.jsxs)(y.Fragment,{children:["Showing ",x.length," of ",T," conversation",1!==T?"s":""]}),V&&(0,y.jsxs)("span",{className:"block mt-1",children:["Agent: ",V.project_name]})]}),P>1&&!R&&(0,y.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,y.jsx)(w,{size:"sm",variant:"outline",onClick:()=>{V&&E>1&&j(V.id,{page:E-1})},disabled:1===E||b,children:(0,y.jsx)(k.A,{className:"h-3 w-3 rotate-90"})}),(0,y.jsxs)("span",{className:"text-xs text-muted-foreground",children:["Page ",E," of ",P]}),(0,y.jsx)(w,{size:"sm",variant:"outline",onClick:()=>{V&&E<P&&j(V.id,{page:E+1})},disabled:E===P||b,children:(0,y.jsx)(k.A,{className:"h-3 w-3 -rotate-90"})})]})]})]})},Fs=({mode:e="standalone",className:t,onClose:s,onAgentSettings:a,showSidebar:r=!0,enableConversationManagement:i=!1,maxConversations:o,sessionId:c,threadId:l,onConversationChange:d,onMessage:u,widgetInstance:g,conversations:m,currentConversation:h,conversationRefreshKey:p})=>{const[f,x]=(0,n.useState)(!1),[v,b]=(0,n.useState)(!1),{currentConversation:w}=_t(),{loadMessages:S}=At();(0,n.useEffect)(()=>{const t="undefined"!=typeof window&&window.__customgpt_demo_mode,s="widget"!==e&&"floating"!==e||!h?w:h;s&&!t&&S(s.id.toString())},[w,h,S,e]);const{isMobile:j}=Qe();return r&&"standalone"===e?j?(0,y.jsx)("div",{className:"flex flex-col h-full bg-background",children:(0,y.jsx)(ds,{mode:e,className:"flex-1",onClose:s,onAgentSettings:a,enableConversationManagement:i,maxConversations:o,sessionId:c,threadId:l,onConversationChange:d,onMessage:u,conversationRefreshKey:p,isMobile:!0})}):(0,y.jsxs)("div",{className:"flex h-full bg-background",children:[(0,y.jsx)(Ms,{isCollapsed:f,onToggle:()=>{x(!f)},isMobile:!1}),(0,y.jsx)("div",{className:"flex-1 flex flex-col min-w-0",children:(0,y.jsx)(ds,{mode:e,className:"h-full",onClose:s,onAgentSettings:a,enableConversationManagement:i,maxConversations:o,sessionId:c,threadId:l,onConversationChange:d,onMessage:u,conversationRefreshKey:p,isMobile:!1})})]}):(0,y.jsx)(ds,{mode:e,className:t,onClose:s,onAgentSettings:a,enableConversationManagement:i,maxConversations:o,sessionId:c,threadId:l,onConversationChange:d,onMessage:u,conversationRefreshKey:p,isMobile:j})};function Os(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class Ds{constructor(e){if(Os(this,"container",null),Os(this,"root",null),Os(this,"config",void 0),Os(this,"isOpen",!1),Os(this,"sessionId",void 0),Os(this,"currentConversationId",null),Os(this,"instanceKey",void 0),Os(this,"conversationRefreshKey",0),!e.agentId)throw new Error("CustomGPT Widget: Agent ID is required");if(this.config={mode:"embedded",theme:"light",position:"bottom-right",width:"400px",height:"600px",enableCitations:!0,enableFeedback:!0,enableConversationManagement:!1,...e},"widget"!==this.config.mode&&"floating"!==this.config.mode||!1===this.config.isolateConversations)if(!1!==this.config.isolateConversations){const e=this.config.mode||"widget",t=this.config.containerId||"default",s=`${"undefined"!=typeof performance?performance.now():Date.now()}_${Math.random().toString(36).substr(2,9)}_${Math.random().toString(36).substr(2,5)}`;this.sessionId=`session_${e}_${t}_${s}`}else this.config.sessionId?this.sessionId=this.config.sessionId:this.sessionId=this.generateSessionId();else this.sessionId=`widget_session_${this.config.agentId}`,localStorage.setItem(`customgpt_widget_session_${this.config.agentId}`,this.sessionId);if("undefined"!=typeof window){const e=`__customgpt_widget_${this.sessionId}`;window[e]=this,window.__customgpt_widget_instances||(window.__customgpt_widget_instances={}),window.__customgpt_widget_instances[this.sessionId]=this,window.__customgpt_widget_instance||(window.__customgpt_widget_instance=this),this.instanceKey=e}this.init()}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async init(){const{initializeClient:e}=s(90040);if(this.config.apiKey&&!0!==this.config.useProxy)e({mode:"direct",apiKey:this.config.apiKey,apiUrl:this.config.apiUrl||"https://app.customgpt.ai/api/v1"});else{const t=this.config.apiUrl||"";e({mode:"proxy",apiUrl:t}),t&&(window.__customgpt_api_url=t)}this.config.enableConversationManagement&&(this.config.isolateConversations?(window.__customgpt_sessions||(window.__customgpt_sessions={}),window.__customgpt_sessions[this.sessionId]={sessionId:this.sessionId,maxConversations:this.config.maxConversations,enableConversationManagement:!0}):window.__customgpt_session={sessionId:this.sessionId,maxConversations:this.config.maxConversations,enableConversationManagement:!0});window.__customgpt_demo_mode=!1,this.createContainer(),this.render();const t=localStorage.getItem(`customgpt_widget_conversation_${this.config.agentId}`),a=this.getConversations();if(t&&a.length>0){const e=a.find(e=>e.id===t);e?(this.currentConversationId=t,setTimeout(async()=>{if("undefined"!=typeof window){const s=window.__customgpt_widget_stores;if(s&&s[this.sessionId]){const a=s[this.sessionId].conversationStore,n=s[this.sessionId].messageStore;if(a){a.getState().conversations.some(t=>t.id===e.id)||(a.getState().setSearchQuery(""),a.setState(t=>({allConversations:[...t.allConversations,e],conversations:[...t.conversations,e]})));const s={...e,id:parseInt(e.id)||e.id,project_id:parseInt(this.config.agentId)||0,session_id:this.sessionId,name:e.title||e.name||"Chat"};a.getState().selectConversation(s),n&&setTimeout(()=>{n.getState().loadMessages(t)},100)}}}},300)):setTimeout(async()=>{const e=await this.createConversation("Chat");e&&localStorage.setItem(`customgpt_widget_conversation_${this.config.agentId}`,e.id.toString())},100)}else setTimeout(async()=>{const e=await this.createConversation("Chat");e&&localStorage.setItem(`customgpt_widget_conversation_${this.config.agentId}`,e.id.toString())},100);!1!==this.config.isolateConversations&&"undefined"!=typeof window&&(window.__customgpt_widget_instances=window.__customgpt_widget_instances||{},window.__customgpt_widget_instances[this.sessionId]=this,window.__customgpt_active_widget_session=this.sessionId)}createContainer(){const{mode:e,containerId:t}=this.config;if("embedded"===e&&t){if(this.container=document.getElementById(t),!this.container)throw new Error(`Container with id "${t}" not found`)}else"floating"===e?(this.container=document.createElement("div"),this.container.id="customgpt-floating-widget",this.setupFloatingStyles(),document.body.appendChild(this.container)):(this.container=document.createElement("div"),this.container.id="customgpt-widget",document.body.appendChild(this.container))}setupFloatingStyles(){if(!this.container||"floating"!==this.config.mode)return;const{position:e,width:t,height:s}=this.config;switch(Object.assign(this.container.style,{position:"fixed",zIndex:"9999",width:t||"400px",height:s||"600px",boxShadow:"0 10px 25px rgba(0, 0, 0, 0.2)",borderRadius:"12px",overflow:"hidden",transition:"all 0.3s ease",backgroundColor:"white"}),this.container.classList.add("floating-mode"),this.container.classList.add("customgpt-floating-container"),e){case"bottom-right":Object.assign(this.container.style,{bottom:"20px",right:"20px"});break;case"bottom-left":Object.assign(this.container.style,{bottom:"20px",left:"20px"});break;case"top-right":Object.assign(this.container.style,{top:"20px",right:"20px"});break;case"top-left":Object.assign(this.container.style,{top:"20px",left:"20px"})}this.container.style.display="none",this.container.style.opacity="0",this.container.style.transform="translateY(20px)"}render(){if(!this.container)return;"embedded"===this.config.mode&&(this.container.classList.add("customgpt-embedded-widget"),Object.assign(this.container.style,{width:this.config.width||"400px",height:this.config.height||"600px",margin:"0 auto",display:"block"})),this.root||(this.root=(0,a.H)(this.container));const e=()=>{"undefined"==typeof window||window.__customgpt_widget_instance||(window.__customgpt_widget_instance=this);const e=this.currentConversationId||this.config.threadId;this.sessionId;return(0,y.jsx)(ht,{sessionId:this.sessionId,children:(0,y.jsx)(at,{widgetInstance:this,children:(0,y.jsxs)("div",{className:`customgpt-widget-wrapper widget-mode ${this.config.mode}-mode`,children:[(0,y.jsx)(Fs,{mode:"embedded"===this.config.mode?"widget":"floating",onClose:"floating"===this.config.mode?()=>{this.close(),this.config.onClose?.()}:void 0,showSidebar:!1,className:"w-full h-full",enableConversationManagement:this.config.enableConversationManagement,maxConversations:this.config.maxConversations,sessionId:this.sessionId,threadId:e,onConversationChange:this.config.onConversationChange,onMessage:this.config.onMessage,widgetInstance:!1!==this.config.isolateConversations?this:void 0,conversations:!1!==this.config.isolateConversations?this.getConversations():void 0,currentConversation:!1!==this.config.isolateConversations&&this.currentConversationId?this.getConversations().find(e=>e.id===this.currentConversationId):void 0,conversationRefreshKey:this.conversationRefreshKey}),(0,y.jsx)(et,{sessionId:this.sessionId})]})})})};this.root.render((0,y.jsx)(e,{})),"embedded"===this.config.mode&&this.open()}getConversations(){const e=localStorage.getItem(`customgpt_conversations_${this.sessionId}`);if(e)try{return JSON.parse(e)}catch(e){}return[]}switchConversation(e){lt.log("WIDGET","switchConversation called",{conversationId:e,conversationIdType:typeof e,sessionId:this.sessionId,isolateConversations:this.config.isolateConversations,currentConversations:this.getConversations().map(e=>({id:e.id,idType:typeof e.id,title:e.title}))});const t=this.getConversations().find(t=>t.id===e||t.id===parseInt(e));if(lt.log("WIDGET","Found conversation",{found:!!t,conversationId:e,searchedId:e,conversationDetails:t?{id:t.id,idType:typeof t.id,title:t.title,session_id:t.session_id}:null}),t){if(this.currentConversationId=e,this.conversationRefreshKey++,!1!==this.config.isolateConversations&&"undefined"!=typeof window){const s=window.__customgpt_widget_stores;if(lt.log("WIDGET","Accessing widget stores",{hasWidgetStores:!!s,sessionId:this.sessionId,hasSessionStore:s&&!!s[this.sessionId],availableSessions:s?Object.keys(s):[]}),s&&s[this.sessionId]){const a=s[this.sessionId].messageStore,n=s[this.sessionId].conversationStore;if(a){lt.log("WIDGET","Loading messages via store",{conversationId:e,storeHasLoadMessages:"function"==typeof a.getState().loadMessages}),lt.traceMessageFlow("SWITCH_CONVERSATION",{conversationId:e,sessionId:this.sessionId,action:"Loading messages"});const t=String(e);lt.log("WIDGET","Calling loadMessages with string ID",{originalId:e,stringId:t,typeOfOriginal:typeof e}),a.getState().loadMessages(t)}if(n){lt.log("WIDGET","Updating conversation store",{conversationId:t.id,conversationIdType:typeof t.id});const e={...t,id:parseInt(t.id)||t.id,project_id:parseInt(this.config.agentId)||0,session_id:this.sessionId,name:t.title};n.getState().selectConversation(e)}}else lt.log("WIDGET","Widget stores not found",{sessionId:this.sessionId,availableStores:Object.keys(s||{})},"error")}if(!this.config.isolateConversations&&"undefined"!=typeof window){const{useConversationStore:t}=s(51276),a=this.getConversations().map(e=>({...e,project_id:parseInt(this.config.agentId)||0,session_id:this.sessionId,name:e.title})),n=a.find(t=>t.id===e);t.setState({conversations:a,currentConversation:n})}this.render(),this.config.onConversationChange?.(t)}}async createConversation(e){const t=this.getConversations();if(this.config.maxConversations&&t.length>=this.config.maxConversations)return null;if(!1!==this.config.isolateConversations&&"undefined"!=typeof window){const s=window.__customgpt_widget_stores;if(s&&s[this.sessionId]){const a=s[this.sessionId].conversationStore;s[this.sessionId].messageStore;if(a)try{await a.getState().createConversation(parseInt(this.config.agentId)||0,e||`Conversation ${t.length+1}`);const s=a.getState().currentConversation;if(s){const a={id:s.id.toString(),title:s.name||e||`Conversation ${t.length+1}`,createdAt:s.created_at||(new Date).toISOString(),messages:[],project_id:s.project_id,session_id:s.session_id,name:s.name};return t.unshift(a),this.saveConversations(t),this.currentConversationId=a.id,localStorage.setItem(`customgpt_widget_conversation_${this.config.agentId}`,a.id.toString()),this.conversationRefreshKey++,this.render(),a}}catch(e){}}}const s={id:`conv_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,title:e||`Conversation ${t.length+1}`,createdAt:(new Date).toISOString(),messages:[],project_id:parseInt(this.config.agentId)||0,session_id:this.sessionId,name:e||`Conversation ${t.length+1}`};return t.unshift(s),this.saveConversations(t),this.currentConversationId=s.id,localStorage.setItem(`customgpt_widget_conversation_${this.config.agentId}`,s.id.toString()),this.conversationRefreshKey++,this.render(),s}updateConversationTitle(e,t){const s=this.getConversations(),a=s.find(t=>t.id===e);a&&(a.title=t,this.saveConversations(s),this.conversationRefreshKey++,this.render())}deleteConversation(e){const t=this.getConversations().filter(t=>t.id!==e);this.saveConversations(t),this.conversationRefreshKey++,this.currentConversationId===e?t.length>0?this.switchConversation(t[0].id):this.createConversation().catch(e=>{}):this.render()}saveConversations(e){try{localStorage.setItem(`customgpt_conversations_${this.sessionId}`,JSON.stringify(e))}catch(e){e instanceof DOMException&&"QuotaExceededError"===e.name&&this.cleanupOldConversations()}}cleanupOldConversations(){const e=this.getConversations().slice(0,3);this.saveConversations(e)}open(){this.container&&(this.isOpen=!0,"floating"===this.config.mode&&(this.container.style.display="block",setTimeout(()=>{this.container&&(this.container.style.transform="translateY(0)",this.container.style.opacity="1")},10)),this.config.onOpen?.())}close(){this.container&&(this.isOpen=!1,"floating"===this.config.mode&&(this.container.style.transform="translateY(20px)",this.container.style.opacity="0",setTimeout(()=>{this.container&&(this.container.style.display="none")},300)))}toggle(){this.isOpen?this.close():this.open()}destroy(){if(this.root&&this.root.unmount(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),"undefined"!=typeof window){const e=window.__customgpt_widget_stores;e&&e[this.sessionId]&&delete e[this.sessionId];const t=window.__customgpt_widget_instances;t&&t[this.sessionId]&&delete t[this.sessionId],this.instanceKey&&delete window[this.instanceKey]}this.container=null,this.root=null}updateConfig(e){this.config={...this.config,...e},this.render()}refresh(){this.render()}get isOpened(){return this.isOpen}get configuration(){return{...this.config}}}const $s={init:e=>new Ds(e),create:e=>new Ds(e)};"undefined"!=typeof window&&(window.CustomGPTWidget=$s);const Rs=$s},86e3:(e,t,s)=>{"use strict";s.d(t,{w:()=>r});var a=s(71446),n=s(35189);const r=(0,a.vt)()((0,n.Zr)((e,t)=>({settings:{},getSettings:e=>{const s=t().settings[e]||{};return{response_source:s.response_source||"own_content",chatbot_model:s.chatbot_model||"gpt-4-o",custom_persona:s.custom_persona||"professional",agent_capability:s.agent_capability||"optimal-choice",...s}},updateSettings:(t,s)=>{e(e=>({settings:{...e.settings,[t]:{...e.settings[t],...s}}}))},clearSettings:t=>{e(e=>{const s={...e.settings};return delete s[t],{settings:s}})}}),{name:"customgpt-chat-settings"}))},90040:(e,t,s)=>{"use strict";s.r(t),s.d(t,{apiClient:()=>A,getApiClient:()=>j,getClient:()=>S,initializeClient:()=>w,isClientInitialized:()=>C,resetApiClient:()=>N});var a=s(17047),n=s(25772);const r="customgpt.deploymentMode",i="customgpt.freeTrialMode",o="customgpt.freeTrialSession",c="customgpt.demoSession";function l(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class d{constructor(){l(this,"analyticsEndpoint",{NODE_ENV:"production",NEXT_PUBLIC_API_BASE_URL:"https://app.customgpt.ai/api/v1"}.NEXT_PUBLIC_ANALYTICS_ENDPOINT||"/api/analytics"),l(this,"batchSize",10),l(this,"flushInterval",3e4),l(this,"eventQueue",[]),l(this,"flushTimer",null),this.startFlushTimer()}static getInstance(){return d.instance||(d.instance=new d),d.instance}track(e){const t={eventType:e.eventType||"api_call",eventName:e.eventName||"unknown",timestamp:Date.now(),deploymentMode:this.getDeploymentMode(),demoType:this.getDemoType(),sessionId:this.getSessionId(),clientVersion:{NODE_ENV:"production",NEXT_PUBLIC_API_BASE_URL:"https://app.customgpt.ai/api/v1"}.NEXT_PUBLIC_APP_VERSION||"1.0.0",userAgent:"undefined"!=typeof window?window.navigator.userAgent:void 0,referrer:"undefined"!=typeof window?document.referrer:void 0,...e};this.eventQueue.push(t),this.eventQueue.length>=this.batchSize&&this.flush()}trackApiCall(e,t,s){this.track({eventType:"api_call",eventName:`${t} ${e}`,endpoint:e,method:t,statusCode:s})}trackSessionStart(){this.track({eventType:"session_start",eventName:"session_started",metadata:{mode:this.getDemoType()||"production"}})}trackSessionEnd(e){this.track({eventType:"session_end",eventName:"session_ended",metadata:{reason:e,mode:this.getDemoType()||"production"}})}trackLimitReached(e){this.track({eventType:"limit_reached",eventName:`${e}_limit_reached`,metadata:{limitType:e}})}trackError(e,t){this.track({eventType:"error",eventName:"error_occurred",metadata:{error:e,context:t}})}getDeploymentMode(){if("undefined"==typeof window)return"production";return"demo"===localStorage.getItem(r)?"demo":"production"}getDemoType(){if("undefined"==typeof window)return"none";if("demo"!==localStorage.getItem(r))return"none";return"true"===localStorage.getItem(i)?"free-trial":"user-api-key"}getSessionId(){if("undefined"==typeof window)return;const e=sessionStorage.getItem(o);if(e)try{return JSON.parse(e).sessionId}catch(e){}const t=sessionStorage.getItem(c);if(t)try{return JSON.parse(t).sessionId}catch(e){}}startFlushTimer(){this.flushTimer&&clearInterval(this.flushTimer),this.flushTimer=setInterval(()=>{this.eventQueue.length>0&&this.flush()},this.flushInterval)}async flush(){if(0===this.eventQueue.length)return;const e=[...this.eventQueue];this.eventQueue=[];try{({NODE_ENV:"production",NEXT_PUBLIC_API_BASE_URL:"https://app.customgpt.ai/api/v1"}).NEXT_PUBLIC_ANALYTICS_ENDPOINT&&await fetch(this.analyticsEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:e})})}catch(t){this.eventQueue.unshift(...e)}}async forceFlush(){await this.flush()}}l(d,"instance",void 0);const u=d.getInstance();"undefined"!=typeof window&&(document.addEventListener("visibilitychange",()=>{document.hidden&&u.forceFlush()}),window.addEventListener("beforeunload",()=>{u.forceFlush()}));const g={title:"Rate Limit Reached",message:"The free trial is experiencing high demand. Please wait a moment and try again.",retryAfter:60},m={title:"Limit Reached",message:"You have reached the maximum allowed for this free trial session."},h={title:"Service Error",message:"Unable to process your request. Please try again later."};function p(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const f=new class{constructor(){if(p(this,"baseURL","/api/proxy"),p(this,"timeout",3e4),p(this,"abortControllers",new Map),p(this,"isDemoMode",!1),p(this,"demoApiKey",null),"undefined"!=typeof window){const e=localStorage.getItem("customgpt.deploymentMode");this.isDemoMode="demo"===e;const t=window.__customgpt_api_url;t&&(this.baseURL=`${t}/api/proxy`)}n.v.info("PROXY_CLIENT","Proxy API Client initialized",{baseURL:this.baseURL,timeout:this.timeout,isDemoMode:this.isDemoMode})}setApiUrl(e){this.baseURL=`${e}/api/proxy`,n.v.info("PROXY_CLIENT","API URL updated",{baseURL:this.baseURL})}setDemoApiKey(e){this.demoApiKey=e}async request(e,t={}){const s=`${this.baseURL}${e}`,a=`${t.method||"GET"}-${e}-${Date.now()}`;n.v.apiRequest(e,t.method||"GET",t.body);try{const r=new AbortController;this.abortControllers.set(a,r);const i=setTimeout(()=>{r.abort()},this.timeout),o=t.body instanceof FormData,c={...t.headers||{}},l="undefined"!=typeof window&&localStorage.getItem("customgpt.deploymentMode")||"production";c["X-Deployment-Mode"]=l;if("undefined"!=typeof window&&"true"===localStorage.getItem("customgpt.freeTrialMode")){c["X-Free-Trial-Mode"]="true";const e=sessionStorage.getItem("customgpt.freeTrialSession");if(e)try{const t=JSON.parse(e);t.sessionId&&(c["X-Demo-Session-ID"]=t.sessionId)}catch(e){}}else"demo"===l&&this.demoApiKey?c["X-CustomGPT-API-Key"]=this.demoApiKey:"demo"===l&&this.demoApiKey;const d=o?c:{"Content-Type":"application/json",...c},p=await fetch(s,{...t,headers:d,signal:r.signal});let f;clearTimeout(i),this.abortControllers.delete(a);const x=p.headers.get("content-length"),v=p.headers.get("content-type");if("0"===x||!v?.includes("application/json")&&200===p.status)f={status:"success",data:{updated:!0}};else try{const e=await p.text();f=""===e.trim()?{status:"success",data:{updated:!0}}:JSON.parse(e)}catch(e){if(!p.ok)throw new Error(`Failed to parse response: ${e}`);f={status:"success",data:{updated:!0}}}if(u.trackApiCall(e,t.method||"GET",p.status),!p.ok){u.trackError(`API Error: ${p.status}`,{endpoint:e,method:t.method||"GET",error:f.error});const s="true"===c["X-Free-Trial-Mode"],a=function(e,t){return 429===e&&t?g:403===e&&t?m:e>=500?h:{title:"Error",message:"An unexpected error occurred. Please try again."}}(p.status,s);throw{message:f.error||a.message,status:p.status,data:f,title:a.title,isFreeTrialError:s&&429===p.status}}return n.v.apiResponse(e,p.status,f),f}catch(t){if(this.abortControllers.delete(a),"AbortError"===t.name)throw n.v.apiError(e,{message:"Request timeout",code:"TIMEOUT"}),new Error("Request timeout");throw n.v.apiError(e,t),t}}async streamRequest(e,t={}){const s=`${this.baseURL}${e}`;n.v.apiRequest(e,"POST-STREAM",t.body);const a={"Content-Type":"application/json",Accept:"text/event-stream",...t.headers||{}},r="undefined"!=typeof window&&localStorage.getItem("customgpt.deploymentMode")||"production";a["X-Deployment-Mode"]=r;if("undefined"!=typeof window&&"true"===localStorage.getItem("customgpt.freeTrialMode")){a["X-Free-Trial-Mode"]="true";const e=sessionStorage.getItem("customgpt.freeTrialSession");if(e)try{const t=JSON.parse(e);t.sessionId&&(a["X-Demo-Session-ID"]=t.sessionId)}catch(e){}}else"demo"===r&&this.demoApiKey?a["X-CustomGPT-API-Key"]=this.demoApiKey:"demo"===r&&this.demoApiKey;const i=await fetch(s,{...t,headers:a});if(!i.ok){let t=`Stream request failed: ${i.status}`;try{const e=await i.text(),s=JSON.parse(e);t=s.error||s.message||t}catch{}throw n.v.apiError(e,{message:t,status:i.status}),new Error(t)}return n.v.apiResponse(e,i.status,"Stream started"),i.body}cancelRequest(e,t="GET"){Array.from(this.abortControllers.entries()).forEach(([s,a])=>{s.includes(`${t}-${e}`)&&(a.abort(),this.abortControllers.delete(s))})}cancelAllRequests(){this.abortControllers.forEach(e=>e.abort()),this.abortControllers.clear()}async getAgents(e){const t=new URLSearchParams;e?.page&&t.append("page",e.page.toString()),e?.per_page&&t.append("per_page",e.per_page.toString());const s=t.toString();return this.request("/projects"+(s?`?${s}`:""))}async createAgent(e){return this.request("/projects",{method:"POST",body:JSON.stringify(e)})}async getAgent(e){return this.request(`/projects/${e}`)}async updateAgent(e,t){const s=new FormData;Object.entries(t).forEach(([e,t])=>{void 0!==t&&s.append(e,String(t))});return await this.request(`/projects/${e}`,{method:"POST",body:s})}async deleteAgent(e){return this.request(`/projects/${e}`,{method:"DELETE"})}async replicateAgent(e){return this.request(`/projects/${e}/replicate`,{method:"POST"})}async getAgentStats(e){return this.request(`/projects/${e}/stats`)}async getAgentSettings(e){return this.request(`/projects/${e}/settings`)}async updateAgentSettings(e,t){const s=t instanceof FormData;return this.request(`/projects/${e}/settings`,{method:"POST",body:s?t:JSON.stringify(t),headers:s?{}:{"Content-Type":"application/json"}})}async getProjectPlugins(e){return this.request(`/projects/${e}/plugins`)}async updateProjectPlugin(e,t,s){return this.request(`/projects/${e}/plugins/${t}`,{method:"PUT",body:JSON.stringify(s)})}async getConversations(e,t){const s=new URLSearchParams;t?.page&&s.append("page",t.page.toString()),t?.per_page&&s.append("per_page",t.per_page.toString()),t?.order&&s.append("order",t.order),t?.orderBy&&s.append("orderBy",t.orderBy),t?.userFilter&&s.append("userFilter",t.userFilter);const a=s.toString();return this.request(`/projects/${e}/conversations${a?`?${a}`:""}`)}async createConversation(e,t){return this.request(`/projects/${e}/conversations`,{method:"POST",body:JSON.stringify(t||{})})}async updateConversation(e,t,s){return this.request(`/projects/${e}/conversations/${t}`,{method:"PUT",body:JSON.stringify(s)})}async deleteConversation(e,t){return this.request(`/projects/${e}/conversations/${t}`,{method:"DELETE"})}async getMessages(e,t,s){const a=new URLSearchParams;s?.page&&a.append("page",s.page.toString()),s?.per_page&&a.append("per_page",s.per_page.toString());const n=a.toString();return this.request(`/projects/${e}/conversations/${t}/messages${n?`?${n}`:""}`)}async sendMessage(e,t,s){return this.request(`/projects/${e}/conversations/${t}/messages`,{method:"POST",body:JSON.stringify(s)})}async sendMessageStream(e,t,s,n,r,i){try{const r=(await this.streamRequest(`/projects/${e}/conversations/${t}/messages`,{method:"POST",body:JSON.stringify({...s,stream:!0})})).getReader(),o=new TextDecoder;let c="";for(;;){const{done:e,value:t}=await r.read();if(e){i?.();break}c+=o.decode(t,{stream:!0});const s=c.split("\n");c=s.pop()||"";for(const e of s)if(e.startsWith("data: "))try{if("[DONE]"===e.slice(6))return void i?.();const t=(0,a.RW)(e);t&&n(t)}catch(e){}}}catch(e){throw r?.(e),e}}async getMessageById(e,t,s){return this.request(`/projects/${e}/conversations/${t}/messages/${s}`)}async updateMessageFeedback(e,t,s,a){return this.request(`/projects/${e}/conversations/${t}/messages/${s}/feedback`,{method:"PUT",body:JSON.stringify(a)})}async getCitation(e,t){return this.request(`/projects/${e}/citations/${t}`)}async previewCitationFile(e){return this.request(`/preview/${e}`)}async uploadFile(e,t,s){const a=new FormData;return a.append("file",t),this.request(`/projects/${e}/sources`,{method:"POST",body:a,headers:{}})}async getTrafficReport(e){return this.request(`/projects/${e}/reports/traffic`)}async getQueriesReport(e){return this.request(`/projects/${e}/reports/queries`)}async getConversationsReport(e){return this.request(`/projects/${e}/reports/conversations`)}async getAnalysisReport(e,t){const s=new URLSearchParams;t&&s.append("interval",t);const a=s.toString();return this.request(`/projects/${e}/reports/analysis${a?`?${a}`:""}`)}async getPages(e,t){const s=new URLSearchParams;t?.page&&s.append("page",t.page.toString()),t?.limit&&s.append("limit",t.limit.toString()),t?.order&&s.append("order",t.order),t?.crawl_status&&s.append("crawl_status",t.crawl_status),t?.index_status&&s.append("index_status",t.index_status);const a=s.toString();return this.request(`/projects/${e}/pages${a?`?${a}`:""}`)}async deletePage(e,t){return this.request(`/projects/${e}/pages/${t}`,{method:"DELETE"})}async reindexPage(e,t){return this.request(`/projects/${e}/pages/${t}/reindex`,{method:"POST"})}async getPageMetadata(e,t){return this.request(`/projects/${e}/pages/${t}/metadata`)}async updatePageMetadata(e,t,s){return this.request(`/projects/${e}/pages/${t}/metadata`,{method:"PUT",body:JSON.stringify(s)})}async getLicenses(e){return this.request(`/projects/${e}/license_keys`)}async createLicense(e,t){return this.request(`/projects/${e}/license_keys`,{method:"POST",body:JSON.stringify(t)})}async getLicense(e,t){return this.request(`/projects/${e}/license_keys/${t}`)}async updateLicense(e,t,s){return this.request(`/projects/${e}/license_keys/${t}`,{method:"PUT",body:JSON.stringify(s)})}async deleteLicense(e,t){return this.request(`/projects/${e}/license_keys/${t}`,{method:"DELETE"})}async getSources(e){return this.request(`/projects/${e}/sources`)}async createSitemapSource(e,t){const s=new FormData;return s.append("sitemap_path",t.sitemap_path),void 0!==t.executive_js&&s.append("executive_js",String(t.executive_js)),void 0!==t.data_refresh_frequency&&s.append("data_refresh_frequency",t.data_refresh_frequency),void 0!==t.create_new_pages&&s.append("create_new_pages",String(t.create_new_pages)),void 0!==t.remove_unexist_pages&&s.append("remove_unexist_pages",String(t.remove_unexist_pages)),void 0!==t.refresh_existing_pages&&s.append("refresh_existing_pages",t.refresh_existing_pages),this.request(`/projects/${e}/sources`,{method:"POST",body:s,headers:{}})}async uploadFileSource(e,t){return this.request(`/projects/${e}/sources`,{method:"POST",body:t,headers:{}})}async updateSourceSettings(e,t,s){return this.request(`/projects/${e}/sources/${t}`,{method:"PUT",body:JSON.stringify(s)})}async deleteSource(e,t){return this.request(`/projects/${e}/sources/${t}`,{method:"DELETE"})}async instantSyncSource(e,t){return this.request(`/projects/${e}/sources/${t}/instant-sync`,{method:"PUT"})}async getCustomerIntelligence(e,t=1,s=100){return this.request(`/projects/${e}/reports/intelligence?page=${t}&limit=${s}`)}async getUserLimits(){return this.request("/user/limits")}async getUserProfile(){return this.request("/user")}async updateUserProfile(e){return this.request("/user",{method:"POST",body:e,headers:{}})}async getDemoUsageStats(){const e=sessionStorage.getItem("customgpt.freeTrialSession");let t=Date.now();if(e)try{t=JSON.parse(e).startTime||Date.now()}catch(e){}return this.request("/demo/usage",{headers:{"X-Session-Start-Time":t.toString()}})}async cleanupDemoSession(){return this.request("/demo/cleanup",{method:"POST"})}};function x(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class v{constructor(e,t){if(x(this,"baseURL","https://app.customgpt.ai/api/v1"),x(this,"apiKey",void 0),x(this,"timeout",3e4),x(this,"abortControllers",new Map),x(this,"demoApiKey",null),!e)throw new Error("API key is required for direct client");this.apiKey=e,t&&(this.baseURL=t),n.v.info("DIRECT_CLIENT","Direct API Client initialized",{baseURL:this.baseURL,hasApiKey:!!e})}async request(e,t={}){const s=`${this.baseURL}${e}`,a=`${t.method||"GET"}-${e}-${Date.now()}`;n.v.apiRequest(e,t.method||"GET",t.body);try{const r=new AbortController;this.abortControllers.set(a,r);const i=setTimeout(()=>{r.abort()},this.timeout),o=t.body instanceof FormData,c={accept:"application/json",Authorization:`Bearer ${this.apiKey}`,...t.headers||{}};o||(c["Content-Type"]="application/json");const l=await fetch(s,{...t,headers:c,signal:r.signal});let d;clearTimeout(i),this.abortControllers.delete(a);const u=l.headers.get("content-type");if(u?.includes("application/json"))d=await l.json();else{const e=await l.text();d={status:l.ok?"success":"error",data:e,message:e}}if(!l.ok)throw{message:d.error||d.message||`Request failed: ${l.status}`,status:l.status,data:d};return n.v.apiResponse(e,l.status,d),d}catch(t){if(this.abortControllers.delete(a),"AbortError"===t.name)throw n.v.apiError(e,{message:"Request timeout",code:"TIMEOUT"}),new Error("Request timeout");throw n.v.apiError(e,t),t}}async streamRequest(e,t={}){const s=`${this.baseURL}${e}`;n.v.apiRequest(e,"POST-STREAM",t.body);const a={"Content-Type":"application/json",Accept:"text/event-stream",Authorization:`Bearer ${this.apiKey}`,...t.headers||{}},r=await fetch(s,{...t,headers:a});if(!r.ok){let t=`Stream request failed: ${r.status}`;try{const e=await r.text(),s=JSON.parse(e);t=s.error||s.message||t}catch{}throw n.v.apiError(e,{message:t,status:r.status}),new Error(t)}return n.v.apiResponse(e,r.status,"Stream started"),r.body}cancelRequest(e,t="GET"){Array.from(this.abortControllers.entries()).forEach(([s,a])=>{s.includes(`${t}-${e}`)&&(a.abort(),this.abortControllers.delete(s))})}cancelAllRequests(){this.abortControllers.forEach(e=>e.abort()),this.abortControllers.clear()}setDemoApiKey(e){this.demoApiKey=e}async getAgents(e){const t=new URLSearchParams;e?.page&&t.append("page",e.page.toString()),e?.per_page&&t.append("per_page",e.per_page.toString());const s=t.toString();return this.request("/projects"+(s?`?${s}`:""))}async getAgent(e){return this.request(`/projects/${e}`)}async createAgent(e){return this.request("/projects",{method:"POST",body:JSON.stringify(e)})}async getAgentSettings(e){return this.request(`/projects/${e}/settings`)}async updateAgentSettings(e,t){const s=t instanceof FormData;return this.request(`/projects/${e}/settings`,{method:"POST",body:s?t:JSON.stringify(t),headers:s?{}:{"Content-Type":"application/json"}})}async getConversations(e,t){const s=new URLSearchParams;t?.page&&s.append("page",t.page.toString()),t?.per_page&&s.append("per_page",t.per_page.toString());const a=s.toString();return this.request(`/projects/${e}/conversations${a?`?${a}`:""}`)}async createConversation(e,t){return this.request(`/projects/${e}/conversations`,{method:"POST",body:JSON.stringify(t||{})})}async updateConversation(e,t,s){return this.request(`/projects/${e}/conversations/${t}`,{method:"PUT",body:JSON.stringify(s)})}async deleteConversation(e,t){return this.request(`/projects/${e}/conversations/${t}`,{method:"DELETE"})}async getMessages(e,t,s){const a=new URLSearchParams;s?.page&&a.append("page",s.page.toString()),s?.per_page&&a.append("per_page",s.per_page.toString());const n=a.toString();return this.request(`/projects/${e}/conversations/${t}/messages${n?`?${n}`:""}`)}async getMessageById(e,t,s){return this.request(`/projects/${e}/conversations/${t}/messages/${s}`)}async sendMessage(e,t,s){return this.request(`/projects/${e}/conversations/${t}/messages`,{method:"POST",body:JSON.stringify(s)})}async sendMessageStream(e,t,s,n,r,i){try{const r=(await this.streamRequest(`/projects/${e}/conversations/${t}/messages`,{method:"POST",body:JSON.stringify({...s,stream:!0})})).getReader(),o=new TextDecoder;let c="";for(;;){const{done:e,value:t}=await r.read();if(e){i?.();break}c+=o.decode(t,{stream:!0});const s=c.split("\n");c=s.pop()||"";for(const e of s)if(e.startsWith("data: "))try{const t=e.slice(6);if("[DONE]"===t)return void i?.();const s=(0,a.RW)(t);s&&n(s)}catch(e){}}}catch(e){throw r?.(e),e}}async updateMessageFeedback(e,t,s,a){return this.request(`/projects/${e}/conversations/${t}/messages/${s}/feedback`,{method:"PUT",body:JSON.stringify(a)})}async getCitation(e,t){return this.request(`/projects/${e}/citations/${t}`)}async previewCitationFile(e){return this.request(`/preview/${e}`)}async getTrafficReport(e){return this.request(`/projects/${e}/reports/traffic`)}async getQueriesReport(e){return this.request(`/projects/${e}/reports/queries`)}async getConversationsReport(e){return this.request(`/projects/${e}/reports/conversations`)}async getAnalysisReport(e,t){const s=new URLSearchParams;t&&s.append("interval",t);const a=s.toString();return this.request(`/projects/${e}/reports/analysis${a?`?${a}`:""}`)}async getPages(e,t){const s=new URLSearchParams;t?.page&&s.append("page",t.page.toString()),t?.limit&&s.append("limit",t.limit.toString()),t?.order&&s.append("order",t.order),t?.crawl_status&&s.append("crawl_status",t.crawl_status),t?.index_status&&s.append("index_status",t.index_status);const a=s.toString();return this.request(`/projects/${e}/pages${a?`?${a}`:""}`)}async deletePage(e,t){return this.request(`/projects/${e}/pages/${t}`,{method:"DELETE"})}async reindexPage(e,t){return this.request(`/projects/${e}/pages/${t}/reindex`,{method:"POST"})}async getPageMetadata(e,t){return this.request(`/projects/${e}/pages/${t}/metadata`)}async updatePageMetadata(e,t,s){return this.request(`/projects/${e}/pages/${t}/metadata`,{method:"PUT",body:JSON.stringify(s)})}async getSources(e){return this.request(`/projects/${e}/sources`)}async createSitemapSource(e,t){const s=new FormData;return s.append("sitemap_path",t.sitemap_path),void 0!==t.executive_js&&s.append("executive_js",String(t.executive_js)),void 0!==t.data_refresh_frequency&&s.append("data_refresh_frequency",t.data_refresh_frequency),void 0!==t.create_new_pages&&s.append("create_new_pages",String(t.create_new_pages)),void 0!==t.remove_unexist_pages&&s.append("remove_unexist_pages",String(t.remove_unexist_pages)),void 0!==t.refresh_existing_pages&&s.append("refresh_existing_pages",t.refresh_existing_pages),this.request(`/projects/${e}/sources`,{method:"POST",body:s,headers:{}})}async uploadFileSource(e,t){return this.request(`/projects/${e}/sources`,{method:"POST",body:t,headers:{}})}async updateSourceSettings(e,t,s){return this.request(`/projects/${e}/sources/${t}`,{method:"PUT",body:JSON.stringify(s)})}async deleteSource(e,t){return this.request(`/projects/${e}/sources/${t}`,{method:"DELETE"})}async instantSyncSource(e,t){return this.request(`/projects/${e}/sources/${t}/instant-sync`,{method:"PUT"})}async uploadFile(e,t){const s=new FormData;return s.append("file",t),this.request(`/projects/${e}/sources`,{method:"POST",body:s})}async getUserLimits(){return this.request("/user/limits")}async getUserProfile(){return this.request("/user")}async updateUserProfile(e){return this.request("/user",{method:"POST",body:e,headers:{}})}async updateAgent(e,t){const s=new FormData;return Object.entries(t).forEach(([e,t])=>{void 0!==t&&s.append(e,String(t))}),this.request(`/projects/${e}`,{method:"POST",body:s})}async deleteAgent(e){return this.request(`/projects/${e}`,{method:"DELETE"})}async getAgentStats(e){return this.request(`/projects/${e}/stats`)}async replicateAgent(e){return this.request(`/projects/${e}/replicate`,{method:"POST"})}async getLicenses(e){return this.request(`/projects/${e}/license_keys`)}async createLicense(e,t){return this.request(`/projects/${e}/license_keys`,{method:"POST",body:JSON.stringify(t)})}async getLicense(e,t){return this.request(`/projects/${e}/license_keys/${t}`)}async updateLicense(e,t,s){return this.request(`/projects/${e}/license_keys/${t}`,{method:"PUT",body:JSON.stringify(s)})}async deleteLicense(e,t){return this.request(`/projects/${e}/license_keys/${t}`,{method:"DELETE"})}async getProjectPlugins(e){return this.request(`/projects/${e}/plugins`)}async updateProjectPlugin(e,t,s){return this.request(`/projects/${e}/plugins/${t}`,{method:"PUT",body:JSON.stringify(s)})}}let y=null,b=!1;function w(e){e?"direct"===e.mode&&e.apiKey?(y=new v(e.apiKey,e.apiUrl),b=!0):(y=f,e.apiUrl&&f.setApiUrl(e.apiUrl),b=!0):(y=f,b=!0)}function S(){return y||(y=f),y}function j(e){return e&&w(e),S()}function C(){return b||null!==y}function N(){y=null,b=!1}const A=S()},91582:(e,t,s)=>{"use strict";s.d(t,{o:()=>p});var a=s(71446),n=s(90040),r=s(27292),i=s(7648),o=s(86e3),c=s(17047),l=s(33345),d=s(25772),u=s(31681);const g="customgpt-messages-cache";function m(e,t){try{const s=localStorage.getItem(g),a=s?JSON.parse(s):{};a[e]=t,localStorage.setItem(g,JSON.stringify(a))}catch(e){}}async function h(e,t){const s=function(e){if(!Array.isArray(e))return d.v.warn("MESSAGES","Citation IDs is not an array",{citationIds:e}),[];const t=e.filter(e=>"number"==typeof e&&!isNaN(e)&&e>0).filter((e,t,s)=>s.indexOf(e)===t);return t.length!==e.length&&d.v.warn("MESSAGES","Filtered out invalid citation IDs",{original:e,valid:t,filtered:e.length-t.length}),t}(e);if(0===s.length)return d.v.warn("MESSAGES","No valid citation IDs to fetch",{citationIds:e}),[];d.v.info("MESSAGES","Fetching citation details",{projectId:t,citationIds:s,count:s.length});const a=(0,n.getClient)(),r=[];for(let e=0;e<s.length;e++){const n=s[e];try{const s=await a.getCitation(t,n);if(s.data){const t={id:n.toString(),index:e+1,title:s.data.title||`Citation ${e+1}`,source:s.data.url,url:s.data.url,content:s.data.description||""};r.push(t),d.v.info("MESSAGES","Citation fetched successfully",{citationId:n,title:t.title,hasContent:!!t.content,hasUrl:!!t.url})}else d.v.warn("MESSAGES","Citation API returned empty data",{citationId:n,response:s})}catch(s){if(d.v.warn("MESSAGES","Failed to fetch citation details",{citationId:n,projectId:t,error:s instanceof Error?s.message:String(s),errorType:s instanceof Error?s.constructor.name:typeof s}),s instanceof Error&&s.message.includes("404")){d.v.info("MESSAGES","Citation not found, skipping fallback",{citationId:n});continue}r.push({id:n.toString(),index:e+1,title:`Citation ${e+1}`,source:"",url:"",content:"Citation details unavailable"})}}return d.v.info("MESSAGES","Citation fetching completed",{requested:s.length,fetched:r.length,success:r.filter(e=>"Citation details unavailable"!==e.content).length}),r}const p=(0,a.vt)((e,t)=>({messages:new Map,streamingMessage:null,isStreaming:!1,loading:!1,error:null,sendMessage:async(s,a)=>{"undefined"!=typeof window&&window.__customgpt_demo_mode;const l=r.o.getState(),u=i.w.getState(),{currentAgent:g}=l;if(!g){d.v.error("MESSAGES","No agent selected when trying to send message");const e=await fetch("/api/proxy/user/limits").catch(()=>null);if(!e||401===e.status||500===e.status)throw new Error("API key not configured. Please add CUSTOMGPT_API_KEY to your .env.local file and restart the server.");throw new Error("No agent selected. Please select or create an agent first.")}d.v.info("MESSAGES","Sending message",{agentId:g.id,agentName:g.project_name,messageLength:s.length,hasFiles:a&&a.length>0});const m=await u.ensureConversation(g.id,s);if(d.v.info("MESSAGES","Conversation ensured",{conversationId:m.id,sessionId:m.session_id,hasSessionId:!!m.session_id,isNew:!m.message_count||0===m.message_count}),!m.session_id)throw d.v.error("MESSAGES","Conversation missing session_id",{conversation:m}),new Error("Conversation missing session_id");e({loading:!0,error:null});const p={id:(0,c.$C)(),role:"user",content:s,timestamp:(new Date).toISOString(),status:"sending"};t().addMessage(m.id.toString(),p);const f={id:(0,c.$C)(),role:"assistant",content:"",timestamp:(new Date).toISOString(),citations:[]};e({streamingMessage:f,isStreaming:!0,loading:!1});try{let r=[];if(a&&a.length>0){const e=(0,n.getClient)();r=(await Promise.all(a.map(t=>e.uploadFile(g.id,t)))).filter(e=>e?.data?.id).map(e=>e.data.id.toString()),d.v.info("MESSAGES","Files uploaded successfully",{fileCount:a.length,sourceIds:r})}p.status="sent",t().addMessage(m.id.toString(),p);const i=(0,n.getClient)();d.v.info("MESSAGES","Starting message stream",{agentId:g.id,sessionId:m.session_id,messageContent:s.substring(0,50),hasSourceIds:r.length>0,sourceIds:r});try{const a={prompt:s||"",response_source:o.w.getState().getSettings(g.id).response_source||"default"};r.length>0&&(a.source_ids=r,s.trim()||(a.prompt="Please analyze the uploaded file(s).")),await i.sendMessageStream(g.id,m.session_id,a,s=>{if(d.v.info("MESSAGES","Received stream chunk",{type:s.type,hasContent:!!s.content,contentLength:s.content?.length,contentPreview:s.content?.substring(0,50)}),"content"===s.type&&s.content)t().updateStreamingMessage(s.content,s.citations);else if("citation"===s.type&&s.citations){const a=t().streamingMessage;a&&s.citations&&Array.isArray(s.citations)&&(s.citations.length>0&&"number"==typeof s.citations[0]?h(s.citations,g.id).then(s=>{const a=t().streamingMessage;a&&e({streamingMessage:{...a,citations:s}})}):e({streamingMessage:{...a,citations:s.citations}}))}},async s=>{d.v.error("MESSAGES","Streaming failed, attempting fallback to non-streaming",s,{errorMessage:s.message,agentId:g.id,sessionId:m.session_id});try{d.v.info("MESSAGES","Using non-streaming fallback");const s=await i.sendMessage(g.id,m.session_id,{prompt:a.prompt,stream:!1,source_ids:a.source_ids}),n=t().streamingMessage;if(n&&s){let e;if(e=s.data?s.data:s,n.content=e?.openai_response||e?.content||"No response received",e?.citations&&Array.isArray(e.citations)&&e.citations.length>0?"number"==typeof e.citations[0]?n.citations=await h(e.citations,g.id):n.citations=e.citations:n.citations=[],n.status="sent",e?.id){n.id=`${e.id}-assistant`;const s=(t().messages.get(m.id.toString())||[]).filter(e=>"user"===e.role).pop();s&&s.id===p.id&&(s.id=`${e.id}-user`,t().addMessage(m.id.toString(),s))}n.details={user_id:e?.user_id,conversation_id:e?.conversation_id,updated_at:e?.updated_at,prompt_id:e?.id,metadata:e?.metadata?{user_ip:e.metadata.user_ip,user_agent:e.metadata.user_agent,external_id:e.metadata.external_id,request_source:e.metadata.request_source}:void 0},t().addMessage(m.id.toString(),n)}e({streamingMessage:null,isStreaming:!1}),d.v.info("MESSAGES","Fallback to non-streaming successful")}catch(s){d.v.error("MESSAGES","Both streaming and non-streaming failed",s);const a=t().streamingMessage;a&&(a.content="Sorry, I encountered an error while processing your message. Please try again.",a.status="error",t().addMessage(m.id.toString(),a));let n="Communication error";if(s.status)switch(s.status){case 429:n="You have exhausted your current query credits. Please contact customer service for assistance.";break;case 401:n="API Token is either missing or invalid";break;case 404:n="Agent or conversation not found";break;case 400:n="Invalid request format";break;default:n=s.message||`Error ${s.status}`}else s.message&&(n=s.message);e({streamingMessage:null,isStreaming:!1,error:n})}},async()=>{const s=t().streamingMessage;if(s){s.status="sent",e({streamingMessage:null,isStreaming:!1}),t().addMessage(m.id.toString(),s);try{d.v.info("MESSAGES","Enriching streaming message with API data");const e=(0,n.getClient)(),a=await e.getMessages(g.id,m.session_id);let r=[];if(a&&"object"==typeof a&&(a.data&&a.data.messages&&Array.isArray(a.data.messages.data)?r=a.data.messages.data:Array.isArray(a.data)?r=a.data:Array.isArray(a)?r=a:a.data&&Array.isArray(a.data.data)&&(r=a.data.data)),r.length>0){const e=r[r.length-1];if(e&&e.openai_response){s.id=`${e.id}-assistant`,s.timestamp=e.created_at||e.timestamp||s.timestamp,s.details={user_id:e.user_id,conversation_id:e.conversation_id,updated_at:e.updated_at,prompt_id:e.id,metadata:e.metadata?{user_ip:e.metadata.user_ip,user_agent:e.metadata.user_agent,external_id:e.metadata.external_id,request_source:e.metadata.request_source}:void 0};const a=(t().messages.get(m.id.toString())||[]).filter(e=>"user"===e.role).pop();a&&a.id===p.id&&e.user_query&&(a.id=`${e.id}-user`,a.timestamp=e.created_at||e.timestamp||a.timestamp,a.details={user_id:e.user_id,conversation_id:e.conversation_id,updated_at:e.updated_at,prompt_id:e.id,metadata:e.metadata?{user_ip:e.metadata.user_ip,user_agent:e.metadata.user_agent,external_id:e.metadata.external_id,request_source:e.metadata.request_source}:void 0},t().addMessage(m.id.toString(),a));const n=s.citations||[];if(e.citations&&Array.isArray(e.citations)&&e.citations.length>0)if("number"==typeof e.citations[0]){const t=await h(e.citations,g.id);s.citations=t}else s.citations=e.citations;else s.citations=n;e.response_feedback?.reaction&&(s.feedback="liked"===e.response_feedback.reaction?"like":"disliked"===e.response_feedback.reaction?"dislike":void 0),t().addMessage(m.id.toString(),s),d.v.info("MESSAGES","Successfully enriched streaming message with API data",{messageId:s.id,hasDetails:!!s.details,citationCount:s.citations?.length||0})}else d.v.info("MESSAGES","API message format mismatch, keeping original message")}else d.v.info("MESSAGES","No API messages found for enrichment")}catch(e){d.v.warn("MESSAGES","Failed to enrich streaming message, keeping basic version",e)}}})}catch(e){throw d.v.error("MESSAGES","Failed to setup streaming",e),e}}catch(s){d.v.error("MESSAGES","Failed to send message",s,{errorType:s instanceof Error?s.constructor.name:typeof s,errorMessage:s instanceof Error?s.message:String(s),stack:s instanceof Error?s.stack:void 0,status:s.status,agentId:g.id,conversationId:m.id,sessionId:m.session_id}),p.status="error",t().addMessage(m.id.toString(),p);let a="Failed to send message";if(s.status)switch(s.status){case 429:a="You have exhausted your current query credits. Please contact customer service for assistance.";break;case 401:a="API Token is either missing or invalid";break;case 403:const e=r.o.getState(),{currentAgent:t}=e;a=t&&!t.is_chat_active?"Agent is inactive - no documents uploaded. Please add documents to activate the agent.":"Access denied. You don't have permission to access this resource.";break;case 404:a="Agent or conversation not found";break;case 400:a="Invalid request format";break;case 500:a="Internal server error. Please try again later.";break;default:a=s.message||`Error ${s.status}`}else s.message&&(a=s.message);throw e({streamingMessage:null,isStreaming:!1,error:a,loading:!1}),s}},addMessage:(t,s)=>{e(e=>{const a=new Map(e.messages),n=a.get(t)||[],r=n.findIndex(e=>e.id===s.id);return r>=0?n[r]=s:n.push(s),a.set(t,n),m(t,n),{messages:a}})},updateStreamingMessage:(t,s)=>{e(e=>e.streamingMessage?{streamingMessage:{...e.streamingMessage,content:e.streamingMessage.content+t,citations:s||e.streamingMessage.citations}}:e)},clearMessages:t=>{e(e=>{if(t){const s=new Map(e.messages);return s.delete(t),{messages:s}}return{messages:new Map}})},updateMessageFeedback:async(e,s)=>{const a=r.o.getState(),o=i.w.getState(),{currentAgent:c}=a,{currentConversation:l}=o;if(!c||!l)return void d.v.warn("MESSAGES","Cannot update feedback - missing agent or conversation");const g=(t().messages.get(l.id.toString())||[]).find(t=>t.id===e);if(!g)return void d.v.warn("MESSAGES","Message not found for feedback update",{messageId:e});let m;if(g.details?.prompt_id)m=g.details.prompt_id;else{const e=g.id.match(/^(\d+)-/);e&&(m=parseInt(e[1]))}if(!m)return d.v.error("MESSAGES","Could not determine prompt ID for message",{messageId:e,details:g.details}),void u.toast.error("Unable to update feedback. Message ID not found.");const h=l.session_id;if(h)try{const e={...g,feedback:s};t().addMessage(l.id.toString(),e);const a=(0,n.getClient)(),r="like"===s?"thumbs_up":"thumbs_down";d.v.info("MESSAGES","Updating message feedback",{projectId:c.id,sessionId:h,promptId:m,feedback:r});await a.updateMessageFeedback(c.id,h,m,{feedback:r});d.v.info("MESSAGES","Message feedback updated successfully"),u.toast.success("Thanks for your feedback!")}catch(e){d.v.error("MESSAGES","Failed to update message feedback",e),t().addMessage(l.id.toString(),g),401===e?.status?u.toast.error("Authentication failed. Please log in again."):404===e?.status?u.toast.error("Message not found."):u.toast.error("Failed to update feedback. Please try again.")}else d.v.error("MESSAGES","Conversation missing session_id",{conversationId:l.id})},getMessagesForConversation:e=>t().messages.get(e)||[],cancelStreaming:()=>{l.Hr.cancelAllStreams(),e({streamingMessage:null,isStreaming:!1})},loadMessages:async t=>{if("undefined"!=typeof window&&window.__customgpt_demo_mode)return d.v.info("MESSAGES","Skipping message load in demo mode",{conversationId:t}),void e(e=>{const s=new Map(e.messages);return s.has(t)||s.set(t,[]),{messages:s,loading:!1}});if(t.startsWith("conv_"))return d.v.info("MESSAGES","Skipping API load for local conversation",{conversationId:t}),void e(e=>{const s=new Map(e.messages);return s.has(t)||s.set(t,[]),{messages:s,loading:!1}});const s=r.o.getState(),a=i.w.getState(),{currentAgent:o}=s,{conversations:c}=a;if(!o)return void d.v.warn("MESSAGES","No current agent when loading messages",{conversationId:t});const l=c.find(e=>e.id.toString()===t);if(!l)return d.v.error("MESSAGES","Conversation not found in store",{conversationId:t,availableConversations:c.map(e=>e.id)}),void e(e=>{const s=new Map(e.messages);return s.has(t)||s.set(t,[]),{messages:s,loading:!1}});d.v.info("MESSAGES","Loading messages for conversation",{conversationId:t,sessionId:l.session_id,agentId:o.id,agentName:o.project_name}),e({loading:!0,error:null});try{const s=(0,n.getClient)(),a=await s.getMessages(o.id,l.session_id);d.v.info("MESSAGES","Messages API response received",{conversationId:t,responseType:typeof a,hasData:!!a?.data,dataLength:Array.isArray(a?.data)?a.data.length:0});let r=[];a&&"object"==typeof a&&(a.data&&a.data.messages&&Array.isArray(a.data.messages.data)?r=a.data.messages.data:Array.isArray(a.data)?r=a.data:Array.isArray(a)?r=a:a.data&&Array.isArray(a.data.data)&&(r=a.data.data)),d.v.info("MESSAGES","Processing messages",{conversationId:t,messagesCount:r.length,messageTypes:r.map(e=>e.role||"unknown")});const i=[];if(Array.isArray(r))for(const e of r){const t=e.created_at||e.timestamp||(new Date).toISOString();if(e.user_query&&i.push({id:`${e.id}-user`||`user-${Math.random()}`,role:"user",content:e.user_query,timestamp:t,status:"sent",details:{user_id:e.user_id,conversation_id:e.conversation_id,updated_at:e.updated_at,prompt_id:e.id,metadata:e.metadata?{user_ip:e.metadata.user_ip,user_agent:e.metadata.user_agent,external_id:e.metadata.external_id,request_source:e.metadata.request_source}:void 0}}),e.openai_response){let s=[];e.citations&&Array.isArray(e.citations)&&e.citations.length>0&&(s="number"==typeof e.citations[0]?await h(e.citations,o.id):e.citations),i.push({id:`${e.id}-assistant`||`assistant-${Math.random()}`,role:"assistant",content:e.openai_response,citations:s,timestamp:t,status:"sent",feedback:"liked"===e.response_feedback?.reaction?"like":"disliked"===e.response_feedback?.reaction?"dislike":void 0,details:{user_id:e.user_id,conversation_id:e.conversation_id,updated_at:e.updated_at,prompt_id:e.id,metadata:e.metadata?{user_ip:e.metadata.user_ip,user_agent:e.metadata.user_agent,external_id:e.metadata.external_id,request_source:e.metadata.request_source}:void 0}})}}d.v.info("MESSAGES","Messages formatted successfully",{conversationId:t,formattedCount:i.length}),i.sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime()),d.v.info("MESSAGES","Messages sorted by timestamp",{conversationId:t,firstMessageTime:i[0]?.timestamp,lastMessageTime:i[i.length-1]?.timestamp}),e(e=>{const s=new Map(e.messages),a=(e.messages.get(t)||[]).filter(e=>"sending"===e.status||"user"===e.role&&new Date(e.timestamp).getTime()>Date.now()-5e3),n=[...i];for(const e of a)if(!n.find(t=>t.id===e.id)){const t=n.findIndex(t=>new Date(t.timestamp).getTime()>new Date(e.timestamp).getTime());-1===t?n.push(e):n.splice(t,0,e)}return s.set(t,n),m(t,n),{messages:s,loading:!1}})}catch(s){d.v.error("MESSAGES","Failed to load messages",s,{conversationId:t,agentId:o.id,errorType:s instanceof Error?s.constructor.name:typeof s,status:s?.status,message:s?.message});const a=function(e){try{const t=localStorage.getItem(g);return t&&JSON.parse(t)[e]||null}catch(e){return null}}(t);a&&a.length>0?(d.v.info("MESSAGES","Using cached messages as fallback",{conversationId:t,messageCount:a.length}),a.sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime()),e(e=>{const s=new Map(e.messages);return s.set(t,a),{messages:s,loading:!1,error:"Using cached messages (API unavailable)"}})):e({error:s instanceof Error?s.message:"Failed to load messages",loading:!1})}},clearError:()=>{e({error:null})},setMessagesForConversation:(t,s)=>{e(e=>{const a=new Map(e.messages);return a.set(t,s),{messages:a}})},regenerateLastResponse:async()=>{const e=r.o.getState(),s=i.w.getState(),{currentAgent:a}=e,{currentConversation:n}=s;if(!a||!n)return d.v.error("MESSAGES","Cannot regenerate - missing agent or conversation"),void u.toast.error("Cannot regenerate response. Please select a conversation.");const o=n.id.toString(),c=t().getMessagesForConversation(o);if(c.length<2)return d.v.warn("MESSAGES","Not enough messages to regenerate"),void u.toast.error("No response to regenerate.");let l=null,g=null,h=-1;for(let e=c.length-1;e>=0;e--){const t=c[e];if(g||"assistant"!==t.role||"error"===t.status||(g=t,h=e),!l&&"user"===t.role&&g){l=t;break}}if(!l||!g)return d.v.warn("MESSAGES","Could not find valid user/assistant message pair to regenerate"),void u.toast.error("No valid response to regenerate.");d.v.info("MESSAGES","Regenerating response",{conversationId:o,userMessageId:l.id,assistantMessageId:g.id,userContent:l.content.substring(0,50)});const p=[...c];p.splice(h,1),t().setMessagesForConversation(o,p),m(o,p);try{await t().sendMessage(l.content),d.v.info("MESSAGES","Response regenerated successfully")}catch(e){d.v.error("MESSAGES","Failed to regenerate response",e),t().setMessagesForConversation(o,c),m(o,c),u.toast.error("Failed to regenerate response. Please try again.")}}}))}},i={};function o(e){var t=i[e];if(void 0!==t)return t.exports;var s=i[e]={exports:{}};return r[e].call(s.exports,s,s.exports,o),s.exports}o.m=r,e=[],o.O=(t,s,a,n)=>{if(!s){var r=1/0;for(d=0;d<e.length;d++){for(var[s,a,n]=e[d],i=!0,c=0;c<s.length;c++)(!1&n||r>=n)&&Object.keys(o.O).every(e=>o.O[e](s[c]))?s.splice(c--,1):(i=!1,n<r&&(r=n));if(i){e.splice(d--,1);var l=a();void 0!==l&&(t=l)}}return t}n=n||0;for(var d=e.length;d>0&&e[d-1][2]>n;d--)e[d]=e[d-1];e[d]=[s,a,n]},o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},s=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,o.t=function(e,a){if(1&a&&(e=this(e)),8&a)return e;if("object"==typeof e&&e){if(4&a&&e.__esModule)return e;if(16&a&&"function"==typeof e.then)return e}var n=Object.create(null);o.r(n);var r={};t=t||[null,s({}),s([]),s(s)];for(var i=2&a&&e;("object"==typeof i||"function"==typeof i)&&!~t.indexOf(i);i=s(i))Object.getOwnPropertyNames(i).forEach(t=>r[t]=()=>e[t]);return r.default=()=>e,o.d(n,r),n},o.d=(e,t)=>{for(var s in t)o.o(t,s)&&!o.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce((t,s)=>(o.f[s](e,t),t),[])),o.u=e=>e+"."+{135:"300cf3128c7b3899f41e",139:"b5b36620976f04410283",236:"f4f1e2e8242e227a0fbf",258:"088a5955ad60da7b0eac",352:"932975b3c3dcb3907cb8",365:"f366977150fc0db74e96",404:"d6cb89542ef4f6025d04",482:"61ff49824d046d57452e",613:"3f83b3c90df78f917118",638:"e1c53d34514d703a4e96",964:"7561879d4b6c10001d9e"}[e]+".chunk.js",o.miniCssF=e=>{},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a={},n="CustomGPTWidget:",o.l=(e,t,s,r)=>{if(a[e])a[e].push(t);else{var i,c;if(void 0!==s)for(var l=document.getElementsByTagName("script"),d=0;d<l.length;d++){var u=l[d];if(u.getAttribute("src")==e||u.getAttribute("data-webpack")==n+s){i=u;break}}i||(c=!0,(i=document.createElement("script")).charset="utf-8",i.timeout=120,o.nc&&i.setAttribute("nonce",o.nc),i.setAttribute("data-webpack",n+s),i.src=e),a[e]=[t];var g=(t,s)=>{i.onerror=i.onload=null,clearTimeout(m);var n=a[e];if(delete a[e],i.parentNode&&i.parentNode.removeChild(i),n&&n.forEach(e=>e(s)),t)return t(s)},m=setTimeout(g.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=g.bind(null,i.onerror),i.onload=g.bind(null,i.onload),c&&document.head.appendChild(i)}},o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.p="/",(()=>{var e={30:0};o.f.j=(t,s)=>{var a=o.o(e,t)?e[t]:void 0;if(0!==a)if(a)s.push(a[2]);else{var n=new Promise((s,n)=>a=e[t]=[s,n]);s.push(a[2]=n);var r=o.p+o.u(t),i=new Error;o.l(r,s=>{if(o.o(e,t)&&(0!==(a=e[t])&&(e[t]=void 0),a)){var n=s&&("load"===s.type?"missing":s.type),r=s&&s.target&&s.target.src;i.message="Loading chunk "+t+" failed.\n("+n+": "+r+")",i.name="ChunkLoadError",i.type=n,i.request=r,a[1](i)}},"chunk-"+t,t)}},o.O.j=t=>0===e[t];var t=(t,s)=>{var a,n,[r,i,c]=s,l=0;if(r.some(t=>0!==e[t])){for(a in i)o.o(i,a)&&(o.m[a]=i[a]);if(c)var d=c(o)}for(t&&t(s);l<r.length;l++)n=r[l],o.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return o.O(d)},s=Object("undefined"!=typeof self?self:this).webpackChunkCustomGPTWidget=Object("undefined"!=typeof self?self:this).webpackChunkCustomGPTWidget||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})(),o.nc=void 0;var c=o.O(void 0,[96],()=>o(72781));return c=(c=o.O(c)).default})());
//# sourceMappingURL=customgpt-widget.js.map